# ç¼–è¾‘å™¨é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› å‘ç°çš„é—®é¢˜

### 1. **è½®è¯¢é€»è¾‘é”™è¯¯** âŒ

- è½®è¯¢æ—¶æ²¡æœ‰æ£€æŸ¥ `editorInstance` æ˜¯å¦ä¸º null
- å¯¼è‡´ `Cannot read properties of null (reading 'getHTML')` é”™è¯¯

### 2. **Yjs é‡å¤å¯¼å…¥** âŒ

- è­¦å‘Šï¼š`Yjs was already imported`
- å¯èƒ½å¯¼è‡´åä½œåŠŸèƒ½å¼‚å¸¸

### 3. **å †æ ˆæº¢å‡º** âŒ

- `RangeError: Maximum call stack size exceeded`
- å‘ç”Ÿåœ¨ `SelectionBridge2.findFocusNode` ä¸­
- æ— é™é€’å½’å¯¼è‡´æµè§ˆå™¨å´©æºƒ

### 4. **å·¥å…·æ ä¸å¯è§** âŒ

- ç”¨æˆ·çœ‹ä¸åˆ°ç¼–è¾‘å™¨çš„å·¥å…·æ 
- æ— æ³•è¿›è¡Œæ ¼å¼åŒ–æ“ä½œ

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. **è½®è¯¢é€»è¾‘ä¿®å¤**

```typescript
// ä¿®å¤å‰ï¼šç›´æ¥è°ƒç”¨ getHTML()ï¼Œæ²¡æœ‰æ£€æŸ¥
const currentContent = editorInstance.getHTML() || ''

// ä¿®å¤åï¼šæ·»åŠ  null æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
if (!editorInstance || typeof editorInstance.getHTML !== 'function') {
  console.warn('âš ï¸ [TextBus] ç¼–è¾‘å™¨å®ä¾‹æ— æ•ˆï¼Œåœæ­¢è½®è¯¢')
  clearInterval(pollInterval)
  return
}

try {
  const currentContent = editorInstance.getHTML() || ''
  // ...
} catch (e) {
  console.warn('âš ï¸ [TextBus] è½®è¯¢è·å–å†…å®¹å¤±è´¥:', e)
  clearInterval(pollInterval)
}
```

### 2. **æ¸…ç†å®šæ—¶å™¨**

```typescript
// åœ¨ç»„ä»¶é”€æ¯æ—¶æ¸…ç†è½®è¯¢å®šæ—¶å™¨
onBeforeUnmount(() => {
  // æ¸…ç†è½®è¯¢å®šæ—¶å™¨
  if (editorInstance && (editorInstance as any)._pollInterval) {
    clearInterval((editorInstance as any)._pollInterval)
    ;(editorInstance as any)._pollInterval = null
  }

  // é”€æ¯ç¼–è¾‘å™¨
  if (editorInstance) {
    try {
      editorInstance.destroy()
    } catch (error) {
      console.error('é”€æ¯ç¼–è¾‘å™¨å¤±è´¥:', error)
    }
    editorInstance = null
  }
})
```

### 3. **æš‚æ—¶ç¦ç”¨åä½œåŠŸèƒ½**

ä¸ºäº†é¿å… Yjs é‡å¤å¯¼å…¥å’Œå †æ ˆæº¢å‡ºé—®é¢˜ï¼Œæš‚æ—¶ç¦ç”¨äº†åä½œåŠŸèƒ½ï¼š

```typescript
// æš‚æ—¶ç¦ç”¨åä½œåŠŸèƒ½ï¼Œé¿å… Yjs é‡å¤å¯¼å…¥é—®é¢˜
// TODO: ä¿®å¤ Yjs é‡å¤å¯¼å…¥é—®é¢˜åå†å¯ç”¨
// if (props.collaborationUrl && props.currentUser?.id) {
//   editorConfig.collaborateConfig = { ... }
// }
```

### 4. **æ·»åŠ  key å±æ€§**

ç¡®ä¿ç¼–è¾‘å™¨åœ¨ç¼–è¾‘çŠ¶æ€åˆ‡æ¢æ—¶æ­£ç¡®é‡æ–°åˆ›å»ºï¼š

```vue
<ArtTextbusEditor :key="`editor-${documentId}-${isEditing ? 'edit' : 'view'}`" ... />
```

### 5. **ç¡®ä¿åˆå§‹å†…å®¹**

```typescript
const editorConfig: any = {
  readonly: false,
  content: props.modelValue || '<p></p>', // ç¡®ä¿æœ‰åˆå§‹å†…å®¹
  providers: [...]
}
```

## ğŸ¯ ç°åœ¨å¯ä»¥æµ‹è¯•çš„åŠŸèƒ½

### åŸºç¡€ç¼–è¾‘åŠŸèƒ½ âœ…

1. **æ–‡æœ¬è¾“å…¥**

   - å¯ä»¥æ­£å¸¸è¾“å…¥æ–‡æœ¬
   - å¯ä»¥åˆ é™¤æ–‡æœ¬
   - å¯ä»¥å¤åˆ¶ç²˜è´´

2. **æ–‡æœ¬æ ¼å¼åŒ–**ï¼ˆé€šè¿‡å†…è”å·¥å…·æ ï¼‰

   - é€‰ä¸­æ–‡æœ¬åä¼šå¼¹å‡ºå·¥å…·æ 
   - ç²—ä½“ã€æ–œä½“ã€ä¸‹åˆ’çº¿ç­‰

3. **å·¥å…·æ æ˜¾ç¤º**
   - å·¦ä¾§å·¥å…·æ åº”è¯¥å¯è§
   - åŒ…å«æ‰€æœ‰ç¼–è¾‘å·¥å…·

## ğŸ”§ å¦‚ä½•æµ‹è¯•

### æ­¥éª¤ 1: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

```
æŒ‰ Ctrl+Shift+Deleteï¼ˆæˆ– Cmd+Shift+Deleteï¼‰
æ¸…é™¤ç¼“å­˜
åˆ·æ–°é¡µé¢
```

### æ­¥éª¤ 2: è¿›å…¥ç¼–è¾‘æ¨¡å¼

1. è®¿é—®åä½œæ–‡æ¡£é¡µé¢
2. ç‚¹å‡»"å¼€å§‹ç¼–è¾‘"æŒ‰é’®
3. ç­‰å¾…ç¼–è¾‘å™¨åˆå§‹åŒ–

### æ­¥éª¤ 3: æŸ¥çœ‹å·¥å…·æ 

- **å·¦ä¾§å·¥å…·æ **ï¼šåº”è¯¥åœ¨ç¼–è¾‘å™¨å·¦ä¾§å¯è§
- **å†…è”å·¥å…·æ **ï¼šé€‰ä¸­æ–‡æœ¬æ—¶åº”è¯¥å¼¹å‡º

### æ­¥éª¤ 4: æµ‹è¯•ç¼–è¾‘åŠŸèƒ½

1. è¾“å…¥ä¸€äº›æ–‡æœ¬
2. é€‰ä¸­æ–‡æœ¬
3. ä½¿ç”¨å·¥å…·æ è¿›è¡Œæ ¼å¼åŒ–
4. æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
5. æµ‹è¯•è¡¨æ ¼æ’å…¥

## ğŸ“Š æ§åˆ¶å°æ—¥å¿—

ä¿®å¤åï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
âœ… [TextBus] ç¼–è¾‘å™¨å®ä¾‹å·²åˆ›å»º
ğŸ“ [TextBus] ç¼–è¾‘å™¨é…ç½®: { hasContent: true, contentLength: 7, hasCollaboration: false }
âœ… [TextBus] å†…å®¹å˜åŒ–ç›‘å¬å·²è®¾ç½®
```

**ä¸åº”è¯¥**å†çœ‹åˆ°ï¼š

```
âŒ Uncaught TypeError: Cannot read properties of null (reading 'getHTML')
âŒ Uncaught RangeError: Maximum call stack size exceeded
```

## ğŸš§ å¾…ä¿®å¤çš„é—®é¢˜

### 1. åä½œåŠŸèƒ½è¢«ç¦ç”¨

**åŸå› **ï¼šYjs é‡å¤å¯¼å…¥å¯¼è‡´å†²çª

**è§£å†³æ–¹æ¡ˆ**ï¼š

- æ–¹æ¡ˆ Aï¼šç¡®ä¿ Yjs åªåœ¨ä¸€ä¸ªåœ°æ–¹å¯¼å…¥
- æ–¹æ¡ˆ Bï¼šä½¿ç”¨å¤–éƒ¨ Yjs å®ä¾‹
- æ–¹æ¡ˆ Cï¼šå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬çš„ @textbus/collaborate

### 2. å·¥å…·æ æ ·å¼å¯èƒ½éœ€è¦è°ƒæ•´

å¦‚æœå·¥å…·æ ä»ç„¶ä¸å¯è§æˆ–æ˜¾ç¤ºä¸æ­£å¸¸ï¼š

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼š

```scss
// å¢åŠ  z-index
.textbus-editor-container .textbus-left-toolbar {
  z-index: 1000 !important;
  position: relative !important;
}

// ç¡®ä¿å®¹å™¨å¯è§
.textbus-editor-wrapper {
  overflow: visible !important;
}
```

## ğŸ“ ä¸‹ä¸€æ­¥è®¡åˆ’

### é˜¶æ®µ 1: ç¨³å®šåŸºç¡€åŠŸèƒ½ âœ…

- [x] ä¿®å¤è½®è¯¢é€»è¾‘é”™è¯¯
- [x] ä¿®å¤å®šæ—¶å™¨æ¸…ç†
- [x] ç¡®ä¿ç¼–è¾‘å™¨èƒ½æ­£å¸¸æ˜¾ç¤º
- [x] ç¡®ä¿åŸºç¡€ç¼–è¾‘åŠŸèƒ½å¯ç”¨

### é˜¶æ®µ 2: ä¿®å¤åä½œåŠŸèƒ½ ğŸ”„

- [ ] è§£å†³ Yjs é‡å¤å¯¼å…¥é—®é¢˜
- [ ] é…ç½® WebSocket æœåŠ¡å™¨
- [ ] æµ‹è¯•å¤šäººåä½œ
- [ ] æ·»åŠ å…‰æ ‡åŒæ­¥

### é˜¶æ®µ 3: ä¼˜åŒ–ä½“éªŒ ğŸ“ˆ

- [ ] ä¼˜åŒ–å·¥å…·æ æ ·å¼
- [ ] æ·»åŠ å¿«æ·é”®æç¤º
- [ ] æ·»åŠ è‡ªåŠ¨ä¿å­˜æŒ‡ç¤ºå™¨
- [ ] ä¼˜åŒ–åŠ è½½åŠ¨ç”»

## ğŸ” å¦‚æœè¿˜æœ‰é—®é¢˜

### 1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·

```
æŒ‰ F12 æˆ– Ctrl+Shift+I
```

### 2. æŸ¥çœ‹ Console æ ‡ç­¾

- æŸ¥æ‰¾çº¢è‰²çš„é”™è¯¯ä¿¡æ¯
- å¤åˆ¶å®Œæ•´çš„é”™è¯¯å †æ ˆ

### 3. æ£€æŸ¥ Network æ ‡ç­¾

- ç¡®è®¤ XNote ç›¸å…³çš„ JS æ–‡ä»¶æ˜¯å¦åŠ è½½æˆåŠŸ
- æ£€æŸ¥æ˜¯å¦æœ‰ 404 é”™è¯¯

### 4. æŸ¥çœ‹ Elements æ ‡ç­¾

- æœç´¢ `textbus-left-toolbar`
- æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥å…ƒç´ çš„æ ·å¼ï¼ˆdisplayã€visibilityã€opacityï¼‰

## ğŸ’¡ è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ç¼–è¾‘å™¨å®ä¾‹

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å…¥
window.editorInstance = editorRef.value?.getEditor()
console.log(window.editorInstance)
```

### æŸ¥çœ‹å®¹å™¨å°ºå¯¸

```javascript
const container = document.querySelector('.textbus-editor-container')
console.log({
  width: container.offsetWidth,
  height: container.offsetHeight,
  display: window.getComputedStyle(container).display,
  visibility: window.getComputedStyle(container).visibility
})
```

### æŸ¥çœ‹å·¥å…·æ 

```javascript
const toolbar = document.querySelector('.textbus-left-toolbar')
console.log({
  exists: !!toolbar,
  display: toolbar ? window.getComputedStyle(toolbar).display : 'N/A',
  position: toolbar ? window.getComputedStyle(toolbar).position : 'N/A',
  zIndex: toolbar ? window.getComputedStyle(toolbar).zIndex : 'N/A'
})
```

## ğŸ‰ æ€»ç»“

- âœ… ä¿®å¤äº†å¯¼è‡´æµè§ˆå™¨å´©æºƒçš„ä¸¥é‡é”™è¯¯
- âœ… ç¼–è¾‘å™¨ç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸åŠ è½½
- âœ… åŸºç¡€ç¼–è¾‘åŠŸèƒ½åº”è¯¥å¯ç”¨
- â³ åä½œåŠŸèƒ½æš‚æ—¶ç¦ç”¨ï¼Œç­‰å¾…åç»­ä¿®å¤

è¯·åˆ·æ–°é¡µé¢å¹¶é‡æ–°æµ‹è¯•ï¼å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯ä¿¡æ¯
2. æˆªå›¾æ˜¾ç¤ºå½“å‰çš„ç•Œé¢çŠ¶æ€
3. ç¼–è¾‘å™¨å®¹å™¨çš„ HTML ç»“æ„ï¼ˆä» Elements æ ‡ç­¾ï¼‰
