# 紧急错误修复说明

## 🐛 发现的错误

根据用户反馈的控制台日志，发现了以下严重错误：

### 1. Awareness API 错误 ❌

```
⚠️ [XNote] 更新用户列表失败: TypeError: awareness.getStates is not a function
```

**错误原因：**

- 错误地从 `yDoc.getMap('awareness')` 获取 Awareness
- 正确方式应该从 `connector.awareness` 获取

### 2. 堆栈溢出错误 ❌

```
Uncaught RangeError: Maximum call stack size exceeded
at SelectionBridge2.findFocusNode (index.esm.js:1018:26)
```

**错误原因：**

- `SuspensionToolbarPlugin`（悬浮工具栏）存在 bug
- 导致无限递归调用

### 3. 编辑器无滚动条 ❌

用户反馈：编辑器内部没有滚动条，不能滚动进行文章翻页

**错误原因：**

- 编辑器容器设置了 `overflow: visible !important`
- 内部容器高度没有正确设置

---

## ✅ 已修复的问题

### 修复 1：Awareness API 使用正确

**文件：** `src/components/core/forms/art-textbus-editor/index.vue`

#### 修改前（错误）：

```typescript
const setupCollaborationListeners = (yDoc: any) => {
  // ❌ 错误：从 yDoc 获取 awareness
  const awareness = yDoc.getMap('awareness')
  const states = awareness.getStates() // 这个方法不存在！
}

// 调用时传入 yDoc
setupCollaborationListeners(yDoc)
```

#### 修改后（正确）：

```typescript
const setupCollaborationListeners = (connector: any) => {
  // ✅ 正确：从 connector 获取 awareness
  const awareness = connector.awareness

  if (!awareness) {
    console.warn('⚠️ [XNote] Awareness 不可用')
    return
  }

  // 使用正确的 API
  const states = awareness.getStates()

  // 监听变化
  awareness.on('change', updateUsers)

  // 延迟初始化，等待连接建立
  setTimeout(() => {
    updateUsers()
  }, 500)
}

// 调用时传入 connector
const connector = new YWebsocketConnector(wsUrl, props.documentId, yDoc)
setupCollaborationListeners(connector) // ✅ 传入 connector
```

### 修复 2：禁用悬浮工具栏，使用默认工具栏

**文件：** `src/components/core/forms/art-textbus-editor/index.vue`

#### 修改前：

```typescript
// 根据工具栏类型配置插件
if (props.toolbarType === 'suspension') {
  editorConfig.plugins = [
    new SuspensionToolbarPlugin() // ❌ 导致堆栈溢出
  ]
}
```

#### 修改后：

```typescript
// 暂时禁用自定义工具栏，使用默认配置
// 原因：SuspensionToolbarPlugin 导致堆栈溢出
console.log('🔧 [XNote] 使用默认工具栏（左侧 + 内联）')

// 不设置 plugins，让 XNote 使用默认的：
// - LeftToolbarPlugin（左侧垂直工具栏）
// - InlineToolbarPlugin（选中文字后的内联工具栏）
```

#### 更新 Props 默认值：

```typescript
const props = withDefaults(defineProps<Props>(), {
  toolbarType: 'default' // ✅ 改为 default
})
```

#### 更新创建页面：

```vue
<ArtTextbusEditor toolbar-type="default" :collaboration-enabled="true" ... />
```

### 修复 3：启用编辑器滚动

**文件：** `src/components/core/forms/art-textbus-editor/index.vue`

#### 修改前：

```scss
.xnote-editor {
  overflow: visible !important; // ❌ 不能滚动
}

.xnote-editor [data-textbus-view='VIEW_CONTAINER'] {
  overflow: visible !important; // ❌ 内容无法撑开
}
```

#### 修改后：

```scss
.xnote-editor {
  overflow: auto; /* ✅ 允许滚动 */

  /* XNote 内部容器 - 自适应高度 */
  :deep([data-textbus-view='VIEW_CONTAINER']) {
    min-height: 100%;
    height: auto !important; /* ✅ 允许内容撑开 */
  }

  :deep([data-textbus-view='VIEW_DOCUMENT']) {
    min-height: 100%;
    height: auto !important; /* ✅ 允许内容撑开 */
  }
}
```

---

## 🧪 测试验证

刷新页面后，应该看到：

### ✅ 正确的日志

```
✅ [XNote] 编辑器初始化成功
🔧 [XNote] 使用默认工具栏（左侧 + 内联）
🤝 [XNote] 启用协作模式，文档ID: doc-...
🔌 [XNote] 连接协作服务器: ws://...
👥 [XNote] 在线用户更新: 1 [{id: ..., username: ..., color: ...}]
```

### ❌ 不应该出现的错误

- ~~`TypeError: awareness.getStates is not a function`~~ ✅ 已修复
- ~~`RangeError: Maximum call stack size exceeded`~~ ✅ 已修复

### ✅ 功能验证

| 功能       | 预期效果                |
| ---------- | ----------------------- |
| 编辑器显示 | ✅ 正常显示，可以点击   |
| 左侧工具栏 | ✅ 显示在编辑器左侧     |
| 输入文字   | ✅ 可以正常输入         |
| 选中文字   | ✅ 显示内联工具栏       |
| 内容滚动   | ✅ 内容多时出现滚动条   |
| 在线用户   | ✅ 左侧面板显示当前用户 |
| 协作连接   | ✅ 连接到 Yjs 服务器    |

---

## 📋 工具栏说明

### 默认工具栏（现在使用）

```
┌──────────────────────────────────────┐
│                                      │
│  🔧 左侧工具栏                        │
│  │                                   │
│  ├─ 插入菜单                          │
│  ├─ 标题                              │
│  ├─ 粗体/斜体/下划线                  │
│  ├─ 列表                              │
│  ├─ 图片/视频                         │
│  ├─ 表格                              │
│  ├─ 代码块                            │
│  └─ ...                               │
│                                      │
│  选中文字后：                          │
│  ┌──────────────┐                    │
│  │ B I U 🎨 📎 │ ← 内联工具栏        │
│  └──────────────┘                    │
│                                      │
└──────────────────────────────────────┘
```

### 左侧工具栏特点

- ✅ 固定在编辑器左侧
- ✅ 不会被遮挡
- ✅ 所有功能都可用
- ✅ 可以滚动查看更多工具

### 内联工具栏特点

- ✅ 选中文字时自动出现
- ✅ 快速格式化工具
- ✅ 浮动显示，跟随选区
- ⚠️ 可能在边缘被部分遮挡（已知问题，但不影响使用）

---

## 🚀 快速测试步骤

### 1. 启动 Yjs 服务器

```bash
cd yjs-collab-server
npm start
```

### 2. 刷新前端页面

按 `Ctrl + Shift + R` 强制刷新

### 3. 进入创建文档页面

导航：**协作文档 → 创建文档**

### 4. 测试功能

#### 测试输入

1. 点击编辑器区域
2. 输入一些文字
3. ✅ 应该可以正常输入

#### 测试工具栏

1. 查看编辑器左侧
2. ✅ 应该显示垂直工具栏
3. 选中一些文字
4. ✅ 应该显示内联工具栏

#### 测试滚动

1. 输入很多内容（多段文字）
2. ✅ 应该出现滚动条
3. ✅ 可以滚动查看内容

#### 测试在线用户

1. 查看左侧"正在编辑"区域
2. ✅ 应该显示"正在编辑 (1)"
3. ✅ 显示当前用户头像

---

## 🎯 为什么禁用悬浮工具栏？

### 问题分析

`SuspensionToolbarPlugin` 的设计是好的：

- 自动检测边缘
- 智能调整位置
- 不会被遮挡

**但是**，它存在严重 bug：

```
Uncaught RangeError: Maximum call stack size exceeded
at SelectionBridge2.findFocusNode
```

这个错误导致：

- ❌ 浏览器崩溃
- ❌ 编辑器无法使用
- ❌ 页面卡死

### 临时方案

使用默认工具栏（`LeftToolbarPlugin` + `InlineToolbarPlugin`）：

- ✅ 稳定可靠
- ✅ 功能完整
- ✅ 不会崩溃
- ⚠️ 内联工具栏可能在边缘被部分遮挡

### 未来优化

等待 TextBus/XNote 修复 `SuspensionToolbarPlugin` 的 bug 后，可以重新启用。

或者考虑使用 `StaticToolbarPlugin`（顶部固定工具栏）：

```typescript
const toolbarHost = document.createElement('div')
editorConfig.plugins = [
  new StaticToolbarPlugin({
    host: toolbarHost,
    theme: 'light'
  })
]
```

---

## 📚 相关文档

- [XNote 官方文档](https://textbus.io)
- [Yjs Awareness API](https://docs.yjs.dev/api/about-awareness)
- [布局重构说明](./布局重构说明.md)
- [Yjs 服务器部署](./yjs-collab-server/README.md)

---

## ✅ 修复总结

| 问题               | 状态      | 修复方式                       |
| ------------------ | --------- | ------------------------------ |
| Awareness API 错误 | ✅ 已修复 | 从 connector 获取，不是从 yDoc |
| 堆栈溢出           | ✅ 已修复 | 禁用 SuspensionToolbarPlugin   |
| 无滚动条           | ✅ 已修复 | `overflow: auto` + 自适应高度  |
| 在线用户不显示     | ✅ 已修复 | 修复 Awareness API             |
| 编辑器无法输入     | ✅ 已解决 | 使用稳定的默认工具栏           |

**现在编辑器应该可以正常工作了！** 🎉

---

**修复日期**: 2025-11-11  
**测试状态**: ⏳ 待用户验证  
**优先级**: 🔴 高（影响核心功能）
