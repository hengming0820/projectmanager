# ✅ 协作功能已接入 - 测试指南

## 📋 修改内容

### 1. 按照官方文档接入协作

- ✅ 使用 `XNoteMessageBus` 获取协作用户列表（官方 API）
- ✅ 使用 `YWebsocketConnector` 连接协作服务器
- ✅ 配置 `collaborateConfig`
- ✅ 监听 `onMessageChange` 事件

### 2. 恢复协作用户显示

- ✅ 在左侧面板显示在线用户
- ✅ 显示用户头像、名称
- ✅ 实时更新用户列表
- ✅ 标记"我"标签

## 🚀 如何测试

### 步骤 1: 启动 Yjs 协作服务器

```powershell
# 进入 Yjs 服务器目录
cd yjs-collab-server

# 启动服务器
npm start

# 或使用快捷脚本
.\start.bat
```

**预期输出：**

```
WebSocket server running on ws://localhost:1234
```

### 步骤 2: 刷新前端页面

1. 刷新创建文档页面
2. 检查控制台日志：
   ```
   🤝 [XNote] 启用协作模式，文档ID: doc-xxx
   🔌 [XNote] 连接协作服务器: ws://localhost:3006/api/collaboration/yjs
   ✅ [XNote] 编辑器初始化成功
   ✅ [XNote] 协作监听器已设置
   👥 [XNote] 协作用户更新: 1 [{id: 'user1', username: 'admin', ...}]
   ```

### 步骤 3: 测试多人协作

#### 方式 1: 使用多个浏览器/标签页

1. 打开两个不同的浏览器（Chrome + Firefox）
2. 都登录到系统
3. 都打开"创建协作文档"页面
4. 观察左侧"正在编辑"列表是否显示 2 个用户

#### 方式 2: 使用隐身模式

1. 普通窗口：登录为 admin
2. 隐身窗口：登录为其他用户（如果有）
3. 同时打开创建文档页面
4. 观察用户列表

### 步骤 4: 测试实时协作

1. **用户 A** 在编辑器中输入文字："用户A的内容"
2. **用户 B** 应该能实时看到这些文字出现
3. 观察：
   - ✅ 内容实时同步
   - ✅ 能看到对方的光标位置
   - ✅ 能看到对方选中的文字
   - ✅ 左侧用户列表显示所有在线用户

## 📊 预期效果

### 左侧面板

```
┌─────────────────────────┐
│ 📊 文档统计              │
│ • 标题字数: 0 / 100     │
│ • 内容字数: 0           │
│ • 描述字数: 0 / 500     │
├─────────────────────────┤
│ 👥 正在编辑 [2]         │
│                         │
│ 🟢 admin (我)           │
│ 🔵 张三                 │
│                         │
└─────────────────────────┘
```

### 编辑器

- 顶部或左侧显示工具栏
- 可以正常编辑
- 能看到其他用户的光标（不同颜色）
- 内容实时同步

## ⚠️ 常见问题

### Q1: 看不到其他用户？

**检查：**

1. Yjs 服务器是否启动？
2. 浏览器控制台是否有连接错误？
3. 两个用户是否在同一个文档？（documentId 相同）

### Q2: 内容不同步？

**检查：**

1. WebSocket 连接是否成功？（查看控制台日志）
2. Vite 代理配置是否正确？（`vite.config.ts`）
3. 防火墙是否阻止 WebSocket 连接？

### Q3: 用户列表为空？

**检查：**

1. 控制台是否有错误：`XNoteMessageBus is not defined`
2. 编辑器是否成功初始化？
3. 是否启用了协作功能？（`:collaboration-enabled="true"`）

## 🔧 调试技巧

### 1. 查看 WebSocket 连接

```javascript
// 浏览器控制台
console.log('Collaboration Users:', collaborationUsers.value)
```

### 2. 查看协作日志

打开浏览器控制台，筛选日志：

- `[XNote]` - XNote 编辑器日志
- `👥` - 协作用户日志
- `🔌` - WebSocket 连接日志

### 3. Yjs 服务器日志

```
New client connected: {docId}
Document {docId}: {clientCount} clients
```

## 🎉 成功标志

- ✅ Yjs 服务器正常运行
- ✅ 编辑器初始化成功
- ✅ 左侧显示在线用户（至少显示自己）
- ✅ 多个用户时能看到彼此
- ✅ 内容实时同步
- ✅ 能看到其他用户的光标

## 📝 技术实现

### 官方 API（已使用）

```typescript
// 1. 配置协作
editor = new Editor({
  collaborateConfig: {
    userinfo: { id, username, color },
    createConnector(yDoc) {
      return new YWebsocketConnector(wsUrl, docId, yDoc)
    }
  }
})

// 2. 获取协作用户
const msgBus = editor.get(XNoteMessageBus)
msgBus.onMessageChange.subscribe((msgs) => {
  const users = msgs.map((i) => i.message)
  console.log('当前协作用户有：', users)
})
```

## 🚀 下一步

如果协作功能正常：

- ✅ 可以部署到生产环境
- ✅ 可以配置独立的 Yjs 服务器（参考 `yjs-collab-server/README.md`）
- ✅ 可以切换到 Hocuspocus 服务器（更强大）

如果有问题：

- 🔍 查看控制台错误信息
- 📋 复制完整日志给我分析
- 🛠️ 我会继续优化
