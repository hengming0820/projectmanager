# åä½œç”¨æˆ·æ˜¾ç¤ºåŠŸèƒ½ + å·¥å…·æ è¾¹ç¼˜ä¼˜åŒ–

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. **åœ¨çº¿åä½œç”¨æˆ·æ˜¾ç¤º**

ç±»ä¼¼å®˜æ–¹æ¡ˆä¾‹ï¼Œå®æ—¶æ˜¾ç¤ºæ­£åœ¨ç¼–è¾‘æ–‡æ¡£çš„æ‰€æœ‰ç”¨æˆ·ã€‚

#### åŠŸèƒ½ç‰¹æ€§

- âœ… **å®æ—¶æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·**ï¼šå¤´åƒã€ç”¨æˆ·åã€ç”¨æˆ·æ•°é‡
- âœ… **ç”¨æˆ·æ ‡è¯†**ï¼šæ¯ä¸ªç”¨æˆ·æœ‰å”¯ä¸€çš„é¢œè‰²æ ‡è¯†
- âœ… **åœ¨çº¿çŠ¶æ€**ï¼šè„‰å†²åŠ¨ç”»è¡¨ç¤ºç”¨æˆ·åœ¨çº¿
- âœ… **å½“å‰ç”¨æˆ·æ ‡è®°**ï¼šæ˜¾ç¤º "(æˆ‘)" æ ‡è¯†
- âœ… **æ‚¬åœæç¤º**ï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´ç”¨æˆ·å
- âœ… **åŠ¨æ€æ›´æ–°**ï¼šç”¨æˆ·åŠ å…¥/ç¦»å¼€æ—¶è‡ªåŠ¨æ›´æ–°

#### è§†è§‰æ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ æ­£åœ¨ç¼–è¾‘ (3)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¨ ğŸ§’ ğŸ‘©              â”‚
â”‚  å¼   æ  ç‹             â”‚
â”‚  ä¸‰  å››  äº” (æˆ‘)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **å†…è”å·¥å…·æ è¾¹ç¼˜ä¼˜åŒ–**

ä¿®å¤é€‰ä¸­æ–‡å­—åå·¥å…·æ åœ¨è¾¹ç¼˜è¢«é®æŒ¡çš„é—®é¢˜ã€‚

#### ä¼˜åŒ–å†…å®¹

- âœ… **è§†å£é™åˆ¶**ï¼š`max-width: calc(100vw - 300px)`
- âœ… **é«˜åº¦é™åˆ¶**ï¼š`max-height: calc(100vh - 100px)`
- âœ… **è‡ªåŠ¨æ»šåŠ¨**ï¼šä¸‹æ‹‰èœå•å†…å®¹è¿‡å¤šæ—¶å¯æ»šåŠ¨
- âœ… **èƒŒæ™¯åŠ å¼º**ï¼šç™½è‰²èƒŒæ™¯ + é˜´å½±ï¼Œç¡®ä¿å¯è§
- âœ… **è¾¹æ¡†æ ·å¼**ï¼šç»Ÿä¸€è¾¹æ¡†å’Œåœ†è§’

## ğŸ“ æ–°å¢æ–‡ä»¶

### `src/components/core/forms/art-textbus-editor/CollaborationUsers.vue`

åä½œç”¨æˆ·æ˜¾ç¤ºç»„ä»¶ï¼Œå®Œæ•´å®ç°ï¼š

```vue
<template>
  <div class="collaboration-users">
    <div class="users-header">
      <el-icon><User /></el-icon>
      <span class="title">æ­£åœ¨ç¼–è¾‘ ({{ users.length }})</span>
    </div>
    <div class="users-list">
      <el-tooltip v-for="user in users" :key="user.id">
        <div class="user-avatar" :style="{ borderColor: user.color }">
          <span class="avatar-text">{{ user.username[0] }}</span>
          <div class="online-indicator"></div>
        </div>
      </el-tooltip>
    </div>
  </div>
</template>
```

**ç‰¹ç‚¹**ï¼š

- å›ºå®šåœ¨å³ä¸Šè§’ (`position: fixed`)
- z-index: 900ï¼ˆä½äºå·¥å…·æ ï¼Œé«˜äºç¼–è¾‘å™¨ï¼‰
- å“åº”å¼è®¾è®¡ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰
- è„‰å†²åŠ¨ç”»ï¼ˆåœ¨çº¿æŒ‡ç¤ºå™¨ï¼‰

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶

### `src/components/core/forms/art-textbus-editor/index.vue`

#### 1. å¯¼å…¥åä½œç”¨æˆ·ç»„ä»¶

```vue
import CollaborationUsers from './CollaborationUsers.vue'
```

#### 2. æ·»åŠ ç”¨æˆ·åˆ—è¡¨çŠ¶æ€

```typescript
// åä½œç”¨æˆ·åˆ—è¡¨
const collaborationUsers = ref<
  Array<{
    id: string
    username: string
    color: string
    isSelf?: boolean
  }>
>([])

// åä½œè¿æ¥å™¨å®ä¾‹
let collaborationConnector: any = null
```

#### 3. ç›‘å¬ Yjs Awareness

```typescript
const setupCollaborationListeners = (yDoc: any) => {
  const awareness = yDoc.getMap('awareness')

  const updateUsers = () => {
    const states = awareness.getStates()
    const users = []

    states.forEach((state: any, clientId: number) => {
      if (state && state.user) {
        users.push({
          id: state.user.id,
          username: state.user.username,
          color: state.user.color,
          isSelf: state.user.id === props.currentUser?.id
        })
      }
    })

    collaborationUsers.value = users
  }

  awareness.on('change', updateUsers)
  awareness.on('update', updateUsers)
  updateUsers()
}
```

#### 4. ä¼˜åŒ–å†…è”å·¥å…·æ æ ·å¼

```scss
/* å†…è”å·¥å…·æ ç‰¹æ®Šä¼˜åŒ– - ç¡®ä¿å®Œæ•´æ˜¾ç¤º */
.textbus-toolbar-inline {
  max-width: calc(100vw - 300px) !important;
  transform: none !important;
  background: white !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 8px !important;
  padding: 6px !important;
}

/* ä¸‹æ‹‰èœå• */
.textbus-toolbar-dropdown,
.textbus-dropdown-menu,
.textbus-popup {
  max-width: calc(100vw - 300px) !important;
  max-height: calc(100vh - 100px) !important;
  overflow: auto !important;
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯ç”¨åä½œæ¨¡å¼

åœ¨åˆ›å»º/ç¼–è¾‘æ–‡æ¡£é¡µé¢ï¼Œä¼ å…¥åä½œå‚æ•°ï¼š

```vue
<ArtTextbusEditor
  v-model="form.content"
  :height="editorHeight"
  placeholder="å¼€å§‹ç¼–å†™ä½ çš„æ–‡æ¡£..."
  :collaboration-enabled="true"
  :document-id="documentId"
  :current-user="{
    id: currentUser.id,
    username: currentUser.username,
    color: '#4ade80'
  }"
/>
```

### æµ‹è¯•åä½œåŠŸèƒ½

1. **å¯åŠ¨ Yjs æœåŠ¡å™¨**

   ```bash
   cd yjs-collab-server
   npm start
   ```

2. **æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£**

   - çª—å£ Aï¼šç”¨æˆ· A ç™»å½•
   - çª—å£ Bï¼šç”¨æˆ· B ç™»å½•

3. **ä¸¤ä¸ªçª—å£éƒ½è¿›å…¥åŒä¸€æ–‡æ¡£**

   - ä½¿ç”¨ç›¸åŒçš„ `document-id`

4. **è§‚å¯Ÿåä½œæ•ˆæœ**
   - âœ… å³ä¸Šè§’æ˜¾ç¤º"æ­£åœ¨ç¼–è¾‘ (2)"
   - âœ… æ˜¾ç¤ºä¸¤ä¸ªç”¨æˆ·çš„å¤´åƒ
   - âœ… ä¸€ä¸ªçª—å£è¾“å…¥ï¼Œå¦ä¸€ä¸ªçª—å£å®æ—¶æ˜¾ç¤º
   - âœ… å…‰æ ‡å’Œé€‰åŒºå®æ—¶å…±äº«

## ğŸ¨ æ ·å¼ç»†èŠ‚

### ç”¨æˆ·å¤´åƒ

| å±æ€§ | å€¼        | è¯´æ˜         |
| ---- | --------- | ------------ |
| å°ºå¯¸ | 36x36px   | æ¡Œé¢ç«¯       |
| å°ºå¯¸ | 32x32px   | ç§»åŠ¨ç«¯       |
| è¾¹æ¡† | 2px solid | ä½¿ç”¨ç”¨æˆ·é¢œè‰² |
| åœ†è§’ | 50%       | åœ†å½¢         |
| å­—ä½“ | 14px/600  | ç”¨æˆ·åé¦–å­—æ¯ |

### åœ¨çº¿æŒ‡ç¤ºå™¨

| å±æ€§ | å€¼        | è¯´æ˜                 |
| ---- | --------- | -------------------- |
| å°ºå¯¸ | 10x10px   | æ¡Œé¢ç«¯               |
| å°ºå¯¸ | 8x8px     | ç§»åŠ¨ç«¯               |
| ä½ç½® | å³ä¸‹è§’    | `position: absolute` |
| è¾¹æ¡† | 2px white | ä¸èƒŒæ™¯åˆ†ç¦»           |
| åŠ¨ç”» | pulse 2s  | è„‰å†²æ•ˆæœ             |

### å®¹å™¨ä½ç½®

| å±æ€§    | å€¼    | è¯´æ˜       |
| ------- | ----- | ---------- |
| ä½ç½®    | fixed | å›ºå®šåœ¨è§†å£ |
| top     | 80px  | æ¡Œé¢ç«¯     |
| top     | 64px  | ç§»åŠ¨ç«¯     |
| right   | 24px  | æ¡Œé¢ç«¯     |
| right   | 12px  | ç§»åŠ¨ç«¯     |
| z-index | 900   | ä½äºå·¥å…·æ  |

## ğŸ“Š æŠ€æœ¯å®ç°

### Yjs Awareness

```typescript
// Yjs æä¾›çš„ Awareness å¯¹è±¡ç”¨äºè·Ÿè¸ªåœ¨çº¿çŠ¶æ€
const awareness = yDoc.getMap('awareness')

// è·å–æ‰€æœ‰åœ¨çº¿ç”¨æˆ·çš„çŠ¶æ€
const states = awareness.getStates()

// states ç»“æ„ï¼š
// Map<clientId, {
//   user: {
//     id: string
//     username: string
//     color: string
//   }
// }>
```

### äº‹ä»¶ç›‘å¬

```typescript
// ç”¨æˆ·çŠ¶æ€å˜åŒ–æ—¶è§¦å‘
awareness.on('change', updateUsers)
awareness.on('update', updateUsers)

// change: ç”¨æˆ·åŠ å…¥/ç¦»å¼€
// update: ç”¨æˆ·ä¿¡æ¯æ›´æ–°
```

### æ¸…ç†æœºåˆ¶

```typescript
onBeforeUnmount(() => {
  // 1. æ¸…ç†åä½œè¿æ¥
  collaborationConnector?.destroy()

  // 2. æ¸…ç©ºç”¨æˆ·åˆ—è¡¨
  collaborationUsers.value = []

  // 3. é”€æ¯ç¼–è¾‘å™¨
  editorInstance?.destroy()
})
```

## ğŸ› å·²è§£å†³çš„é—®é¢˜

### é—®é¢˜ 1ï¼šå·¥å…·æ åœ¨è¾¹ç¼˜è¢«è£å‰ª âœ…

**åŸå› **ï¼š

- å·¥å…·æ ä½¿ç”¨ `position: fixed`ï¼Œä½†æ²¡æœ‰è§†å£é™åˆ¶
- è¶…å‡ºè§†å£çš„éƒ¨åˆ†è¢«æµè§ˆå™¨è£å‰ª

**è§£å†³æ–¹æ¡ˆ**ï¼š

```scss
.textbus-toolbar-inline {
  max-width: calc(100vw - 300px) !important;
  max-height: calc(100vh - 100px) !important;
  overflow: auto !important;
}
```

### é—®é¢˜ 2ï¼šæ²¡æœ‰æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ· âœ…

**åŸå› **ï¼š

- æœªç›‘å¬ Yjs Awareness äº‹ä»¶
- æ²¡æœ‰ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºç»„ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. åˆ›å»º `CollaborationUsers.vue` ç»„ä»¶
2. ç›‘å¬ `awareness.on('change')` äº‹ä»¶
3. å®æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨

### é—®é¢˜ 3ï¼šç”¨æˆ·åˆ—è¡¨ä¸æ›´æ–° âœ…

**åŸå› **ï¼š

- Awareness çŠ¶æ€å˜åŒ–æ—¶æ²¡æœ‰è§¦å‘ Vue å“åº”å¼æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// ä½¿ç”¨ ref åŒ…è£¹ï¼Œç¡®ä¿å“åº”å¼
const collaborationUsers = ref([])

// æ¯æ¬¡æ›´æ–°éƒ½é‡æ–°èµ‹å€¼ï¼Œè§¦å‘å“åº”å¼
collaborationUsers.value = newUsers
```

## ğŸ”„ å“åº”å¼å¤„ç†

### æ¡Œé¢ç«¯

```scss
.collaboration-users {
  top: 80px;
  right: 24px;
  min-width: 200px;

  .user-avatar {
    width: 36px;
    height: 36px;
  }
}
```

### ç§»åŠ¨ç«¯

```scss
@media (max-width: 768px) {
  .collaboration-users {
    top: 64px;
    right: 12px;
    min-width: 160px;

    .user-avatar {
      width: 32px;
      height: 32px;
    }
  }
}
```

## ğŸ¯ æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

- âœ… å•ç”¨æˆ·ï¼šæ˜¾ç¤º"æ­£åœ¨ç¼–è¾‘ (1)"ï¼Œæ˜¾ç¤ºå½“å‰ç”¨æˆ·
- âœ… å¤šç”¨æˆ·ï¼šæ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼Œæ•°é‡æ­£ç¡®
- âœ… ç”¨æˆ·åŠ å…¥ï¼šæ–°ç”¨æˆ·ç«‹å³å‡ºç°åœ¨åˆ—è¡¨
- âœ… ç”¨æˆ·ç¦»å¼€ï¼šç¦»çº¿ç”¨æˆ·ä»åˆ—è¡¨ç§»é™¤
- âœ… é¢œè‰²åŒºåˆ†ï¼šæ¯ä¸ªç”¨æˆ·æœ‰ä¸åŒé¢œè‰²

### æ ·å¼æµ‹è¯•

- âœ… å¤´åƒåœ†å½¢ï¼šè¾¹æ¡†é¢œè‰²ä¸ç”¨æˆ·é¢œè‰²ä¸€è‡´
- âœ… åœ¨çº¿æŒ‡ç¤ºå™¨ï¼šè„‰å†²åŠ¨ç”»æ­£å¸¸
- âœ… æ‚¬åœæç¤ºï¼šæ˜¾ç¤ºå®Œæ•´ç”¨æˆ·å
- âœ… è‡ªå·±æ ‡è®°ï¼šæ˜¾ç¤º "(æˆ‘)" åç¼€

### å·¥å…·æ æµ‹è¯•

- âœ… è¾¹ç¼˜é€‰ä¸­ï¼šå·¥å…·æ ä¸è¢«è£å‰ª
- âœ… é¡¶éƒ¨è¾¹ç¼˜ï¼šå·¥å…·æ å®Œæ•´æ˜¾ç¤º
- âœ… å·¦ä¾§è¾¹ç¼˜ï¼šå·¥å…·æ å®Œæ•´æ˜¾ç¤º
- âœ… å³ä¾§è¾¹ç¼˜ï¼šå·¥å…·æ å®Œæ•´æ˜¾ç¤º
- âœ… ä¸‹æ‹‰èœå•ï¼šå†…å®¹è¿‡å¤šæ—¶å¯æ»šåŠ¨

## ğŸ“š å‚è€ƒèµ„æ–™

- [Yjs Awareness API](https://docs.yjs.dev/api/about-awareness)
- [XNote åä½œæ–‡æ¡£](./XNOTE_COLLABORATION_GUIDE.md)
- [Yjs æœåŠ¡å™¨éƒ¨ç½²](./yjs-collab-server/README.md)

## ğŸ‰ æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

- âŒ æ²¡æœ‰æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·
- âŒ å·¥å…·æ åœ¨è¾¹ç¼˜è¢«è£å‰ª
- âŒ ä¸çŸ¥é“è°åœ¨ç¼–è¾‘

### ä¿®å¤å

- âœ… å®æ—¶æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿ç”¨æˆ·
- âœ… å·¥å…·æ å®Œæ•´æ˜¾ç¤ºï¼Œä¸ä¼šè¢«è£å‰ª
- âœ… æ¸…æ™°çŸ¥é“è°åœ¨ç¼–è¾‘
- âœ… ç”¨æˆ·åŠ å…¥/ç¦»å¼€å®æ—¶æ›´æ–°

**ç°åœ¨ä¸å®˜æ–¹æ¡ˆä¾‹åŠŸèƒ½ä¸€è‡´ï¼** ğŸŠ

---

**å®ç°æ—¥æœŸ**: 2025-11-11  
**åŠŸèƒ½çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…éªŒè¯
