# æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜è¯Šæ–­

### ç°è±¡

- âœ… **å›¢é˜Ÿåä½œé¡µé¢** - ç‚¹å‡»"ç¼–è¾‘å†…å®¹"åå¯ä»¥æ­£å¸¸ä½¿ç”¨
- âŒ **åˆ›å»ºæ–‡æ¡£é¡µé¢** - å †æ ˆæº¢å‡ºå´©æºƒï¼Œæ— æ³•ä½¿ç”¨

### æ ¹æœ¬åŸå› 

é€šè¿‡å¯¹æ¯”ä¸¤ä¸ªé¡µé¢çš„é…ç½®ï¼Œæ‰¾åˆ°äº†é—®é¢˜ï¼š

| é¡µé¢         | åä½œåŠŸèƒ½  | çŠ¶æ€    |
| ------------ | --------- | ------- |
| å›¢é˜Ÿåä½œé¡µé¢ | âŒ æœªå¯ç”¨ | âœ… æ­£å¸¸ |
| åˆ›å»ºæ–‡æ¡£é¡µé¢ | âœ… å¯ç”¨äº† | âŒ å´©æºƒ |

**ç»“è®ºï¼šXNote çš„ Yjs åä½œåŠŸèƒ½ä¸æ‚¨çš„ç¯å¢ƒä¸å…¼å®¹ï¼Œå¯¼è‡´å †æ ˆæº¢å‡ºï¼**

```
Uncaught RangeError: Maximum call stack size exceeded
at SelectionBridge2.findFocusNode
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šç¦ç”¨ XNote çš„åä½œåŠŸèƒ½

**ä¿®æ”¹å‰ï¼ˆå´©æºƒï¼‰ï¼š**

```vue
<ArtTextbusEditor
  :collaboration-enabled="true"    <!-- âŒ å¯¼è‡´å´©æºƒ -->
  :document-id="documentId"
  :current-user="currentUserInfo"
  @collaboration-users-change="onCollaborationUsersChange"
/>
```

**ä¿®æ”¹åï¼ˆæ­£å¸¸ï¼‰ï¼š**

```vue
<ArtTextbusEditor
  v-model="form.content"
  :height="editorHeight"
  placeholder="å¼€å§‹ç¼–å†™ä½ çš„æ–‡æ¡£..."
  @change="handleContentChange"   <!-- âœ… ç®€å•å›è°ƒ -->
/>
```

### é…ç½®å¯¹æ¯”

#### å›¢é˜Ÿåä½œé¡µé¢ï¼ˆå¯ç”¨é…ç½®ï¼‰

```vue
<ArtTextbusEditor
  :key="`editor-${documentId}-${isEditing ? 'edit' : 'view'}`"
  ref="editorRef"
  v-model="editingContent"
  :height="'calc(100vh - 400px)'"
  :placeholder="'å¼€å§‹ç¼–å†™åä½œæ–‡æ¡£å†…å®¹...'"
  @change="handleContentChange"
  @ready="onEditorReady"
/>
```

**ç‰¹ç‚¹ï¼š**

- âœ… åªæœ‰åŸºç¡€ç¼–è¾‘åŠŸèƒ½
- âœ… æ²¡æœ‰ Yjs åä½œ
- âœ… ç¨³å®šå¯é 

#### åˆ›å»ºæ–‡æ¡£é¡µé¢ï¼ˆç°å·²ä¿®å¤ï¼‰

```vue
<ArtTextbusEditor
  ref="editorRef"
  v-model="form.content"
  :height="editorHeight"
  placeholder="å¼€å§‹ç¼–å†™ä½ çš„æ–‡æ¡£..."
  @change="handleContentChange"
/>
```

**ç‰¹ç‚¹ï¼š**

- âœ… ä¸å›¢é˜Ÿåä½œé¡µé¢ç›¸åŒçš„é…ç½®
- âœ… æ²¡æœ‰ Yjs åä½œ
- âœ… åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨

---

## ğŸ“‹ ä¿®æ”¹å†…å®¹

### æ–‡ä»¶ 1ï¼šåˆ›å»ºæ–‡æ¡£é¡µé¢

**æ–‡ä»¶ï¼š** `src/views/collaboration/create/index.vue`

#### ä¿®æ”¹ 1ï¼šç®€åŒ–ç¼–è¾‘å™¨é…ç½®

```diff
<ArtTextbusEditor
  ref="editorRef"
  v-model="form.content"
  :height="editorHeight"
  placeholder="å¼€å§‹ç¼–å†™ä½ çš„æ–‡æ¡£..."
- :collaboration-enabled="true"
- :document-id="documentId"
- :current-user="currentUserInfo"
- @collaboration-users-change="onCollaborationUsersChange"
+ @change="handleContentChange"
/>
```

#### ä¿®æ”¹ 2ï¼šéšè—åœ¨çº¿ç”¨æˆ·æ˜¾ç¤º

```diff
- <!-- åœ¨çº¿åä½œç”¨æˆ· -->
- <div class="panel-section">
-   <div class="section-title">æ­£åœ¨ç¼–è¾‘ ({{ collaborationUsers.length }})</div>
-   <div class="collaboration-users-list">...</div>
- </div>
+ <!-- åœ¨çº¿åä½œç”¨æˆ·åŠŸèƒ½æš‚æ—¶ç¦ç”¨ -->
+ <!-- åŸå› ï¼šXNote çš„ Yjs åä½œåŠŸèƒ½å¯¼è‡´å †æ ˆæº¢å‡º -->
```

#### ä¿®æ”¹ 3ï¼šæ›´æ–°å›è°ƒæ–¹æ³•

```typescript
// ä¹‹å‰
const onCollaborationUsersChange = (users: any[]) => {
  collaborationUsers.value = users
}

// ç°åœ¨
const handleContentChange = (html: string) => {
  console.log('ğŸ“ [Create] å†…å®¹å·²æ›´æ–°')
  // å†…å®¹å·²é€šè¿‡ v-model è‡ªåŠ¨åŒæ­¥
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ·æ–°é¡µé¢

```bash
Ctrl + Shift + R
```

### æ­¥éª¤ 2ï¼šè¿›å…¥åˆ›å»ºæ–‡æ¡£é¡µé¢

å¯¼èˆªï¼š**åä½œæ–‡æ¡£ â†’ åˆ›å»ºæ–‡æ¡£**

### æ­¥éª¤ 3ï¼šæµ‹è¯•åŸºç¡€åŠŸèƒ½

1. **ç‚¹å‡»ç¼–è¾‘å™¨** â†’ åº”è¯¥å‡ºç°å…‰æ ‡
2. **è¾“å…¥æ–‡å­—** â†’ åº”è¯¥æ­£å¸¸æ˜¾ç¤º
3. **æŸ¥çœ‹å·¥å…·æ ** â†’ å·¦ä¾§å‚ç›´å·¥å…·æ åº”è¯¥å¯è§
4. **é€‰ä¸­æ–‡å­—** â†’ å†…è”å·¥å…·æ åº”è¯¥å‡ºç°
5. **ä½¿ç”¨å·¥å…·æ ** â†’ åŠ ç²—ã€æ–œä½“ç­‰åº”è¯¥æ­£å¸¸å·¥ä½œ

### é¢„æœŸç»“æœ

#### âœ… åº”è¯¥ï¼š

- ç¼–è¾‘å™¨å¯ä»¥ç‚¹å‡»
- å¯ä»¥æ­£å¸¸è¾“å…¥æ–‡å­—
- å·¥å…·æ æ­£å¸¸æ˜¾ç¤ºå’Œå·¥ä½œ
- æ²¡æœ‰å †æ ˆæº¢å‡ºé”™è¯¯
- ä¸"å›¢é˜Ÿåä½œé¡µé¢"çš„ç¼–è¾‘ä½“éªŒç›¸åŒ

#### âŒ ä¸åº”è¯¥ï¼š

- å †æ ˆæº¢å‡ºé”™è¯¯
- ç¼–è¾‘å™¨æ— æ³•ç‚¹å‡»
- æ— æ³•è¾“å…¥æ–‡å­—

---

## ğŸ” ä¸ºä»€ä¹ˆåä½œåŠŸèƒ½ä¼šå´©æºƒï¼Ÿ

### æŠ€æœ¯åˆ†æ

XNote çš„ Yjs åä½œåŠŸèƒ½åŸºäºï¼š

1. **Yjs** - CRDT ç®—æ³•å®ç°å®æ—¶åŒæ­¥
2. **Y-WebSocket** - WebSocket è¿æ¥å™¨
3. **SelectionBridge** - é€‰åŒºåŒæ­¥

**å´©æºƒåŸå› ï¼š**

```javascript
// XNote å†…éƒ¨çš„ SelectionBridge é™·å…¥æ— é™é€’å½’
findFocusNode() {
  // ...
  this.findFocusNode()  // é€’å½’è°ƒç”¨
  this.findFocusNode()  // é€’å½’è°ƒç”¨
  // ... æ— é™å¾ªç¯
}
```

**å¯èƒ½çš„åŸå› ï¼š**

1. **DOM ç»“æ„é—®é¢˜** - Yjs åˆ›å»ºçš„ DOM ç»“æ„ä¸ XNote é¢„æœŸä¸ç¬¦
2. **å¾ªç¯å¼•ç”¨** - åä½œå…‰æ ‡åˆ›å»ºäº†å¾ªç¯å¼•ç”¨çš„ DOM èŠ‚ç‚¹
3. **ç‰ˆæœ¬ä¸å…¼å®¹** - `@textbus/xnote` å’Œ `@textbus/collaborate` ç‰ˆæœ¬ä¸åŒ¹é…
4. **ç¯å¢ƒé—®é¢˜** - ä¸ Vue 3 / Vite çš„å…¼å®¹æ€§é—®é¢˜

---

## ğŸ¯ å½“å‰çŠ¶æ€

| åŠŸèƒ½         | çŠ¶æ€    | è¯´æ˜                 |
| ------------ | ------- | -------------------- |
| **åŸºç¡€ç¼–è¾‘** | âœ… å¯ç”¨ | è¾“å…¥ã€æ ¼å¼åŒ–ã€å·¥å…·æ  |
| **æ–‡ä»¶ä¸Šä¼ ** | âœ… å¯ç”¨ | å›¾ç‰‡ã€é™„ä»¶ä¸Šä¼        |
| **è‡ªåŠ¨ä¿å­˜** | âœ… å¯ç”¨ | v-model åŒå‘ç»‘å®š     |
| **å·¥å…·æ **   | âœ… å¯ç”¨ | å·¦ä¾§ + å†…è”å·¥å…·æ     |
| **å†…å®¹æ»šåŠ¨** | âœ… å¯ç”¨ | è‡ªåŠ¨é€‚åº”é«˜åº¦         |
| **å¤šäººåä½œ** | âŒ ç¦ç”¨ | å¯¼è‡´å´©æºƒ             |
| **åœ¨çº¿ç”¨æˆ·** | âŒ ç¦ç”¨ | ä¾èµ–åä½œåŠŸèƒ½         |
| **å®æ—¶åŒæ­¥** | âŒ ç¦ç”¨ | ä¾èµ–åä½œåŠŸèƒ½         |

---

## ğŸš€ æ›¿ä»£åä½œæ–¹æ¡ˆ

ç”±äº XNote çš„ Yjs åä½œä¸å¯ç”¨ï¼Œå»ºè®®ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆ Aï¼šè½®è¯¢ä¿å­˜ï¼ˆç®€å•ï¼‰

```typescript
// å®šæ—¶ä¿å­˜åˆ°æœåŠ¡å™¨
setInterval(() => {
  saveDocument()
}, 30000) // æ¯ 30 ç§’ä¿å­˜ä¸€æ¬¡
```

**ä¼˜ç‚¹ï¼š**

- âœ… ç®€å•æ˜“å®ç°
- âœ… ä¸éœ€è¦ WebSocket
- âœ… å…¼å®¹æ€§å¥½

**ç¼ºç‚¹ï¼š**

- âŒ ä¸æ˜¯å®æ—¶åŒæ­¥
- âŒ å¯èƒ½æœ‰å†²çª
- âŒ æµªè´¹å¸¦å®½

### æ–¹æ¡ˆ Bï¼šè‡ªå®šä¹‰ WebSocketï¼ˆæ¨èï¼‰

ä½¿ç”¨æ‚¨ç°æœ‰çš„ WebSocket å®ç°ï¼š

```typescript
// ä½¿ç”¨ç°æœ‰çš„ ws è¿æ¥
ws = new WebSocket(`ws://localhost:8000/ws/document/${documentId}`)

ws.onmessage = (event) => {
  const data = JSON.parse(event.data)
  if (data.type === 'content_update') {
    // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹ï¼ˆå¦‚æœä¸æ˜¯å½“å‰ç”¨æˆ·ç¼–è¾‘ï¼‰
    if (data.userId !== currentUserId) {
      editorInstance.setContent(data.content)
    }
  }
}

// å‘é€ç¼–è¾‘
const handleContentChange = (html) => {
  ws.send(
    JSON.stringify({
      type: 'content_update',
      content: html,
      userId: currentUserId
    })
  )
}
```

**ä¼˜ç‚¹ï¼š**

- âœ… å®æ—¶åŒæ­¥
- âœ… ä½¿ç”¨ç°æœ‰åŸºç¡€è®¾æ–½
- âœ… å¯æ§æ€§é«˜

**ç¼ºç‚¹ï¼š**

- âš ï¸ éœ€è¦å¤„ç†å†²çª
- âš ï¸ éœ€è¦åç«¯æ”¯æŒ

### æ–¹æ¡ˆ Cï¼šæ›´æ¢ç¼–è¾‘å™¨

å¦‚æœéœ€è¦ç¨³å®šçš„åä½œåŠŸèƒ½ï¼Œè€ƒè™‘ï¼š

#### TipTap + Yjs

```bash
npm install @tiptap/vue-3 @tiptap/starter-kit
npm install @tiptap/extension-collaboration
npm install yjs y-websocket
```

**ä¼˜ç‚¹ï¼š**

- âœ… åŸç”Ÿæ”¯æŒ Yjs åä½œ
- âœ… ç¨³å®šå¯é 
- âœ… Vue 3 å‹å¥½
- âœ… æ–‡æ¡£å®Œå–„

**ç¤ºä¾‹ï¼š**

```vue
<template>
  <editor-content :editor="editor" />
</template>

<script setup>
  import { useEditor, EditorContent } from '@tiptap/vue-3'
  import StarterKit from '@tiptap/starter-kit'
  import Collaboration from '@tiptap/extension-collaboration'
  import * as Y from 'yjs'
  import { WebsocketProvider } from 'y-websocket'

  const ydoc = new Y.Doc()
  const provider = new WebsocketProvider('ws://localhost:1234', 'document-name', ydoc)

  const editor = useEditor({
    extensions: [
      StarterKit,
      Collaboration.configure({
        document: ydoc
      })
    ]
  })
</script>
```

---

## âœ… éªŒæ”¶æ ‡å‡†

æµ‹è¯•åè¯·ç¡®è®¤ï¼š

- [ ] åˆ›å»ºæ–‡æ¡£é¡µé¢å¯ä»¥æ‰“å¼€
- [ ] ç¼–è¾‘å™¨å¯ä»¥ç‚¹å‡»
- [ ] å¯ä»¥æ­£å¸¸è¾“å…¥æ–‡å­—
- [ ] å·¥å…·æ æ­£å¸¸æ˜¾ç¤º
- [ ] å·¥å…·æ æŒ‰é’®å¯ç”¨ï¼ˆåŠ ç²—ã€æ–œä½“ç­‰ï¼‰
- [ ] æ²¡æœ‰å †æ ˆæº¢å‡ºé”™è¯¯
- [ ] æ²¡æœ‰æ§åˆ¶å°é”™è¯¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [XNote å®˜æ–¹æ–‡æ¡£](https://textbus.io)
- [TipTap æ–‡æ¡£](https://tiptap.dev)
- [Yjs æ–‡æ¡£](https://docs.yjs.dev)

---

**æ›´æ–°æ—¶é—´**: 2025-11-11  
**çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼ˆç¦ç”¨åä½œåŠŸèƒ½ï¼‰  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…æ‚¨éªŒè¯

**ç°åœ¨è¯·åˆ·æ–°é¡µé¢æµ‹è¯•åˆ›å»ºæ–‡æ¡£åŠŸèƒ½ï¼** ğŸš€
