# 协作文档页面布局重构 + 悬浮工具栏

## 🎯 重构目标

根据用户反馈，重新设计协作文档创建页面，解决以下问题：

1. ✅ **右侧空间不足**：原布局编辑器在左侧（窄），设置在右侧（宽）
2. ✅ **工具栏被遮挡**：选中文字后内联工具栏在边缘会被裁剪
3. ✅ **在线用户显示**：固定在右上角不够明显

## 📐 新布局方案

### 布局对比

#### 旧布局

```
┌────────────────────────────────────────┬──────────┐
│  编辑器（flex: 1）                    │  设置面板 │
│  - 标题                                │  (320px) │
│  - 描述                                │          │
│  - 内容                                │          │
│  ❌ 空间不够，工具栏容易被遮挡         │          │
└────────────────────────────────────────┴──────────┘
```

#### 新布局

```
┌──────────┬───────────────────────────────────────────┐
│  设置面板 │  编辑器（flex: 1）                       │
│ (320px)  │  - 标题                                   │
│          │  - 描述                                   │
│ ┌──────┐ │  - 内容（充足空间）                       │
│ │在线  │ │  ✅ 空间充足，工具栏不会被遮挡             │
│ │用户  │ │  🎈 悬浮工具栏自动定位                    │
│ └──────┘ │                                          │
└──────────┴───────────────────────────────────────────┘
```

### 新布局优势

| 改进项           | 说明                                          |
| ---------------- | --------------------------------------------- |
| **编辑区更宽**   | 编辑器占据主要空间（flex: 1），更符合编辑场景 |
| **设置面板左侧** | 固定 320px，收纳所有设置项和在线用户          |
| **在线用户可见** | 嵌入设置面板，始终可见，不需要滚动            |
| **悬浮工具栏**   | 自动定位，智能避开边缘，不会被遮挡            |
| **响应式**       | 移动端自动垂直堆叠                            |

## 🔧 技术实现

### 1. 布局结构调整

#### 文件：`src/views/collaboration/create/index.vue`

**旧结构：**

```vue
<div class="main-content">
  <div class="editor-section">...</div>  <!-- 左侧 -->
  <div class="settings-panel">...</div> <!-- 右侧 -->
</div>
```

**新结构：**

```vue
<div class="main-content">
  <div class="settings-panel">        <!-- 左侧 -->
    <!-- 文档设置 -->
    <div class="panel-section">...</div>

    <!-- 在线用户 -->
    <div class="panel-section">
      <div class="collaboration-users-list">...</div>
    </div>
  </div>

  <div class="editor-section">        <!-- 右侧 -->
    <!-- 标题、描述、编辑器 -->
  </div>
</div>
```

### 2. 在线用户显示

#### 从 Fixed 到 Inline

**旧方案**（CollaborationUsers.vue 独立组件）：

```vue
<!-- 固定在右上角 -->
<div class="collaboration-users" style="position: fixed; top: 80px; right: 24px;">
  ...
</div>
```

**新方案**（嵌入设置面板）：

```vue
<!-- 嵌入左侧面板 -->
<div class="panel-section">
  <div class="section-title">
    <el-icon><UserFilled /></el-icon>
    正在编辑
    <el-tag>{{ collaborationUsers.length }}</el-tag>
  </div>
  <div class="collaboration-users-list">
    <div v-for="user in collaborationUsers" class="user-item">
      <div class="user-avatar">...</div>
      <div class="user-info">
        <div class="user-name">{{ user.username }}</div>
      </div>
    </div>
  </div>
</div>
```

#### 样式优化

```scss
.collaboration-users-list {
  .user-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    border-radius: 8px;

    &:hover {
      background: #f9fafb;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border: 2px solid;
      border-radius: 50%;
      position: relative;

      .online-indicator {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border: 2px solid white;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
      }
    }
  }
}

@keyframes pulse {
  0%,
  100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.8;
    transform: scale(1.15);
  }
}
```

### 3. 悬浮工具栏（核心改进）

#### 文件：`src/components/core/forms/art-textbus-editor/index.vue`

#### 新增 Props

```typescript
interface Props {
  // ...其他 props
  toolbarType?: 'default' | 'suspension' | 'static'
}

const props = withDefaults(defineProps<Props>(), {
  toolbarType: 'suspension' // 默认悬浮工具栏
})
```

#### 工具栏类型说明

| 类型         | 说明                    | 优缺点                      |
| ------------ | ----------------------- | --------------------------- |
| `default`    | 左侧工具栏 + 内联工具栏 | ❌ 内联工具栏可能被边缘遮挡 |
| `suspension` | 悬浮工具栏（推荐）      | ✅ 自动定位，智能避开边缘   |
| `static`     | 顶部固定工具栏          | ✅ 始终可见，但占据空间     |

#### 实现代码

```typescript
// 动态导入 XNote 工具栏插件
const { Editor, FileUploader, SuspensionToolbarPlugin, StaticToolbarPlugin } = await import(
  '@textbus/xnote'
)

// 根据工具栏类型配置插件
if (props.toolbarType === 'suspension') {
  // 悬浮工具栏（推荐）- 自动定位，不会被遮挡
  editorConfig.plugins = [new SuspensionToolbarPlugin()]
} else if (props.toolbarType === 'static') {
  // 静态顶部工具栏 - 需要提供容器
  const toolbarHost = document.createElement('div')
  toolbarHost.className = 'xnote-static-toolbar-host'
  editorRef.value.parentElement?.insertBefore(toolbarHost, editorRef.value)

  editorConfig.plugins = [
    new StaticToolbarPlugin({
      host: toolbarHost,
      theme: 'light'
    })
  ]
}
// 否则使用默认配置
```

#### 悬浮工具栏特性

```
┌─────────────────────────────────────┐
│                                     │
│  选中文字后，工具栏自动出现：        │
│                                     │
│     这是一段文本 📝                  │
│     ┌─────────────┐                │
│     │ B I U 🎨 📎 │ ← 悬浮工具栏    │
│     └─────────────┘                │
│                                     │
│  ✅ 自动检测边缘                     │
│  ✅ 智能调整位置                     │
│  ✅ 不会被遮挡                       │
│                                     │
└─────────────────────────────────────┘
```

### 4. 协作用户事件通信

#### 父子组件通信

```typescript
// 编辑器组件（子）emit 事件
const emit = defineEmits<{
  'collaboration-users-change': [users: Array<{...}>]
}>()

// 在用户列表更新时通知父组件
emit('collaboration-users-change', users)

// 父组件（创建页面）接收事件
const onCollaborationUsersChange = (users: any[]) => {
  collaborationUsers.value = users
  console.log('👥 [Create] 协作用户列表更新:', users)
}
```

```vue
<ArtTextbusEditor @collaboration-users-change="onCollaborationUsersChange" />
```

### 5. 样式优化

#### CSS 关键点

```scss
/* 主内容区 */
.main-content {
  display: flex;
  gap: 24px;
  overflow: visible; /* 允许工具栏溢出 */
}

/* 左侧设置面板 */
.settings-panel {
  width: 320px;
  flex-shrink: 0;
  max-height: calc(100vh - 112px);
  overflow-y: auto;
  overflow-x: hidden;
}

/* 右侧编辑器区域 */
.editor-section {
  flex: 1;
  min-width: 0; /* 防止 flex 溢出 */
  overflow: visible; /* 让工具栏不被裁剪 */
}

/* 响应式 */
@media (max-width: 992px) {
  .main-content {
    flex-direction: column; /* 垂直堆叠 */
  }

  .settings-panel {
    width: 100%;
    max-height: 400px;
  }
}
```

## 📊 改进对比

### 空间利用

| 项目       | 旧布局     | 新布局     | 改进     |
| ---------- | ---------- | ---------- | -------- |
| 编辑器宽度 | ~70%       | ~80%       | +10%     |
| 设置面板   | 320px 右侧 | 320px 左侧 | 位置优化 |
| 在线用户   | Fixed 浮动 | 嵌入面板   | 更直观   |

### 工具栏问题

| 场景     | 旧方案    | 新方案      | 状态   |
| -------- | --------- | ----------- | ------ |
| 顶部边缘 | ❌ 被裁剪 | ✅ 自动避开 | 已解决 |
| 左侧边缘 | ❌ 被裁剪 | ✅ 自动避开 | 已解决 |
| 右侧边缘 | ❌ 被裁剪 | ✅ 自动避开 | 已解决 |
| 底部边缘 | ❌ 被裁剪 | ✅ 自动避开 | 已解决 |

### 用户体验

| 功能         | 旧方案       | 新方案   | 改进   |
| ------------ | ------------ | -------- | ------ |
| 编辑体验     | 空间局促     | 宽敞舒适 | ⭐⭐⭐ |
| 工具栏可见性 | 容易遮挡     | 始终可见 | ⭐⭐⭐ |
| 在线用户     | 浮动，不明显 | 固定显示 | ⭐⭐   |
| 设置访问     | 需要滚动     | 直接可见 | ⭐⭐   |

## 🚀 使用方法

### 1. 基本使用（悬浮工具栏）

```vue
<ArtTextbusEditor
  v-model="form.content"
  toolbar-type="suspension"
  :collaboration-enabled="true"
  :document-id="documentId"
  :current-user="currentUserInfo"
  @collaboration-users-change="onCollaborationUsersChange"
/>
```

### 2. 使用静态顶部工具栏

```vue
<ArtTextbusEditor v-model="form.content" toolbar-type="static" :collaboration-enabled="true" ... />
```

### 3. 使用默认工具栏（左侧+内联）

```vue
<ArtTextbusEditor v-model="form.content" toolbar-type="default" :collaboration-enabled="true" ... />
```

## 🎨 视觉效果

### 整体布局

```
┌─────────────────────────────────────────────────────┐
│  ← 返回   创建协作文档         [导入] [创建文档]     │
├────────┬──────────────────────────────────────────────┤
│设置面板│  标题：_____________________________         │
│        │                                              │
│📋 基础 │  描述：_____________________________         │
│• 可见性│       _____________________________         │
│• 优先级│                                              │
│        │  ──────────────────────────────────         │
│👥 协作 │                                              │
│• 成员  │  这里是编辑器内容...                         │
│        │                                              │
│🏷️ 标签│  选中文字后悬浮工具栏会自动出现：            │
│        │  ┌─────────────────┐                        │
│📊 统计 │  │ B I U 🎨 📎 🔗 │                        │
│        │  └─────────────────┘                        │
│────────│  并且会智能避开边缘！                         │
│        │                                              │
│👥 在线 │  ✅ 充足的编辑空间                           │
│ (2)    │  ✅ 工具栏不会被遮挡                         │
│        │  ✅ 更好的编辑体验                           │
│🟢 张三 │                                              │
│  (我)  │                                              │
│🔵 李四 │                                              │
│        │                                              │
└────────┴──────────────────────────────────────────────┘
```

## 🐛 已解决的问题

### 问题 1：编辑区域太窄 ✅

**原因**：编辑器在左侧，设置面板在右侧，比例不合理

**解决方案**：

- 反转布局：设置面板（320px）在左，编辑器（flex: 1）在右
- 编辑器宽度增加约 10-15%

### 问题 2：工具栏被边缘遮挡 ✅

**原因**：内联工具栏使用 `position: fixed`，没有智能定位

**解决方案**：

- 使用 `SuspensionToolbarPlugin`（悬浮工具栏）
- 自动检测边缘，智能调整位置
- 确保工具栏始终完整可见

### 问题 3：在线用户不够明显 ✅

**原因**：固定在右上角，容易被忽略

**解决方案**：

- 嵌入左侧设置面板
- 始终可见，不需要滚动
- 显示用户数量标签

## 📚 相关文档

- [XNote 官方文档](https://textbus.io)
- [工具栏配置说明](./xnote/README_COLLABORATION.md)
- [协作功能指南](./XNOTE_COLLABORATION_GUIDE.md)
- [Yjs 服务器部署](./yjs-collab-server/README.md)

## 🎉 总结

### 改进成果

- ✅ **布局更合理**：设置左，编辑右，符合编辑习惯
- ✅ **空间更充足**：编辑器占据主要空间（~80%）
- ✅ **工具栏优化**：悬浮工具栏智能定位，不会被遮挡
- ✅ **用户显示**：嵌入左侧面板，始终可见
- ✅ **响应式设计**：移动端自动适配
- ✅ **代码整洁**：删除 CollaborationUsers 独立组件，简化结构

### 下一步优化建议

- ⭐ 添加工具栏主题切换（亮色/暗色）
- ⭐ 支持工具栏位置自定义（左/右/顶/底）
- ⭐ 添加编辑器快捷键提示面板
- ⭐ 优化在线用户头像（支持真实头像上传）

---

**重构日期**: 2025-11-11  
**状态**: ✅ 已完成  
**测试状态**: ⏳ 待验证
