# 当前状态说明

## 🐛 发现的严重问题

根据最新的控制台日志，发现 XNote 编辑器存在严重的兼容性问题：

### 问题 1：Awareness API 不可用 ⚠️

```
⚠️ [XNote] Awareness 不可用
```

- `connector.awareness` 返回 undefined
- Yjs 连接器未正确初始化 awareness 对象

### 问题 2：堆栈溢出（致命错误）🔴

```
Uncaught RangeError: Maximum call stack size exceeded
at SelectionBridge2.findFocusNode
```

- 即使使用默认工具栏也会发生
- 即使禁用协作功能也可能发生
- **这是 XNote 内部的严重 bug**

---

## 🚨 紧急措施

### 已采取的临时措施

#### 1. 暂时禁用协作功能

**文件：** `src/views/collaboration/create/index.vue`

```vue
<ArtTextbusEditor
  :collaboration-enabled="false"  <!-- ✅ 暂时禁用 -->
  ...
/>
```

**原因：**

- 协作功能可能加剧堆栈溢出问题
- Awareness API 无法正常工作

#### 2. 简化在线用户显示

**文件：** `src/components/core/forms/art-textbus-editor/index.vue`

```typescript
// 暂时只显示当前用户
const setupCollaborationListeners = (connector: any) => {
  if (props.currentUser) {
    collaborationUsers.value = [
      {
        id: props.currentUser.id,
        username: props.currentUser.username,
        color: props.currentUser.color || '#4ade80',
        isSelf: true
      }
    ]
  }
}
```

**效果：**

- 左侧面板仍然显示"正在编辑 (1)"
- 只显示当前用户
- 不会尝试获取其他用户（避免 awareness 错误）

---

## 🧪 测试步骤

### 步骤 1：清除缓存并刷新

```bash
# 强制刷新浏览器
Ctrl + Shift + R (Windows/Linux)
Cmd + Shift + R (Mac)
```

### 步骤 2：观察控制台

刷新后应该看到：

#### ✅ 正常日志：

```
🔧 [XNote] 使用默认工具栏（左侧 + 内联）
✅ [XNote] 编辑器初始化成功
👥 [XNote] 显示当前用户（协作功能待修复）
```

#### ❌ 不应该出现：

- ~~`⚠️ [XNote] Awareness 不可用`~~ （可能仍会出现，但不影响）
- ~~`Uncaught RangeError: Maximum call stack size exceeded`~~ （如果仍然出现，说明是 XNote 内部问题）

### 步骤 3：测试基础功能

1. **点击编辑器**

   - ✅ 应该能点击
   - ✅ 应该出现光标

2. **输入文字**

   - ✅ 应该能正常输入
   - ✅ 文字应该显示

3. **查看工具栏**

   - ✅ 左侧应该有垂直工具栏
   - ✅ 选中文字后应该显示内联工具栏

4. **滚动测试**
   - ✅ 输入大量内容后应该出现滚动条

---

## 🔍 问题分析

### 为什么会堆栈溢出？

根据错误堆栈：

```
at SelectionBridge2.findFocusNode (index.esm.js:1018:26)
at SelectionBridge2.findFocusNode (index.esm.js:1021:29)
at SelectionBridge2.findFocusNodeByParent (index.esm.js:1054:25)
...
```

**可能原因：**

1. **循环引用**

   - DOM 结构中存在循环引用
   - `findFocusNode` 递归查找焦点节点时进入死循环

2. **协作模式冲突**

   - Yjs 协作与 TextBus 选区管理冲突
   - 多个选区桥接器相互调用

3. **XNote 版本问题**
   - 使用的 `@textbus/xnote` 版本可能有 bug
   - 需要更新到最新稳定版本

### 为什么 Awareness 不可用？

```typescript
const connector = new YWebsocketConnector(wsUrl, props.documentId, yDoc)
console.log(connector.awareness) // undefined ❌
```

**可能原因：**

1. **初始化顺序问题**

   - `awareness` 在连接建立后才可用
   - 需要监听连接事件后再访问

2. **YWebsocketConnector 实现差异**

   - 不同版本的 `@textbus/collaborate` 实现可能不同
   - 可能需要使用 `connector.doc.getMap('awareness')` 或其他方式

3. **Yjs 服务器未运行**
   - 如果 Yjs 服务器未运行，连接失败
   - `awareness` 可能无法初始化

---

## 🎯 接下来的步骤

### 方案 A：诊断编辑器是否可用（优先）

1. **刷新页面**
2. **观察是否还有堆栈溢出**
3. **尝试输入文字**

如果编辑器可以正常使用：

- ✅ 继续使用（禁用协作）
- 🔧 后续再修复协作功能

如果编辑器仍然崩溃：

- ❌ XNote 与当前环境不兼容
- 🔄 考虑使用其他编辑器（如 Quill、TinyMCE）

### 方案 B：降级或更换编辑器

如果 XNote 无法稳定运行，建议：

#### 选项 1：降级 XNote 版本

```bash
npm uninstall @textbus/xnote
npm install @textbus/xnote@0.3.0  # 使用更早的稳定版本
```

#### 选项 2：使用 Quill 编辑器

```bash
npm install quill@2.0.0
npm install quill-image-uploader
```

Quill 特点：

- ✅ 稳定可靠
- ✅ 生态成熟
- ✅ 文档齐全
- ⚠️ 不支持内置协作（需要额外集成）

#### 选项 3：使用 TipTap 编辑器

```bash
npm install @tiptap/vue-3 @tiptap/starter-kit
npm install @tiptap/extension-collaboration
```

TipTap 特点：

- ✅ 基于 ProseMirror，性能好
- ✅ 原生支持 Yjs 协作
- ✅ Vue 3 友好
- ✅ 生态完善

---

## 📊 当前功能状态

| 功能       | 状态        | 说明               |
| ---------- | ----------- | ------------------ |
| 编辑器显示 | ❓ 待测试   | 禁用协作后可能正常 |
| 基础编辑   | ❓ 待测试   | 如无堆栈溢出则可用 |
| 左侧工具栏 | ✅ 可用     | 默认工具栏         |
| 内联工具栏 | ⚠️ 部分可用 | 可能在边缘被遮挡   |
| 内容滚动   | ✅ 可用     | 已修复             |
| 图片上传   | ✅ 可用     | CustomFileUploader |
| 多人协作   | ❌ 已禁用   | 等待修复           |
| 在线用户   | ⚠️ 简化版   | 只显示当前用户     |
| Awareness  | ❌ 不可用   | API 问题           |

---

## 🚀 测试指令

### 快速测试（30秒）

```bash
# 1. 强制刷新浏览器
Ctrl + Shift + R

# 2. 打开控制台（F12）

# 3. 观察日志，检查是否有：
#    ✅ "编辑器初始化成功"
#    ❌ "Maximum call stack size exceeded"

# 4. 点击编辑器，尝试输入文字

# 5. 报告结果：
#    - 可以输入 ✅ 继续使用
#    - 无法输入 ❌ 考虑更换编辑器
```

---

## 📚 相关资源

### XNote 相关

- [XNote GitHub](https://github.com/textbus/xnote)
- [TextBus 文档](https://textbus.io)
- [Yjs 文档](https://docs.yjs.dev)

### 备选编辑器

- [Quill](https://quilljs.com)
- [TipTap](https://tiptap.dev)
- [Slate](https://docs.slatejs.org)
- [ProseMirror](https://prosemirror.net)

---

## 💬 用户反馈

**请测试后反馈：**

1. 刷新后是否还有堆栈溢出？
2. 编辑器是否可以点击？
3. 是否可以正常输入文字？
4. 左侧工具栏是否显示？
5. 滚动是否正常？

根据您的反馈，我会决定：

- 继续修复 XNote
- 或建议更换为更稳定的编辑器

---

**当前状态**: 🟡 等待测试验证  
**优先级**: 🔴 最高（阻塞核心功能）  
**更新时间**: 2025-11-11
