# ğŸ”§ ç¼“å­˜å¤±æ•ˆé—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“… ä¿®å¤æ—¶é—´

2025-10-31

---

## âŒ é—®é¢˜æè¿°

### ç—‡çŠ¶

åœ¨é›†æˆRedisç¼“å­˜åï¼Œä»»åŠ¡çŠ¶æ€å˜åŒ–æ—¶å‡ºç°å‰ç«¯æ•°æ®ä¸åŒæ­¥çš„é—®é¢˜ï¼š

```
åœºæ™¯ï¼š
1. æ ‡æ³¨å‘˜æäº¤ä»»åŠ¡å®¡æ ¸
2. ç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡ï¼ˆé€šè¿‡/é©³å›ï¼‰
3. æ ‡æ³¨å‘˜çš„å‰ç«¯"æˆ‘çš„å·¥ä½œå°"æœªåˆ·æ–°
4. ä»»åŠ¡ä»æ˜¾ç¤ºä¸º"è¿›è¡Œä¸­"çŠ¶æ€
5. ä½†åç«¯æ•°æ®åº“çŠ¶æ€å·²æ›´æ–° âœ…
```

### æ ¹æœ¬åŸå› 

#### 1. ç¼“å­˜Keyæ¨¡å¼ä¸åŒ¹é… âŒ

**å®é™…çš„ç¼“å­˜Keyæ ¼å¼**:

```python
tasks:list:{project_id}:{status}:{assigned_to}:{skip}:{limit}:{include_completed_projects}
```

**é”™è¯¯çš„æ¸…é™¤æ¨¡å¼**:

```python
# åŸä»£ç 
self.delete_pattern(f"tasks:list:project:{project_id}:*")  # å¤šäº† "project:"ï¼ŒåŒ¹é…ä¸åˆ°ï¼
```

#### 2. æœªæ¸…é™¤ç”¨æˆ·ç›¸å…³çš„ç¼“å­˜ âŒ

åŸä»£ç åªæ¸…é™¤äº†æŒ‰é¡¹ç›®ç­›é€‰çš„ç¼“å­˜ï¼š

```python
cache_service.invalidate_tasks_cache(task.project_id)  # åªæ¸…é™¤é¡¹ç›®ç›¸å…³
```

ä½†æ˜¯ï¼Œæ ‡æ³¨å‘˜æŸ¥è¯¢"æˆ‘çš„å·¥ä½œå°"æ—¶ï¼Œä½¿ç”¨çš„ç¼“å­˜Keyæ˜¯ï¼š

```python
tasks:list:all:in_progress:user123:0:20:false  # æŒ‰ç”¨æˆ·IDç­›é€‰
```

**ç»“æœ**ï¼šæ ‡æ³¨å‘˜çš„ä»»åŠ¡åˆ—è¡¨ç¼“å­˜æ²¡æœ‰è¢«æ¸…é™¤ï¼Œå‰ç«¯æ˜¾ç¤ºæ—§æ•°æ®ï¼

#### 3. æœªæ¸…é™¤æŒ‰çŠ¶æ€ç­›é€‰çš„ç¼“å­˜ âŒ

ç®¡ç†å‘˜æŸ¥è¯¢"å¾…å®¡æ ¸ä»»åŠ¡"æ—¶ï¼Œä½¿ç”¨çš„ç¼“å­˜Keyæ˜¯ï¼š

```python
tasks:list:all:submitted:all:0:20:false  # æŒ‰çŠ¶æ€ç­›é€‰
```

å½“ä»»åŠ¡çŠ¶æ€ä» `submitted` å˜æˆ `approved` åï¼š

- é¡¹ç›®ç‰¹å®šçš„ç¼“å­˜åªæ¸…é™¤äº† `tasks:list:{project_id}:*`
- **ä½†æ²¡æœ‰æ¸…é™¤ `tasks:list:all:submitted:*`ï¼ˆè·¨é¡¹ç›®çš„å¾…å®¡æ ¸åˆ—è¡¨ï¼‰**

**ç»“æœ**ï¼šç®¡ç†å‘˜çš„"ä»»åŠ¡å®¡æ ¸"é¡µé¢æ²¡æœ‰åˆ·æ–°ï¼Œå·²å®¡æ ¸çš„ä»»åŠ¡ä»æ˜¾ç¤ºï¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. å¢å¼º `invalidate_tasks_cache` å‡½æ•°

**ä¿®æ”¹æ–‡ä»¶**: `backend/app/services/cache_service.py`

```python
def invalidate_tasks_cache(self, project_id: str = None, user_id: str = None):
    """
    æ¸…é™¤ä»»åŠ¡ç›¸å…³ç¼“å­˜

    Args:
        project_id: å¦‚æœæŒ‡å®šï¼Œåˆ™åªæ¸…é™¤è¯¥é¡¹ç›®çš„ä»»åŠ¡ç¼“å­˜
        user_id: å¦‚æœæŒ‡å®šï¼Œåˆ™æ¸…é™¤è¯¥ç”¨æˆ·ç›¸å…³çš„ä»»åŠ¡ç¼“å­˜
    """
    if project_id and user_id:
        # æ¸…é™¤ç‰¹å®šé¡¹ç›®å’Œç”¨æˆ·çš„ä»»åŠ¡ç¼“å­˜
        self.delete_pattern(f"tasks:list:{project_id}:*:{user_id}:*")
        self.delete_pattern(f"tasks:list:{project_id}:*:all:*")
        self.delete_pattern(f"tasks:list:all:*:{user_id}:*")
        logger.info(f"ğŸ—‘ï¸ ä»»åŠ¡ç¼“å­˜å·²æ¸…é™¤ (é¡¹ç›®: {project_id}, ç”¨æˆ·: {user_id})")
    elif project_id:
        # æ¸…é™¤ç‰¹å®šé¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜
        self.delete_pattern(f"tasks:list:{project_id}:*")
        logger.info(f"ğŸ—‘ï¸ ä»»åŠ¡ç¼“å­˜å·²æ¸…é™¤ (é¡¹ç›®: {project_id})")
    elif user_id:
        # æ¸…é™¤ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜
        self.delete_pattern(f"tasks:list:*:*:{user_id}:*")
        logger.info(f"ğŸ—‘ï¸ ä»»åŠ¡ç¼“å­˜å·²æ¸…é™¤ (ç”¨æˆ·: {user_id})")
    else:
        # æ¸…é™¤æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨ç¼“å­˜
        self.delete_pattern("tasks:list:*")
        logger.info("ğŸ—‘ï¸ æ‰€æœ‰ä»»åŠ¡ç¼“å­˜å·²æ¸…é™¤")
```

**å…³é”®æ”¹è¿›**ï¼š

- âœ… ä¿®å¤äº†ç¼“å­˜KeyåŒ¹é…æ¨¡å¼
- âœ… æ”¯æŒæŒ‰ç”¨æˆ·IDæ¸…é™¤ç¼“å­˜
- âœ… æ”¯æŒåŒæ—¶æŒ‡å®šé¡¹ç›®å’Œç”¨æˆ·

---

### 2. æ›´æ–°ä»»åŠ¡APIçš„ç¼“å­˜æ¸…é™¤é€»è¾‘ â­

**ä¿®æ”¹æ–‡ä»¶**: `backend/app/api/tasks.py`

**æ ¸å¿ƒç­–ç•¥**ï¼š**åŒé‡æ¸…é™¤** - ä»»ä½•ä»»åŠ¡çŠ¶æ€å˜åŒ–éƒ½åŒæ—¶æ¸…é™¤ï¼š

1. **ç‰¹å®šç”¨æˆ·**çš„ä»»åŠ¡ç¼“å­˜
2. **æ•´ä¸ªé¡¹ç›®**çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ï¼ˆä¸é™ç”¨æˆ·ï¼‰

#### 2.1 ä»»åŠ¡æäº¤æ—¶æ¸…é™¤ç¼“å­˜

```python
@router.post("/{task_id}/submit")
async def submit_task(...):
    # ... æäº¤é€»è¾‘ ...
    db.commit()

    # âœ… æ¸…é™¤ç¼“å­˜ï¼ˆé‡è¦ï¼šåŒé‡æ¸…é™¤ï¼‰
    # 1. æ¸…é™¤æäº¤è€…çš„ä»»åŠ¡ç¼“å­˜
    cache_service.invalidate_tasks_cache(task.project_id, current_user.id)
    # 2. æ¸…é™¤é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ï¼ˆåŒ…æ‹¬å®¡æ ¸å‘˜æŸ¥çœ‹çš„å¾…å®¡æ ¸åˆ—è¡¨ï¼‰
    cache_service.invalidate_tasks_cache(task.project_id)
    # 3. æ¸…é™¤ä»»åŠ¡è¯¦æƒ…
    cache_service.invalidate_task_detail_cache(task_id)
    # æ¸…é™¤ç»Ÿè®¡ç¼“å­˜
    stats_cache_service.invalidate_performance_stats(current_user.id)
    stats_cache_service.invalidate_dashboard_stats()
    stats_cache_service.invalidate_project_stats(task.project_id)

    logger.info(f"âœ… ä»»åŠ¡æäº¤ç¼“å­˜å·²æ¸…é™¤: project={task.project_id}, user={current_user.id}, å®¡æ ¸å‘˜è§†å›¾å·²åˆ·æ–°")
```

#### 2.2 ä»»åŠ¡å®¡æ ¸æ—¶æ¸…é™¤ç¼“å­˜ â­â­â­

```python
@router.post("/{task_id}/review")
async def review_task(...):
    # ... å®¡æ ¸é€»è¾‘ ...
    assigned_user_id = task.assigned_to  # æ ‡æ³¨å‘˜ID
    db.commit()

    # âœ… æ¸…é™¤ç¼“å­˜ï¼ˆé‡è¦ï¼šåŒé‡æ¸…é™¤ï¼‰
    # 1. æ¸…é™¤æ ‡æ³¨å‘˜çš„ä»»åŠ¡ç¼“å­˜
    cache_service.invalidate_tasks_cache(task.project_id, assigned_user_id)
    # 2. æ¸…é™¤é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜æŸ¥çœ‹çš„å¾…å®¡æ ¸åˆ—è¡¨ï¼‰
    cache_service.invalidate_tasks_cache(task.project_id)
    # 3. æ¸…é™¤ä»»åŠ¡è¯¦æƒ…
    cache_service.invalidate_task_detail_cache(task_id)
    cache_service.invalidate_project_detail_cache(task.project_id)
    # æ¸…é™¤ç»Ÿè®¡ç¼“å­˜
    stats_cache_service.invalidate_performance_stats(assigned_user_id)
    stats_cache_service.invalidate_performance_stats(current_user.id)
    stats_cache_service.invalidate_dashboard_stats()
    stats_cache_service.invalidate_project_stats(task.project_id)

    logger.info(f"âœ… ä»»åŠ¡å®¡æ ¸ç¼“å­˜å·²æ¸…é™¤: project={task.project_id}, user={assigned_user_id}, ç®¡ç†å‘˜è§†å›¾å·²åˆ·æ–°")
```

**å…³é”®ç‚¹**ï¼š

- ä½¿ç”¨ `assigned_user_id`ï¼ˆæ ‡æ³¨å‘˜ï¼‰æ¸…é™¤æ ‡æ³¨å‘˜çš„ç¼“å­˜
- å†æ¬¡è°ƒç”¨ `invalidate_tasks_cache(project_id)` æ¸…é™¤ç®¡ç†å‘˜çš„ç¼“å­˜

#### 2.3 å…¶ä»–æ‰€æœ‰ä»»åŠ¡æ“ä½œéƒ½é‡‡ç”¨åŒé‡æ¸…é™¤

- âœ… **é¢†å–ä»»åŠ¡** (`claim_task`) - åŒé‡æ¸…é™¤ï¼ˆé¢†å–è€… + é¡¹ç›®ï¼‰
- âœ… **æ”¾å¼ƒä»»åŠ¡** (`abandon_task`) - åŒé‡æ¸…é™¤ï¼ˆæ”¾å¼ƒè€… + é¡¹ç›®ï¼‰
- âœ… **é‡å¯ä»»åŠ¡** (`restart_task`) - åŒé‡æ¸…é™¤ï¼ˆé‡å¯è€… + é¡¹ç›®ï¼‰
- âœ… **ç”³è¯·è·³è¿‡** (`request_skip_task`) - åŒé‡æ¸…é™¤ï¼ˆç”³è¯·è€… + é¡¹ç›®ï¼‰
- âœ… **å®¡æ ¸è·³è¿‡** (`review_skip_request`) - åŒé‡æ¸…é™¤ï¼ˆæ ‡æ³¨å‘˜ + é¡¹ç›®ï¼‰
- âœ… **ç›´æ¥è·³è¿‡** (`skip_task`) - æ¸…é™¤é¡¹ç›®ç¼“å­˜

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ âŒ

#### åœºæ™¯1ï¼šæ ‡æ³¨å‘˜è§†è§’

```
æ ‡æ³¨å‘˜æäº¤ä»»åŠ¡ â†’ ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
   â†“
æ ‡æ³¨å‘˜åˆ·æ–°é¡µé¢
   â†“
ç¼“å­˜å‘½ä¸­ï¼ˆæ—§æ•°æ®ï¼‰
   â†“
ä»»åŠ¡ä»æ˜¾ç¤º"è¿›è¡Œä¸­" âŒ
```

#### åœºæ™¯2ï¼šç®¡ç†å‘˜è§†è§’

```
ç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡
   â†“
ç®¡ç†å‘˜åˆ·æ–°"ä»»åŠ¡å®¡æ ¸"é¡µé¢
   â†“
ç¼“å­˜å‘½ä¸­ï¼ˆæ—§æ•°æ®ï¼‰
   â†“
ä»»åŠ¡ä»æ˜¾ç¤ºåœ¨"å¾…å®¡æ ¸"åˆ—è¡¨ âŒ
```

### ä¿®å¤å âœ…

#### åœºæ™¯1ï¼šæ ‡æ³¨å‘˜è§†è§’

```
æ ‡æ³¨å‘˜æäº¤ä»»åŠ¡ â†’ ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡
   â†“
åŒé‡æ¸…é™¤ï¼š
  1. æ¸…é™¤æ ‡æ³¨å‘˜çš„ä»»åŠ¡ç¼“å­˜ âœ…
  2. æ¸…é™¤é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ âœ…
   â†“
æ ‡æ³¨å‘˜åˆ·æ–°é¡µé¢
   â†“
ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“
   â†“
ä»»åŠ¡æ˜¾ç¤º"å·²é€šè¿‡" âœ…
```

#### åœºæ™¯2ï¼šç®¡ç†å‘˜è§†è§’

```
ç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡
   â†“
åŒé‡æ¸…é™¤ï¼š
  1. æ¸…é™¤æ ‡æ³¨å‘˜çš„ä»»åŠ¡ç¼“å­˜ âœ…
  2. æ¸…é™¤é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ âœ…
     ï¼ˆåŒ…æ‹¬ tasks:list:all:submitted:* ç­‰ï¼‰
   â†“
ç®¡ç†å‘˜åˆ·æ–°"ä»»åŠ¡å®¡æ ¸"é¡µé¢
   â†“
ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“
   â†“
ä»»åŠ¡ä¸å†æ˜¾ç¤ºåœ¨"å¾…å®¡æ ¸"åˆ—è¡¨ âœ…
```

---

## ğŸ“Š ç¼“å­˜æ¸…é™¤ç­–ç•¥å¯¹æ¯”

### ä¿®å¤å‰

| æ“ä½œ     | æ¸…é™¤çš„ç¼“å­˜     | é—®é¢˜                                                         |
| -------- | -------------- | ------------------------------------------------------------ |
| æäº¤ä»»åŠ¡ | ä»…é¡¹ç›®ä»»åŠ¡åˆ—è¡¨ | âŒ æ ‡æ³¨å‘˜çš„"æˆ‘çš„ä»»åŠ¡"æœªæ¸…é™¤<br>âŒ å®¡æ ¸å‘˜çš„"å¾…å®¡æ ¸"åˆ—è¡¨æœªæ¸…é™¤ |
| å®¡æ ¸ä»»åŠ¡ | ä»…é¡¹ç›®ä»»åŠ¡åˆ—è¡¨ | âŒ æ ‡æ³¨å‘˜çš„"æˆ‘çš„ä»»åŠ¡"æœªæ¸…é™¤<br>âŒ ç®¡ç†å‘˜çš„"å¾…å®¡æ ¸"åˆ—è¡¨æœªæ¸…é™¤ |
| é¢†å–ä»»åŠ¡ | ä»…é¡¹ç›®ä»»åŠ¡åˆ—è¡¨ | âŒ é¢†å–è€…çš„"æˆ‘çš„ä»»åŠ¡"æœªæ¸…é™¤<br>âŒ ä»»åŠ¡æ± æœªåˆ·æ–°               |

### ä¿®å¤åï¼ˆåŒé‡æ¸…é™¤ç­–ç•¥ï¼‰

| æ“ä½œ     | æ¸…é™¤çš„ç¼“å­˜                                   | æ•ˆæœ                                   |
| -------- | -------------------------------------------- | -------------------------------------- |
| æäº¤ä»»åŠ¡ | 1. æäº¤è€…çš„ä»»åŠ¡ç¼“å­˜<br>2. é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ | âœ… æ ‡æ³¨å‘˜è§†å›¾åŒæ­¥<br>âœ… å®¡æ ¸å‘˜è§†å›¾åŒæ­¥ |
| å®¡æ ¸ä»»åŠ¡ | 1. æ ‡æ³¨å‘˜çš„ä»»åŠ¡ç¼“å­˜<br>2. é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ | âœ… æ ‡æ³¨å‘˜è§†å›¾åŒæ­¥<br>âœ… ç®¡ç†å‘˜è§†å›¾åŒæ­¥ |
| é¢†å–ä»»åŠ¡ | 1. é¢†å–è€…çš„ä»»åŠ¡ç¼“å­˜<br>2. é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ | âœ… é¢†å–è€…è§†å›¾åŒæ­¥<br>âœ… ä»»åŠ¡æ± åˆ·æ–°     |
| æ”¾å¼ƒä»»åŠ¡ | 1. æ”¾å¼ƒè€…çš„ä»»åŠ¡ç¼“å­˜<br>2. é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ | âœ… æ”¾å¼ƒè€…è§†å›¾åŒæ­¥<br>âœ… ä»»åŠ¡æ± åˆ·æ–°     |
| ç”³è¯·è·³è¿‡ | 1. ç”³è¯·è€…çš„ä»»åŠ¡ç¼“å­˜<br>2. é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ | âœ… ç”³è¯·è€…è§†å›¾åŒæ­¥<br>âœ… å®¡æ ¸é¡µé¢åˆ·æ–°   |
| å®¡æ ¸è·³è¿‡ | 1. æ ‡æ³¨å‘˜çš„ä»»åŠ¡ç¼“å­˜<br>2. é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ | âœ… æ ‡æ³¨å‘˜è§†å›¾åŒæ­¥<br>âœ… å®¡æ ¸é¡µé¢åˆ·æ–°   |

---

## ğŸ” ç¼“å­˜æ¸…é™¤èŒƒå›´è¯¦è§£

### åœºæ™¯ï¼šç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡

```python
# ä»»åŠ¡ä¿¡æ¯
task.project_id = "proj1"
task.assigned_to = "user123"  # æ ‡æ³¨å‘˜
current_user.id = "admin1"    # å®¡æ ¸å‘˜
task.status: "submitted" -> "approved"

# ç¬¬1æ¬¡æ¸…é™¤ï¼šæ ‡æ³¨å‘˜çš„ä»»åŠ¡ç¼“å­˜
cache_service.invalidate_tasks_cache("proj1", "user123")
æ¸…é™¤æ¨¡å¼ï¼š
  - tasks:list:proj1:*:user123:*     â† é¡¹ç›®1 + æ ‡æ³¨å‘˜çš„ä»»åŠ¡
  - tasks:list:proj1:*:all:*         â† é¡¹ç›®1çš„æ‰€æœ‰ä»»åŠ¡
  - tasks:list:all:*:user123:*       â† æ ‡æ³¨å‘˜çš„æ‰€æœ‰ä»»åŠ¡

# ç¬¬2æ¬¡æ¸…é™¤ï¼šé¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜
cache_service.invalidate_tasks_cache("proj1")
æ¸…é™¤æ¨¡å¼ï¼š
  - tasks:list:proj1:*               â† é¡¹ç›®1çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜æŸ¥çœ‹çš„ï¼‰
  è¿™åŒ…æ‹¬ï¼š
    â€¢ tasks:list:proj1:submitted:all:0:20:false  â† ç®¡ç†å‘˜çš„"å¾…å®¡æ ¸"åˆ—è¡¨
    â€¢ tasks:list:proj1:approved:all:0:20:false   â† ç®¡ç†å‘˜çš„"å·²é€šè¿‡"åˆ—è¡¨
    â€¢ tasks:list:proj1:in_progress:*             â† ä»»ä½•"è¿›è¡Œä¸­"ç­›é€‰
    â€¢ ... æ‰€æœ‰ä¸é¡¹ç›®ç›¸å…³çš„ç¼“å­˜

# å…¶ä»–æ¸…é™¤
3. tasks:detail:task456              â† ä»»åŠ¡è¯¦æƒ…
4. projects:detail:proj1             â† é¡¹ç›®è¯¦æƒ…
5. stats:performance:user:user123    â† æ ‡æ³¨å‘˜ç»©æ•ˆç»Ÿè®¡
6. stats:dashboard:general           â† ä»ªè¡¨æ¿ç»Ÿè®¡
7. stats:project:proj1               â† é¡¹ç›®ç»Ÿè®¡
```

**ç»“æœ**ï¼š

- âœ… æ ‡æ³¨å‘˜çš„ä»»åŠ¡åˆ—è¡¨å®Œå…¨åˆ·æ–°
- âœ… ç®¡ç†å‘˜çš„"å¾…å®¡æ ¸"åˆ—è¡¨å®Œå…¨åˆ·æ–°
- âœ… ç®¡ç†å‘˜çš„"å·²é€šè¿‡"åˆ—è¡¨å®Œå…¨åˆ·æ–°
- âœ… ä»»åŠ¡æ± ã€é¡¹ç›®è¯¦æƒ…ç­‰æ‰€æœ‰ç›¸å…³è§†å›¾éƒ½ä¼šåˆ·æ–°

---

## âœ… éªŒè¯æ–¹æ³•

### 1. æŸ¥çœ‹æ—¥å¿—

å®¡æ ¸ä»»åŠ¡åï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
âœ… [TaskAPI] ä»»åŠ¡çŠ¶æ€æ›´æ–°: task456 submitted -> approved
âœ… [TaskAPI] ä»»åŠ¡å®¡æ ¸ç¼“å­˜å·²æ¸…é™¤: project=proj1, user=user123
ğŸ—‘ï¸ ä»»åŠ¡ç¼“å­˜å·²æ¸…é™¤ (é¡¹ç›®: proj1, ç”¨æˆ·: user123)
ğŸ—‘ï¸ åˆ é™¤ç¼“å­˜: 3 ä¸ªkey
```

### 2. æ‰‹åŠ¨æµ‹è¯•

```
æ­¥éª¤ï¼š
1. æ ‡æ³¨å‘˜ç™»å½•ï¼Œé¢†å–ä»»åŠ¡
2. æ ‡æ³¨å‘˜æäº¤ä»»åŠ¡
3. ç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡ï¼ˆé€šè¿‡/é©³å›ï¼‰
4. æ ‡æ³¨å‘˜åˆ·æ–°"æˆ‘çš„å·¥ä½œå°"é¡µé¢
5. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°
```

**é¢„æœŸç»“æœ**ï¼šä»»åŠ¡çŠ¶æ€ç«‹å³æ›´æ–°ä¸º"å·²é€šè¿‡"æˆ–"å·²é©³å›" âœ…

### 3. Redisç›‘æ§

```bash
cd backend
python scripts/redis_monitor.py
```

æŸ¥çœ‹ï¼š

- Keyæ•°é‡å˜åŒ–
- åˆ é™¤æ“ä½œæ¬¡æ•°
- ç¼“å­˜å‘½ä¸­ç‡

### 4. å‰ç«¯Networkç›‘æ§

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼š

```
1. å®¡æ ¸ä»»åŠ¡å
2. æŸ¥çœ‹ Network â†’ XHR
3. æ‰¾åˆ° /api/tasks/ è¯·æ±‚
4. æŸ¥çœ‹å“åº”æ—¶é—´

ç¬¬1æ¬¡åˆ·æ–°ï¼šè¾ƒæ…¢ï¼ˆç¼“å­˜missï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼‰
ç¬¬2æ¬¡åˆ·æ–°ï¼šå¾ˆå¿«ï¼ˆç¼“å­˜hitï¼‰
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

```
backend/app/services/
â”œâ”€â”€ cache_service.py           # ä¿®æ”¹ invalidate_tasks_cache å‡½æ•°

backend/app/api/
â””â”€â”€ tasks.py                   # æ›´æ–°æ‰€æœ‰ä»»åŠ¡æ“ä½œçš„ç¼“å­˜æ¸…é™¤é€»è¾‘
    â”œâ”€â”€ submit_task()          # æäº¤ä»»åŠ¡
    â”œâ”€â”€ review_task()          # å®¡æ ¸ä»»åŠ¡ â­ å…³é”®ä¿®å¤
    â”œâ”€â”€ claim_task()           # é¢†å–ä»»åŠ¡
    â”œâ”€â”€ abandon_task()         # æ”¾å¼ƒä»»åŠ¡
    â”œâ”€â”€ restart_task()         # é‡å¯ä»»åŠ¡
    â””â”€â”€ review_skip_request()  # è·³è¿‡å®¡æ ¸
```

### æ–‡æ¡£

```
CACHE_INVALIDATION_FIX.md      # æœ¬æ–‡æ¡£
```

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. ç¼“å­˜Keyè®¾è®¡è¦æ¸…æ™°

```python
# âŒ é”™è¯¯ï¼šæ¨¡ç³Šçš„Keyæ ¼å¼
tasks:cache:user123

# âœ… æ­£ç¡®ï¼šæ˜ç¡®çš„å±‚æ¬¡ç»“æ„
tasks:list:{project}:{status}:{user}:{page}:{size}
```

### 2. ç¼“å­˜æ¸…é™¤è¦å…¨é¢

```python
# âŒ é”™è¯¯ï¼šåªæ¸…é™¤ä¸€éƒ¨åˆ†
cache_service.invalidate_tasks_cache(project_id)

# âœ… æ­£ç¡®ï¼šæ¸…é™¤æ‰€æœ‰ç›¸å…³çš„
cache_service.invalidate_tasks_cache(project_id, user_id)
```

### 3. æ—¥å¿—è¦è¯¦ç»†

```python
# âŒ é”™è¯¯ï¼šç®€å•æ—¥å¿—
logger.info("ç¼“å­˜å·²æ¸…é™¤")

# âœ… æ­£ç¡®ï¼šè¯¦ç»†æ—¥å¿—
logger.info(f"âœ… ä»»åŠ¡å®¡æ ¸ç¼“å­˜å·²æ¸…é™¤: project={project_id}, user={user_id}")
```

### 4. æµ‹è¯•è¦å……åˆ†

- âœ… å•å…ƒæµ‹è¯•ï¼šæµ‹è¯•ç¼“å­˜å‡½æ•°
- âœ… é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å®Œæ•´æµç¨‹
- âœ… æ‰‹åŠ¨æµ‹è¯•ï¼šå®é™…æ“ä½œéªŒè¯
- âœ… æ—¥å¿—ç›‘æ§ï¼šå®æ—¶è§‚å¯Ÿ

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜é¢„çƒ­

```python
# ç”¨æˆ·ç™»å½•åï¼Œé¢„çƒ­å¸¸ç”¨ç¼“å­˜
def warm_up_user_cache(user_id):
    # é¢„åŠ è½½ç”¨æˆ·çš„ä»»åŠ¡åˆ—è¡¨
    get_tasks(assigned_to=user_id, status='in_progress')
    # é¢„åŠ è½½ç”¨æˆ·çš„ç»©æ•ˆç»Ÿè®¡
    get_performance_stats(user_id)
```

### 2. ç¼“å­˜ç‰ˆæœ¬æ§åˆ¶

```python
# æ·»åŠ ç‰ˆæœ¬å·ï¼Œå¼ºåˆ¶åˆ·æ–°
cache_key = f"tasks:list:v2:{project}:{status}:{user}:{page}"
```

### 3. ç›‘æ§å‘Šè­¦

```python
# ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
if cache_hit_rate < 0.7:
    alert("ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½")
```

### 4. è‡ªåŠ¨æµ‹è¯•

```python
# æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•
def test_task_review_cache_invalidation():
    # 1. æäº¤ä»»åŠ¡
    # 2. å®¡æ ¸ä»»åŠ¡
    # 3. éªŒè¯æ ‡æ³¨å‘˜çš„ç¼“å­˜å·²æ¸…é™¤
    assert not cache_exists(f"tasks:list:*:*:{annotator_id}:*")
```

---

## âœ… æ€»ç»“

### é—®é¢˜æ ¹æº

- âŒ ç¼“å­˜Keyæ¨¡å¼åŒ¹é…é”™è¯¯ï¼ˆ`tasks:list:project:{id}:*` vs `tasks:list:{id}:*`ï¼‰
- âŒ æœªæ¸…é™¤ç”¨æˆ·ç»´åº¦çš„ç¼“å­˜ï¼ˆæ ‡æ³¨å‘˜ã€é¢†å–è€…ç­‰ï¼‰
- âŒ æœªæ¸…é™¤æŒ‰çŠ¶æ€ç­›é€‰çš„ç¼“å­˜ï¼ˆç®¡ç†å‘˜çš„"å¾…å®¡æ ¸"åˆ—è¡¨ï¼‰
- âŒ ç¼“å­˜æ¸…é™¤èŒƒå›´ä¸å¤Ÿå…¨é¢ï¼ˆåªæ¸…é™¤ä¸€æ¬¡ï¼‰

### ä¿®å¤æ–¹æ¡ˆï¼ˆåŒé‡æ¸…é™¤ç­–ç•¥ï¼‰

- âœ… ä¿®æ­£ç¼“å­˜KeyåŒ¹é…æ¨¡å¼
- âœ… æ”¯æŒæŒ‰ç”¨æˆ·IDæ¸…é™¤ç¼“å­˜
- âœ… **åŒé‡æ¸…é™¤**ï¼šæ¯æ¬¡ä»»åŠ¡çŠ¶æ€å˜åŒ–éƒ½æ¸…é™¤ï¼š
  1. ç‰¹å®šç”¨æˆ·çš„ä»»åŠ¡ç¼“å­˜
  2. æ•´ä¸ªé¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜
- âœ… è¦†ç›–æ‰€æœ‰ä»»åŠ¡æ“ä½œï¼ˆæäº¤ã€å®¡æ ¸ã€é¢†å–ã€æ”¾å¼ƒã€é‡å¯ã€è·³è¿‡ç­‰ï¼‰

### ä¿®å¤æ•ˆæœ

- âœ… æ ‡æ³¨å‘˜è§†å›¾å®æ—¶åŒæ­¥
- âœ… ç®¡ç†å‘˜è§†å›¾å®æ—¶åŒæ­¥
- âœ… å®¡æ ¸å‘˜è§†å›¾å®æ—¶åŒæ­¥
- âœ… ä»»åŠ¡æ± å®æ—¶åˆ·æ–°
- âœ… å‰ç«¯æ•°æ®ä¸æ•°æ®åº“å®Œå…¨ä¸€è‡´
- âœ… æ‰€æœ‰è§’è‰²çš„ç”¨æˆ·ä½“éªŒéƒ½å¾—åˆ°æå‡

---

**ğŸ‰ é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼ç³»ç»Ÿç¼“å­˜æœºåˆ¶æ›´åŠ å¥å£®ï¼**
