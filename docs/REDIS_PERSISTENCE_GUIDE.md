# ğŸ”’ RedisæŒä¹…åŒ–å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–](#ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–)
2. [RDBæŒä¹…åŒ–](#rdbæŒä¹…åŒ–)
3. [AOFæŒä¹…åŒ–](#aofæŒä¹…åŒ–)
4. [æ··åˆæŒä¹…åŒ–](#æ··åˆæŒä¹…åŒ–)
5. [é…ç½®å»ºè®®](#é…ç½®å»ºè®®)
6. [æ•…éšœæ¢å¤](#æ•…éšœæ¢å¤)

---

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–

### ç¼“å­˜åœºæ™¯ä¸‹çš„é£é™©

å³ä½¿æ˜¯ç¼“å­˜ç³»ç»Ÿï¼Œä¹Ÿéœ€è¦æŒä¹…åŒ–ï¼š

âŒ **ä¸æŒä¹…åŒ–çš„é—®é¢˜**ï¼š

- Redisé‡å¯ â†’ æ‰€æœ‰ç¼“å­˜ä¸¢å¤±
- æœåŠ¡å™¨æ–­ç”µ â†’ æ•°æ®å…¨éƒ¨ä¸¢å¤±
- åº”ç”¨é‡å¯å â†’ å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ï¼ˆç¼“å­˜é›ªå´©ï¼‰

âœ… **æŒä¹…åŒ–çš„å¥½å¤„**ï¼š

- ä¿æŠ¤çƒ­ç‚¹æ•°æ®
- å¿«é€Ÿæ¢å¤æœåŠ¡
- é¿å…ç¼“å­˜é›ªå´©

---

## ğŸ’¾ RDBæŒä¹…åŒ–ï¼ˆå¿«ç…§ï¼‰

### å·¥ä½œåŸç†

**å®šæœŸå°†å†…å­˜ä¸­çš„æ•°æ®å¿«ç…§ä¿å­˜åˆ°ç£ç›˜**

```
å†…å­˜æ•°æ®
  â†“ (è§¦å‘æ¡ä»¶)
forkå­è¿›ç¨‹
  â†“
å†™å…¥ä¸´æ—¶RDBæ–‡ä»¶
  â†“
æ›¿æ¢æ—§RDBæ–‡ä»¶
  â†“
dump.rdb (ç£ç›˜)
```

### é…ç½®ç¤ºä¾‹

```bash
# redis.conf

# ========== è§¦å‘æ¡ä»¶ ==========
save 900 1      # 15åˆ†é’Ÿå†…è‡³å°‘1ä¸ªkeyå˜åŒ–
save 300 10     # 5åˆ†é’Ÿå†…è‡³å°‘10ä¸ªkeyå˜åŒ–
save 60 10000   # 1åˆ†é’Ÿå†…è‡³å°‘10000ä¸ªkeyå˜åŒ–

# å¦‚æœä¸æƒ³è‡ªåŠ¨ä¿å­˜ï¼Œæ³¨é‡Šæ‰æ‰€æœ‰saveè¡Œ
# save ""

# ========== æ–‡ä»¶é…ç½® ==========
dbfilename dump.rdb        # RDBæ–‡ä»¶å
dir ./                     # ä¿å­˜è·¯å¾„

# ========== å‹ç¼©å’Œæ ¡éªŒ ==========
rdbcompression yes         # å¯ç”¨å‹ç¼©ï¼ˆæ¨èï¼‰
rdbchecksum yes           # å¯ç”¨æ ¡éªŒï¼ˆæ¨èï¼‰

# ========== é”™è¯¯å¤„ç† ==========
stop-writes-on-bgsave-error yes  # ä¿å­˜å¤±è´¥æ—¶åœæ­¢å†™å…¥
```

### æ‰‹åŠ¨è§¦å‘

```bash
# 1. SAVE - é˜»å¡å¼ä¿å­˜ï¼ˆä¸æ¨èï¼‰
redis-cli SAVE

# 2. BGSAVE - åå°ä¿å­˜ï¼ˆæ¨èï¼‰
redis-cli BGSAVE

# 3. æŸ¥çœ‹æœ€åä¿å­˜æ—¶é—´
redis-cli LASTSAVE
```

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹                | ç¼ºç‚¹                                |
| ------------------- | ----------------------------------- |
| âœ… æ–‡ä»¶ç´§å‡‘ï¼Œä½“ç§¯å° | âš ï¸ å¯èƒ½ä¸¢å¤±æ•°æ®ï¼ˆæœ€åå¿«ç…§åçš„å˜æ›´ï¼‰ |
| âœ… æ¢å¤é€Ÿåº¦å¿«       | âš ï¸ forkå­è¿›ç¨‹æ¶ˆè€—å†…å­˜               |
| âœ… å¯¹æ€§èƒ½å½±å“å°     | âš ï¸ ä¸é€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯         |

### é€‚ç”¨åœºæ™¯

- âœ… å¯¹æ•°æ®ä¸¢å¤±ä¸æ•æ„Ÿï¼ˆç¼“å­˜åœºæ™¯ï¼‰
- âœ… éœ€è¦å®šæœŸå¤‡ä»½
- âœ… è¿½æ±‚é«˜æ€§èƒ½

---

## ğŸ“ AOFæŒä¹…åŒ–ï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰

### å·¥ä½œåŸç†

**è®°å½•æ¯ä¸€ä¸ªå†™æ“ä½œå‘½ä»¤**

```
å®¢æˆ·ç«¯å†™å‘½ä»¤
  â†“
Redisæ‰§è¡Œ
  â†“
è¿½åŠ åˆ°AOFç¼“å†²åŒº
  â†“ (æ ¹æ®ç­–ç•¥)
åŒæ­¥åˆ°ç£ç›˜
  â†“
appendonly.aof (ç£ç›˜)
```

### é…ç½®ç¤ºä¾‹

```bash
# redis.conf

# ========== å¯ç”¨AOF ==========
appendonly yes
appendfilename "appendonly.aof"

# ========== åŒæ­¥ç­–ç•¥ ========== (é‡è¦ï¼)
# é€‰é¡¹1ï¼šæ¯æ¬¡å†™å…¥éƒ½åŒæ­¥ï¼ˆæœ€å®‰å…¨ï¼Œä½†æ…¢ï¼‰
appendfsync always

# é€‰é¡¹2ï¼šæ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼ˆæ¨èï¼‰â­
appendfsync everysec

# é€‰é¡¹3ï¼šç”±æ“ä½œç³»ç»Ÿå†³å®šï¼ˆå¿«ä½†ä¸å®‰å…¨ï¼‰
appendfsync no

# ========== AOFé‡å†™ ==========
# å½“AOFæ–‡ä»¶å¢é•¿100%æ—¶è‡ªåŠ¨é‡å†™
auto-aof-rewrite-percentage 100

# æ–‡ä»¶è‡³å°‘64MBæ—¶æ‰é‡å†™
auto-aof-rewrite-min-size 64mb

# é‡å†™æœŸé—´æ˜¯å¦åŒæ­¥ï¼ˆå¯èƒ½å¯¼è‡´å»¶è¿Ÿï¼‰
no-appendfsync-on-rewrite no

# ========== åŠ è½½æ—¶é”™è¯¯å¤„ç† ==========
# å¿½ç•¥AOFæ–‡ä»¶æœ€åçš„ä¸å®Œæ•´å‘½ä»¤
aof-load-truncated yes
```

### æ‰‹åŠ¨è§¦å‘é‡å†™

```bash
# æ‰‹åŠ¨è§¦å‘AOFé‡å†™
redis-cli BGREWRITEAOF

# æŸ¥çœ‹AOFé‡å†™çŠ¶æ€
redis-cli INFO persistence | grep aof
```

### AOFé‡å†™åŸç†

**é—®é¢˜**ï¼šAOFæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§

**è§£å†³**ï¼šå®šæœŸé‡å†™ï¼Œåˆå¹¶å‘½ä»¤

```bash
# åŸå§‹AOFï¼ˆå†—ä½™ï¼‰
SET key1 "a"
SET key1 "b"
SET key1 "c"
DEL key2
SET key2 "x"

# é‡å†™åAOFï¼ˆç²¾ç®€ï¼‰
SET key1 "c"
SET key2 "x"
```

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹                         | ç¼ºç‚¹            |
| ---------------------------- | --------------- |
| âœ… æ•°æ®æ›´å®‰å…¨ï¼ˆæœ€å¤šä¸¢å¤±1ç§’ï¼‰ | âš ï¸ æ–‡ä»¶ä½“ç§¯å¤§   |
| âœ… å¯è¯»æ€§å¼ºï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰      | âš ï¸ æ¢å¤é€Ÿåº¦æ…¢   |
| âœ… æ”¯æŒåœ¨çº¿é‡å†™              | âš ï¸ å¯¹æ€§èƒ½æœ‰å½±å“ |

### é€‚ç”¨åœºæ™¯

- âœ… ä¸èƒ½å®¹å¿æ•°æ®ä¸¢å¤±
- âœ… éœ€è¦å®¡è®¡æ—¥å¿—
- âœ… å¯ä»¥æ¥å—æ€§èƒ½æŸè€—

---

## ğŸ¨ æ··åˆæŒä¹…åŒ–ï¼ˆæ¨èï¼‰â­

### Redis 4.0+ æ–°ç‰¹æ€§

**ç»“åˆRDBå’ŒAOFçš„ä¼˜ç‚¹**

### å·¥ä½œåŸç†

```
è§¦å‘AOFé‡å†™
  â†“
å‰åŠéƒ¨åˆ†ï¼šRDBå¿«ç…§ï¼ˆå…¨é‡æ•°æ®ï¼‰
  â†“
ååŠéƒ¨åˆ†ï¼šAOFå¢é‡å‘½ä»¤
  â†“
appendonly.aofï¼ˆæ··åˆæ ¼å¼ï¼‰
```

### é…ç½®ç¤ºä¾‹

```bash
# redis.conf

# ========== å¯ç”¨æ··åˆæŒä¹…åŒ– ========== â­
aof-use-rdb-preamble yes

# ========== åŸºç¡€é…ç½® ==========
appendonly yes
appendfsync everysec

# ========== RDBé…ç½® ==========
save 900 1
save 300 10
save 60 10000

# ========== AOFé‡å†™é…ç½® ==========
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

### æ–‡ä»¶ç»“æ„

```
+------------------+
| REDIS0009       | â† RDBæ ¼å¼å¤´
|                 |
| [RDBå…¨é‡æ•°æ®]   | â† å¿«é€Ÿæ¢å¤
|                 |
+------------------+
| SET key "value" | â† AOFå¢é‡å‘½ä»¤
| INCR counter    |
| ...             | â† æœ€æ–°å˜æ›´
+------------------+
```

### ä¼˜åŠ¿å¯¹æ¯”

| ç­–ç•¥       | æ¢å¤é€Ÿåº¦  | æ•°æ®å®‰å…¨æ€§ | æ–‡ä»¶å¤§å° | æ¨èåº¦     |
| ---------- | --------- | ---------- | -------- | ---------- |
| ä»…RDB      | âš¡âš¡âš¡ å¿« | âš ï¸ ä¸€èˆ¬    | ğŸ“¦ å°    | â­â­       |
| ä»…AOF      | ğŸŒ æ…¢     | âœ… é«˜      | ğŸ“¦ğŸ“¦ å¤§  | â­â­â­     |
| æ··åˆæŒä¹…åŒ– | âš¡âš¡ è¾ƒå¿« | âœ… é«˜      | ğŸ“¦ ä¸­ç­‰  | â­â­â­â­â­ |

---

## âš™ï¸ é…ç½®å»ºè®®

### å¼€å‘ç¯å¢ƒ

```bash
# å¼€å‘ç¯å¢ƒï¼šå…³é—­æŒä¹…åŒ–ï¼ˆè¿½æ±‚æ€§èƒ½ï¼‰
appendonly no
save ""
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆç¼“å­˜åœºæ™¯ï¼‰â­

```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

# ========== æ··åˆæŒä¹…åŒ– ==========
appendonly yes
aof-use-rdb-preamble yes

# ========== åŒæ­¥ç­–ç•¥ ==========
appendfsync everysec  # æœ€å¤šä¸¢å¤±1ç§’æ•°æ®

# ========== RDBå¿«ç…§ ==========
save 900 1      # 15åˆ†é’Ÿå¤‡ä»½ä¸€æ¬¡
save 300 10     # 5åˆ†é’Ÿæ´»è·ƒæ—¶å¤‡ä»½
save 60 10000   # 1åˆ†é’Ÿé«˜æ´»è·ƒæ—¶å¤‡ä»½

# ========== AOFé‡å†™ ==========
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ========== å†…å­˜ä¼˜åŒ– ==========
maxmemory 2gb
maxmemory-policy allkeys-lru  # LRUæ·˜æ±°ç­–ç•¥

# ========== æ–‡ä»¶è·¯å¾„ ==========
dir /var/lib/redis
dbfilename dump.rdb
appendfilename "appendonly.aof"

# ========== æ—¥å¿— ==========
logfile /var/log/redis/redis-server.log
loglevel notice
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆæ•°æ®åº“åœºæ™¯ï¼‰

```bash
# æ•°æ®é‡è¦æ€§é«˜ï¼Œè¿½æ±‚æ•°æ®å®‰å…¨

appendonly yes
aof-use-rdb-preamble yes
appendfsync always  # æ¯æ¬¡éƒ½åŒæ­¥ï¼Œæœ€å®‰å…¨

save 900 1
save 300 10
save 60 10000

maxmemory-policy noeviction  # ä¸æ·˜æ±°æ•°æ®
```

---

## ğŸ”§ æ•…éšœæ¢å¤

### åœºæ™¯1ï¼šRedisæ­£å¸¸é‡å¯

```bash
# Redisä¼šè‡ªåŠ¨åŠ è½½æŒä¹…åŒ–æ–‡ä»¶
# ä¼˜å…ˆçº§ï¼šAOF > RDB

# 1. æ£€æŸ¥æ–‡ä»¶
ls -lh /var/lib/redis/
# dump.rdb
# appendonly.aof

# 2. å¯åŠ¨Redis
redis-server /etc/redis/redis.conf

# 3. æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/redis/redis-server.log
# DB loaded from append only file: 0.123 seconds
```

### åœºæ™¯2ï¼šAOFæ–‡ä»¶æŸå

```bash
# 1. æ£€æŸ¥AOFæ–‡ä»¶
redis-check-aof appendonly.aof
# AOF analyzed: filename=appendonly.aof, ok
# æˆ–
# Bad file format reading the append only file

# 2. ä¿®å¤AOFæ–‡ä»¶ï¼ˆä¼šæˆªæ–­æŸåéƒ¨åˆ†ï¼‰
redis-check-aof --fix appendonly.aof
# Successfully truncated AOF

# 3. é‡å¯Redis
redis-server /etc/redis/redis.conf
```

### åœºæ™¯3ï¼šRDBæ–‡ä»¶æŸå

```bash
# 1. æ£€æŸ¥RDBæ–‡ä»¶
redis-check-rdb dump.rdb

# 2. å¦‚æœæŸåä¸”æ— æ³•ä¿®å¤
# åˆ é™¤RDBï¼Œä½¿ç”¨AOFæ¢å¤
rm dump.rdb
redis-server /etc/redis/redis.conf
```

### åœºæ™¯4ï¼šåŒæ—¶å¯ç”¨äº†RDBå’ŒAOF

```bash
# RedisåŠ è½½ä¼˜å…ˆçº§ï¼š
# 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨AOFæ–‡ä»¶
#    å­˜åœ¨ â†’ åŠ è½½AOF âœ…
#    ä¸å­˜åœ¨ â†’ ç»§ç»­æ£€æŸ¥RDB
# 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨RDBæ–‡ä»¶
#    å­˜åœ¨ â†’ åŠ è½½RDB
#    ä¸å­˜åœ¨ â†’ å¯åŠ¨ç©ºå®ä¾‹
```

---

## ğŸ“Š ç›‘æ§æŒä¹…åŒ–çŠ¶æ€

### æŸ¥çœ‹æŒä¹…åŒ–ä¿¡æ¯

```bash
# è¿æ¥Redis
redis-cli

# æŸ¥çœ‹æŒä¹…åŒ–é…ç½®
127.0.0.1:6379> CONFIG GET save
127.0.0.1:6379> CONFIG GET appendonly

# æŸ¥çœ‹æŒä¹…åŒ–ç»Ÿè®¡
127.0.0.1:6379> INFO persistence
```

**é‡è¦æŒ‡æ ‡**ï¼š

```bash
# RDBç›¸å…³
rdb_last_save_time:1698739200   # æœ€åä¿å­˜æ—¶é—´
rdb_last_bgsave_status:ok       # æœ€åä¿å­˜çŠ¶æ€
rdb_last_bgsave_time_sec:1      # ä¿å­˜è€—æ—¶

# AOFç›¸å…³
aof_enabled:1                    # AOFæ˜¯å¦å¯ç”¨
aof_last_rewrite_time_sec:2     # æœ€åé‡å†™è€—æ—¶
aof_current_size:1048576        # å½“å‰AOFå¤§å°
aof_base_size:524288            # åŸºç¡€å¤§å°ï¼ˆé‡å†™åï¼‰
```

### Pythonç›‘æ§è„šæœ¬

```python
# monitor_persistence.py
import redis

client = redis.Redis(host='localhost', port=6379)
info = client.info('persistence')

print("=" * 50)
print("Redis æŒä¹…åŒ–ç›‘æ§")
print("=" * 50)

# RDBçŠ¶æ€
print(f"\nğŸ“¦ RDBçŠ¶æ€:")
print(f"   æœ€åä¿å­˜: {info['rdb_last_save_time']}")
print(f"   ä¿å­˜çŠ¶æ€: {info['rdb_last_bgsave_status']}")

# AOFçŠ¶æ€
if info['aof_enabled']:
    print(f"\nğŸ“ AOFçŠ¶æ€:")
    print(f"   å½“å‰å¤§å°: {info['aof_current_size'] / 1024 / 1024:.2f}MB")
    print(f"   åŸºç¡€å¤§å°: {info['aof_base_size'] / 1024 / 1024:.2f}MB")
    growth = (info['aof_current_size'] / info['aof_base_size'] - 1) * 100
    print(f"   å¢é•¿ç‡: {growth:.1f}%")
else:
    print(f"\nâš ï¸ AOFæœªå¯ç”¨")
```

---

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èé…ç½®

```bash
# ç”Ÿäº§ç¯å¢ƒç¼“å­˜åœºæ™¯ï¼ˆæœ¬é¡¹ç›®ï¼‰â­

appendonly yes                    # å¯ç”¨AOF
aof-use-rdb-preamble yes         # å¯ç”¨æ··åˆæŒä¹…åŒ–
appendfsync everysec             # æ¯ç§’åŒæ­¥

save 900 1                       # RDBå¿«ç…§ç­–ç•¥
save 300 10
save 60 10000

maxmemory 2gb                    # é™åˆ¶å†…å­˜
maxmemory-policy allkeys-lru     # LRUæ·˜æ±°
```

### ğŸ“ æ³¨æ„äº‹é¡¹

1. **å®šæœŸå¤‡ä»½**

   ```bash
   # æ¯å¤©å¤‡ä»½RDBå’ŒAOFæ–‡ä»¶åˆ°å…¶ä»–ä½ç½®
   cp dump.rdb /backup/dump-$(date +%Y%m%d).rdb
   cp appendonly.aof /backup/aof-$(date +%Y%m%d).aof
   ```

2. **ç›‘æ§æ–‡ä»¶å¤§å°**

   ```bash
   # AOFæ–‡ä»¶è¿‡å¤§æ—¶æ‰‹åŠ¨è§¦å‘é‡å†™
   redis-cli BGREWRITEAOF
   ```

3. **æµ‹è¯•æ¢å¤**
   ```bash
   # å®šæœŸæµ‹è¯•æŒä¹…åŒ–æ–‡ä»¶æ˜¯å¦å¯ä»¥æ­£å¸¸æ¢å¤
   redis-server --loadmodule appendonly.aof --test
   ```

---

## ğŸ” æ€§èƒ½å½±å“

| æŒä¹…åŒ–ç­–ç•¥     | CPU          | ç£ç›˜I/O | å†…å­˜       | æ€§èƒ½å½±å“   |
| -------------- | ------------ | ------- | ---------- | ---------- |
| å…³é—­æŒä¹…åŒ–     | ä½           | æ—       | ä½         | âš¡âš¡âš¡âš¡âš¡ |
| RDB            | ä¸­ï¼ˆforkæ—¶ï¼‰ | ä½      | ä¸­ï¼ˆforkï¼‰ | âš¡âš¡âš¡âš¡   |
| AOF (everysec) | ä½           | ä¸­      | ä½         | âš¡âš¡âš¡âš¡   |
| AOF (always)   | ä½           | é«˜      | ä½         | âš¡âš¡       |
| æ··åˆæŒä¹…åŒ–     | ä¸­           | ä¸­      | ä¸­         | âš¡âš¡âš¡âš¡   |

**ç»“è®º**ï¼šæ··åˆæŒä¹…åŒ– + everysec æ˜¯æœ€ä½³å¹³è¡¡ç‚¹ â­

---

## ğŸ‰ å¿«é€Ÿå¯ç”¨æŒ‡å—

### Step 1: ä¿®æ”¹é…ç½®

```bash
# Windows: ç¼–è¾‘ redis.windows.conf
# Linux: ç¼–è¾‘ /etc/redis/redis.conf

# æ·»åŠ ä»¥ä¸‹é…ç½®
appendonly yes
aof-use-rdb-preamble yes
appendfsync everysec
save 900 1
save 300 10
```

### Step 2: é‡å¯Redis

```bash
# Windows
redis-server redis.windows.conf

# Linux
sudo systemctl restart redis
```

### Step 3: éªŒè¯

```bash
redis-cli INFO persistence | grep -E "aof_enabled|rdb_last_save"
```

---

**ğŸ”’ æ•°æ®å®‰å…¨ï¼Œä»æŒä¹…åŒ–å¼€å§‹ï¼**
