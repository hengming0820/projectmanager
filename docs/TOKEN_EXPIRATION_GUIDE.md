# Token æœ‰æ•ˆæ—¶é—´é…ç½®æŒ‡å—

## ğŸ“‹ é…ç½®ä½ç½®

### 1ï¸âƒ£ ä¸»é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `backend/app/config.py`  
**ç¬¬ 28 è¡Œ**:

```python
ACCESS_TOKEN_EXPIRE_MINUTES: int = 30  # Token æœ‰æ•ˆæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
```

---

## ğŸ”§ ä¿®æ”¹æ–¹æ³•

### æ–¹å¼ 1ï¼šç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶

**ä¿®æ”¹**: `backend/app/config.py` ç¬¬ 28 è¡Œ

```python
# ç¤ºä¾‹ï¼šä¿®æ”¹ä¸º 60 åˆ†é’Ÿï¼ˆ1å°æ—¶ï¼‰
ACCESS_TOKEN_EXPIRE_MINUTES: int = 60

# ç¤ºä¾‹ï¼šä¿®æ”¹ä¸º 120 åˆ†é’Ÿï¼ˆ2å°æ—¶ï¼‰
ACCESS_TOKEN_EXPIRE_MINUTES: int = 120

# ç¤ºä¾‹ï¼šä¿®æ”¹ä¸º 1440 åˆ†é’Ÿï¼ˆ24å°æ—¶ï¼‰
ACCESS_TOKEN_EXPIRE_MINUTES: int = 1440
```

**é‡å¯åç«¯**ï¼šä¿®æ”¹åéœ€è¦é‡å¯åç«¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚

---

### æ–¹å¼ 2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

**åˆ›å»º/ä¿®æ”¹**: `backend/.env` æ–‡ä»¶

```bash
# Token æœ‰æ•ˆæ—¶é—´é…ç½®ï¼ˆåˆ†é’Ÿï¼‰
ACCESS_TOKEN_EXPIRE_MINUTES=60
```

**ä¼˜ç‚¹**ï¼š

- âœ… ä¸éœ€è¦ä¿®æ”¹ä»£ç 
- âœ… ä¸åŒç¯å¢ƒå¯ä»¥ä½¿ç”¨ä¸åŒé…ç½®
- âœ… æ›´å®‰å…¨ï¼ˆæ•æ„Ÿé…ç½®ä¸è¿›å…¥ç‰ˆæœ¬æ§åˆ¶ï¼‰

**ä½¿ç”¨**: `pydantic-settings` ä¼šè‡ªåŠ¨è¯»å– `.env` æ–‡ä»¶å¹¶è¦†ç›–é»˜è®¤å€¼ã€‚

---

## â±ï¸ è‡ªåŠ¨ç»­æœŸé˜ˆå€¼

**æ–‡ä»¶**: `backend/app/utils/token_manager.py`  
**ç¬¬ 24 è¡Œ**:

```python
TOKEN_RENEW_THRESHOLD = 5 * 60  # 5åˆ†é’Ÿï¼ˆç§’ï¼‰
```

### ä½œç”¨

å½“ Token å‰©ä½™æ—¶é—´ **å°‘äº 5 åˆ†é’Ÿ** æ—¶ï¼Œæ¯æ¬¡ API è¯·æ±‚ä¼šè‡ªåŠ¨ç»­æœŸåˆ°å®Œæ•´æ—¶é•¿ï¼ˆ30åˆ†é’Ÿï¼‰ã€‚

### ä¿®æ”¹ç¤ºä¾‹

```python
# ç¤ºä¾‹ï¼šæ”¹ä¸ºå‰©ä½™ 10 åˆ†é’Ÿæ—¶å¼€å§‹ç»­æœŸ
TOKEN_RENEW_THRESHOLD = 10 * 60  # 10åˆ†é’Ÿ

# ç¤ºä¾‹ï¼šæ”¹ä¸ºå‰©ä½™ 15 åˆ†é’Ÿæ—¶å¼€å§‹ç»­æœŸ
TOKEN_RENEW_THRESHOLD = 15 * 60  # 15åˆ†é’Ÿ
```

**å»ºè®®**ï¼šç»­æœŸé˜ˆå€¼åº”è¯¥æ˜¯ Token æœ‰æ•ˆæ—¶é—´çš„ 10-20%ã€‚

---

## ğŸ¯ æ¨èé…ç½®

### ä¸åŒåœºæ™¯çš„æ¨èå€¼

| åœºæ™¯                   | Token æœ‰æ•ˆæ—¶é—´ | ç»­æœŸé˜ˆå€¼ | è¯´æ˜                   |
| ---------------------- | -------------- | -------- | ---------------------- |
| **å¼€å‘ç¯å¢ƒ**           | 120 åˆ†é’Ÿ       | 10 åˆ†é’Ÿ  | æ–¹ä¾¿è°ƒè¯•ï¼Œå‡å°‘é‡å¤ç™»å½• |
| **æµ‹è¯•ç¯å¢ƒ**           | 60 åˆ†é’Ÿ        | 10 åˆ†é’Ÿ  | æ¥è¿‘ç”Ÿäº§ç¯å¢ƒ           |
| **ç”Ÿäº§ç¯å¢ƒï¼ˆé«˜å®‰å…¨ï¼‰** | 30 åˆ†é’Ÿ        | 5 åˆ†é’Ÿ   | å½“å‰é…ç½®ï¼Œå®‰å…¨æ€§é«˜     |
| **ç”Ÿäº§ç¯å¢ƒï¼ˆå¹³è¡¡ï¼‰**   | 60 åˆ†é’Ÿ        | 10 åˆ†é’Ÿ  | å®‰å…¨ä¸ä½“éªŒå¹³è¡¡         |
| **å†…ç½‘ç¯å¢ƒ**           | 240 åˆ†é’Ÿ       | 30 åˆ†é’Ÿ  | å†…ç½‘å®‰å…¨æ€§è¾ƒé«˜         |

### è€ƒè™‘å› ç´ 

1. **å®‰å…¨æ€§** â¬†ï¸

   - Token æœ‰æ•ˆæ—¶é—´è¶ŠçŸ­ï¼Œå®‰å…¨æ€§è¶Šé«˜
   - å³ä½¿ Token æ³„éœ²ï¼Œä¹Ÿä¼šå¾ˆå¿«å¤±æ•ˆ

2. **ç”¨æˆ·ä½“éªŒ** â¬†ï¸

   - Token æœ‰æ•ˆæ—¶é—´è¶Šé•¿ï¼Œç”¨æˆ·è¶Šä¸å®¹æ˜“æ‰çº¿
   - è‡ªåŠ¨ç»­æœŸæœºåˆ¶å¯ä»¥å¹³è¡¡ä¸¤è€…

3. **ç³»ç»Ÿè´Ÿè½½** â¬‡ï¸
   - Token æœ‰æ•ˆæ—¶é—´è¶ŠçŸ­ï¼Œç™»å½•é¢‘ç‡è¶Šé«˜
   - è‡ªåŠ¨ç»­æœŸä¼šå¢åŠ  Redis æ“ä½œ

---

## ğŸ“Š Token ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹

### åœºæ™¯ 1ï¼šæŒç»­æ´»è·ƒç”¨æˆ·

```
æ—¶é—´è½´ï¼ˆ30åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œ5åˆ†é’Ÿç»­æœŸé˜ˆå€¼ï¼‰:

00:00 - ç”¨æˆ·ç™»å½•ï¼ŒToken ç”Ÿæˆ
        â†“ TTL: 30åˆ†é’Ÿ

00:15 - ç”¨æˆ·å‘èµ·è¯·æ±‚
        â†“ TTL: 15åˆ†é’Ÿï¼ˆ>5åˆ†é’Ÿï¼Œä¸ç»­æœŸï¼‰

00:26 - ç”¨æˆ·å‘èµ·è¯·æ±‚
        â†“ TTL: 4åˆ†é’Ÿï¼ˆ<5åˆ†é’Ÿï¼Œè‡ªåŠ¨ç»­æœŸï¼‰
        âœ… æ–° TTL: 30åˆ†é’Ÿ

00:52 - ç”¨æˆ·å‘èµ·è¯·æ±‚
        â†“ TTL: 4åˆ†é’Ÿï¼ˆ<5åˆ†é’Ÿï¼Œè‡ªåŠ¨ç»­æœŸï¼‰
        âœ… æ–° TTL: 30åˆ†é’Ÿ

...æŒç»­ä½¿ç”¨ï¼ŒæŒç»­ç»­æœŸï¼Œæ°¸ä¸è¿‡æœŸ
```

### åœºæ™¯ 2ï¼šé—´æ­‡æ€§ç”¨æˆ·

```
æ—¶é—´è½´ï¼ˆ30åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œ5åˆ†é’Ÿç»­æœŸé˜ˆå€¼ï¼‰:

00:00 - ç”¨æˆ·ç™»å½•ï¼ŒToken ç”Ÿæˆ
        â†“ TTL: 30åˆ†é’Ÿ

00:10 - ç”¨æˆ·å‘èµ·è¯·æ±‚
        â†“ TTL: 20åˆ†é’Ÿï¼ˆ>5åˆ†é’Ÿï¼Œä¸ç»­æœŸï¼‰

00:29 - ç”¨æˆ·ç¦»å¼€ï¼ˆæœªå…³é—­æµè§ˆå™¨ï¼‰
        â†“ TTL: 1åˆ†é’Ÿ

00:30 - Token è¿‡æœŸ
        â†“
00:35 - ç”¨æˆ·å›æ¥ï¼Œå‘èµ·è¯·æ±‚
        âŒ Token å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
```

### åœºæ™¯ 3ï¼šå…³é—­æµè§ˆå™¨

```
æ—¶é—´è½´:

00:00 - ç”¨æˆ·ç™»å½•ï¼ŒToken å­˜å…¥ sessionStorage
        â†“ Redis TTL: 30åˆ†é’Ÿ

00:10 - ç”¨æˆ·å…³é—­æµè§ˆå™¨
        â†“ sessionStorage æ¸…ç©º
        âœ… Token ä¸¢å¤±

00:15 - ç”¨æˆ·é‡æ–°æ‰“å¼€æµè§ˆå™¨
        âŒ æ²¡æœ‰ Tokenï¼Œéœ€è¦é‡æ–°ç™»å½•

ï¼ˆå³ä½¿ Redis ä¸­ Token è¿˜æœªè¿‡æœŸï¼Œä½†å‰ç«¯å·²æ— æ³•è®¿é—®ï¼‰
```

---

## ğŸ” éªŒè¯é…ç½®

### 1. æ£€æŸ¥å½“å‰é…ç½®

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# å¯åŠ¨ Python äº¤äº’å¼ç¯å¢ƒ
python

>>> from app.config import settings
>>> print(f"Token æœ‰æ•ˆæ—¶é—´: {settings.ACCESS_TOKEN_EXPIRE_MINUTES} åˆ†é’Ÿ")
>>> print(f"Token æœ‰æ•ˆæ—¶é—´: {settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60} ç§’")
```

### 2. æ£€æŸ¥ Token å®é™… TTL

```bash
# è¿æ¥åˆ° Redis
docker exec -it pm-redis redis-cli

# ç™»å½•åï¼ŒæŸ¥çœ‹ Token çš„ TTL
KEYS token:*
TTL token:xxxxxxxxxxxxxxxx

# è¾“å‡ºç¤ºä¾‹
(integer) 1789  # å‰©ä½™ 1789 ç§’ï¼ˆçº¦ 30 åˆ†é’Ÿï¼‰
```

### 3. æµ‹è¯•è‡ªåŠ¨ç»­æœŸ

```bash
# 1. ç™»å½•è·å– Token
# 2. ç­‰å¾… 26 åˆ†é’Ÿï¼ˆå‰©ä½™ 4 åˆ†é’Ÿï¼Œè§¦å‘ç»­æœŸé˜ˆå€¼ï¼‰
# 3. å‘èµ·ä»»æ„ API è¯·æ±‚
# 4. æ£€æŸ¥ Redis ä¸­ Token çš„ TTL
TTL token:xxxxxxxxxxxxxxxx

# è¾“å‡ºåº”è¯¥æ¥è¿‘ 1800 ç§’ï¼ˆ30 åˆ†é’Ÿï¼‰ï¼Œè¯´æ˜å·²ç»­æœŸ
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¿®æ”¹åéœ€è¦é‡å¯

ä¿®æ”¹é…ç½®åï¼Œ**å¿…é¡»é‡å¯åç«¯æœåŠ¡**æ‰èƒ½ç”Ÿæ•ˆï¼š

- é‡å¯å¼€å‘æœåŠ¡å™¨
- é‡å¯ Gunicorn/Uvicorn
- é‡å¯ Docker å®¹å™¨

### 2. å·²ç™»å½•ç”¨æˆ·ä¸å—å½±å“

ä¿®æ”¹é…ç½®åªå½±å“**æ–°ç™»å½•**çš„ç”¨æˆ·ï¼š

- å·²ç™»å½•ç”¨æˆ·çš„ Token ä»ç„¶ä½¿ç”¨æ—§çš„è¿‡æœŸæ—¶é—´
- ç›´åˆ° Token è¿‡æœŸæˆ–ç”¨æˆ·é‡æ–°ç™»å½•

### 3. JWT å’Œ Redis çš„åŒé‡è¿‡æœŸ

ç³»ç»Ÿä½¿ç”¨ä¸¤å±‚è¿‡æœŸæœºåˆ¶ï¼š

1. **JWT æœ¬èº«çš„ `exp` å­—æ®µ**ï¼ˆç¡¬ç¼–ç åœ¨ Token ä¸­ï¼‰

   - ç”± `ACCESS_TOKEN_EXPIRE_MINUTES` å†³å®š
   - æ— æ³•ä¿®æ”¹ï¼ˆé™¤éé‡æ–°ç­¾å‘ Tokenï¼‰

2. **Redis ä¸­çš„ TTL**ï¼ˆå¯åŠ¨æ€è°ƒæ•´ï¼‰
   - åŒæ ·ç”± `ACCESS_TOKEN_EXPIRE_MINUTES` åˆå§‹åŒ–
   - è‡ªåŠ¨ç»­æœŸä¼šæ›´æ–°è¿™ä¸ª TTL

**ç»“è®º**ï¼šä¸¤è€…å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå¦åˆ™å¯èƒ½å‡ºç°ï¼š

- JWT å·²è¿‡æœŸï¼Œä½† Redis ä¸­è¿˜å­˜åœ¨ âŒ
- Redis å·²è¿‡æœŸï¼Œä½† JWT è¿˜æœ‰æ•ˆ âŒ

### 4. å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡

```bash
# backend/.env
ACCESS_TOKEN_EXPIRE_MINUTES=60
```

è€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹ `config.py`ï¼Œè¿™æ ·ï¼š

- âœ… ä»£ç ä¿æŒé€šç”¨æ€§
- âœ… ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
- âœ… æ•æ„Ÿé…ç½®ä¸è¿›å…¥ç‰ˆæœ¬æ§åˆ¶

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šä¿®æ”¹åæ²¡æœ‰ç”Ÿæ•ˆ

**æ£€æŸ¥**ï¼š

```bash
# 1. ç¡®è®¤é…ç½®å·²ä¿®æ”¹
cat backend/app/config.py | grep ACCESS_TOKEN_EXPIRE_MINUTES

# 2. ç¡®è®¤åç«¯å·²é‡å¯
# æŸ¥çœ‹åç«¯å¯åŠ¨æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³

# 3. æ¸…é™¤æ—§ Tokenï¼Œé‡æ–°ç™»å½•
# å‰ç«¯ï¼šæ¸…é™¤ sessionStorage
# åç«¯ï¼šRedis FLUSHDBï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼ï¼‰
```

### é—®é¢˜ 2ï¼šToken è¿‡æœŸå¤ªå¿«

**å¯èƒ½åŸå› **ï¼š

- Redis TTL è®¾ç½®é”™è¯¯
- è‡ªåŠ¨ç»­æœŸæœªè§¦å‘
- æ—¶åŒºé—®é¢˜ï¼ˆJWT `exp` ä½¿ç”¨ UTCï¼‰

**æ£€æŸ¥**ï¼š

```bash
# æŸ¥çœ‹ Token çš„å®é™… TTL
docker exec -it pm-redis redis-cli
TTL token:xxxxxxxxxxxxxxxx

# æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„ç»­æœŸè®°å½•
grep "Token å·²ç»­æœŸ" backend.log
```

### é—®é¢˜ 3ï¼šToken æ°¸ä¸è¿‡æœŸ

**å¯èƒ½åŸå› **ï¼š

- Redis TTL è®¾ç½®ä¸º -1ï¼ˆæ°¸ä¸è¿‡æœŸï¼‰
- è‡ªåŠ¨ç»­æœŸé˜ˆå€¼è®¾ç½®è¿‡å¤§

**æ£€æŸ¥**ï¼š

```bash
# æŸ¥çœ‹ Token çš„ TTL
TTL token:xxxxxxxxxxxxxxxx

# è¾“å‡º -1 è¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼ˆé”™è¯¯ï¼‰
# è¾“å‡º >0 è¡¨ç¤ºæ­£å¸¸
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶                                 | ä½œç”¨                              | å…³é”®è¡Œ      |
| ------------------------------------ | --------------------------------- | ----------- |
| `backend/app/config.py`              | Token æœ‰æ•ˆæ—¶é—´é…ç½®                | ç¬¬ 28 è¡Œ    |
| `backend/app/utils/token_manager.py` | Token ç®¡ç†é€»è¾‘ï¼Œç»­æœŸé˜ˆå€¼          | ç¬¬ 22-24 è¡Œ |
| `backend/app/utils/security.py`      | JWT ç”Ÿæˆï¼Œä½¿ç”¨é…ç½®                | ç¬¬ 33 è¡Œ    |
| `backend/app/api/auth.py`            | ç™»å½•/ç™»å‡º API                     | -           |
| `src/utils/auth.ts`                  | å‰ç«¯ Token å­˜å‚¨ï¼ˆsessionStorageï¼‰ | -           |

---

## ğŸ¯ å¿«é€Ÿä¿®æ”¹æŒ‡å—

### ä¿®æ”¹ä¸º 1 å°æ—¶

```python
# backend/app/config.py (ç¬¬ 28 è¡Œ)
ACCESS_TOKEN_EXPIRE_MINUTES: int = 60

# backend/app/utils/token_manager.py (ç¬¬ 24 è¡Œ)
TOKEN_RENEW_THRESHOLD = 10 * 60  # 10åˆ†é’Ÿ
```

### ä¿®æ”¹ä¸º 2 å°æ—¶

```python
# backend/app/config.py (ç¬¬ 28 è¡Œ)
ACCESS_TOKEN_EXPIRE_MINUTES: int = 120

# backend/app/utils/token_manager.py (ç¬¬ 24 è¡Œ)
TOKEN_RENEW_THRESHOLD = 15 * 60  # 15åˆ†é’Ÿ
```

### ä¿®æ”¹ä¸º 24 å°æ—¶ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```python
# backend/app/config.py (ç¬¬ 28 è¡Œ)
ACCESS_TOKEN_EXPIRE_MINUTES: int = 1440

# backend/app/utils/token_manager.py (ç¬¬ 24 è¡Œ)
TOKEN_RENEW_THRESHOLD = 60 * 60  # 60åˆ†é’Ÿ
```

**ä¿®æ”¹åé‡å¯åç«¯å³å¯ç”Ÿæ•ˆï¼**

---

**æœ€åæ›´æ–°**: 2025-10-16  
**ç»´æŠ¤è€…**: AI Assistant
