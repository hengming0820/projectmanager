# 个人绩效PDF报告导出功能

## 功能概述

实现了个人绩效PDF报告的导出功能，支持月度报告和年度报告，包含图表和详细统计数据。

## 功能特性

### ✅ 已实现功能

1. **报告类型**

   - 月度报告（默认当前月）
   - 年度报告（默认当前年）

2. **报告内容**

   - **个人信息**：姓名、部门、工号、入职时间
   - **绩效概览**：
     - 完成总任务数
     - 任务平均完成时间（小时）
     - 最快完成时间（小时）
     - 每天平均完成数量
     - 单日最多完成数量
   - **任务完成趋势图**：折线图展示任务完成趋势
   - **分类统计图**：饼图和柱状图展示任务分类分布

3. **交互功能**

   - 用户友好的日期选择界面
   - 支持选择年份和月份
   - 加载状态提示
   - 自动下载生成的PDF文件

4. **权限控制**
   - 用户可以导出自己的报告
   - 管理员可以导出任何用户的报告

## 技术实现

### 后端实现

#### 1. PDF生成服务 (`backend/app/services/pdf_export_service.py`)

使用技术栈：

- `reportlab`：PDF文档生成
- `matplotlib`：图表生成
- 中文字体支持（Windows: 微软雅黑，Linux: 文泉驿）

核心类：

```python
class PersonalPerformancePDFService:
    def generate_personal_report(...)
```

#### 2. 导出API (`backend/app/api/performance_export.py`)

接口：`GET /api/performance/personal/export`

参数：

- `period_type`: 报告类型（monthly/yearly）
- `year`: 年份（可选，默认当前年）
- `month`: 月份（可选，月度报告时使用，默认当前月）
- `user_id`: 用户ID（可选，默认当前用户）

响应：PDF文件流（application/pdf）

### 前端实现

#### 修改文件

- `src/views/project/performance/personal.vue`

#### 新增组件

- 导出对话框（el-dialog）
- 报告类型选择（el-radio-group）
- 年份选择器（el-date-picker）
- 月份选择器（el-select）

## 安装依赖

### 后端依赖

```bash
cd backend
pip install -r requirements.txt
```

新增的依赖：

- `reportlab==4.0.7`
- `matplotlib==3.8.2`

## 使用方法

### 1. 用户操作

1. 进入"个人绩效"页面
2. 点击页面右上角的"导出报告"按钮
3. 在弹出的对话框中：
   - 选择报告类型（月度报告/年度报告）
   - 选择年份
   - 如果是月度报告，选择月份
4. 点击"导出PDF"按钮
5. 等待生成（通常几秒钟）
6. 浏览器自动下载PDF文件

### 2. 管理员操作

管理员可以在查看任何用户的个人绩效页面时导出该用户的报告。

## PDF报告样式

### 报告结构

```
标题：XXXX年X月个人绩效报告 / XXXX年度个人绩效报告

一、个人信息
┌──────────┬──────────┬──────────┬──────────┐
│ 姓名     │ XXX      │ 部门     │ XXX      │
├──────────┼──────────┼──────────┼──────────┤
│ 工号     │ XXX      │ 入职时间 │ XXX      │
└──────────┴──────────┴──────────┴──────────┘

二、绩效概览
┌────────────────────┬────────────┐
│ 指标               │ 数值       │
├────────────────────┼────────────┤
│ 完成总任务数       │ XX 个      │
│ 任务平均完成时间   │ XX.X 小时  │
│ 最快完成时间       │ XX.X 小时  │
│ 每天平均完成数量   │ XX.X 个    │
│ 单日最多完成数量   │ XX 个      │
└────────────────────┴────────────┘

三、任务完成趋势
[折线图]

四、分类统计
[饼图 + 柱状图]

报告生成时间：XXXX年XX月XX日 XX:XX:XX
```

### 设计特点

- 🎨 使用品牌色（#1a73e8）作为主色调
- 📊 图表使用渐变色和透明度，美观大方
- 📏 A4纸张大小，适合打印
- 🖨️ 表格采用斑马纹设计，易于阅读
- 🔤 使用中文字体，支持中文显示

## 数据统计说明

### 任务完成时间计算

- 平均完成时间 = 从任务分配到任务批准的平均时长
- 最快完成时间 = 所有任务中最短的完成时长
- 只统计已批准（approved）的任务

### 每天完成数量计算

- 基于任务批准时间（approved_at）
- 每天平均完成 = 总完成任务数 / 有任务的天数
- 单日最多完成 = 历史单日最高完成数量

### 趋势图采样

- **月度报告**：按天采样，显示每天的完成数量
- **年度报告**：按周采样，显示每周的完成数量（优化显示效果）

## 常见问题

### Q1: 为什么没有数据？

**A**: 请确保选择的时间范围内有已完成（approved）的任务。

### Q2: 中文字体显示异常？

**A**:

- Windows系统：确保已安装微软雅黑（simhei.ttf）
- Linux系统：确保已安装文泉驿字体
  ```bash
  sudo apt-get install fonts-wqy-zenhei
  ```

### Q3: 导出失败？

**A**: 请检查：

1. 后端服务是否正常运行
2. 是否安装了所需的Python依赖
3. 查看后端日志了解详细错误信息

### Q4: PDF文件打不开？

**A**: 请使用最新版本的PDF阅读器（如Adobe Acrobat Reader、Chrome、Edge等）

## 未来扩展

### 计划实现的功能

1. **团队绩效PDF导出**

   - 团队整体统计
   - 成员排行榜
   - 部门对比分析

2. **更多报告格式**

   - Excel格式导出（支持数据编辑）
   - CSV格式导出（支持数据分析）

3. **自定义报告**

   - 用户可选择包含的内容模块
   - 自定义统计指标
   - 自定义时间范围

4. **报告模板**

   - 多种PDF模板样式
   - 公司Logo和水印
   - 签字栏和盖章区域

5. **定时报告**
   - 自动生成月度报告
   - 邮件推送报告
   - 报告归档管理

## 开发日志

- **2025-10-21**：初始版本完成
  - 实现个人绩效PDF导出
  - 支持月度和年度报告
  - 包含图表和统计数据

## 技术支持

如有问题或建议，请联系开发团队。
