# ğŸ”§ Redisç¼“å­˜å¤±æ•ˆé—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ“… ä¿®å¤æ—¶é—´

2025-10-31

## ğŸ¯ é—®é¢˜æ¦‚è¿°

åœ¨é›†æˆRedisç¼“å­˜åï¼Œå‘ç°äº†**ä¸¤ä¸ªå…³é”®çš„ç¼“å­˜ä¸ä¸€è‡´é—®é¢˜**ï¼š

### é—®é¢˜1ï¼šæ ‡æ³¨å‘˜è§†å›¾ä¸åˆ·æ–° âŒ

- **ç—‡çŠ¶**ï¼šç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡åï¼Œæ ‡æ³¨å‘˜çš„"æˆ‘çš„å·¥ä½œå°"æœªåˆ·æ–°
- **åŸå› **ï¼šåªæ¸…é™¤äº†é¡¹ç›®ç¼“å­˜ï¼Œæœªæ¸…é™¤æ ‡æ³¨å‘˜çš„ä»»åŠ¡åˆ—è¡¨ç¼“å­˜

### é—®é¢˜2ï¼šç®¡ç†å‘˜è§†å›¾ä¸åˆ·æ–° âŒ

- **ç—‡çŠ¶**ï¼šç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡åï¼Œç®¡ç†å‘˜çš„"ä»»åŠ¡å®¡æ ¸"é¡µé¢æœªåˆ·æ–°
- **åŸå› **ï¼šæœªæ¸…é™¤æŒ‰çŠ¶æ€ç­›é€‰çš„ç¼“å­˜ï¼ˆå¦‚`tasks:list:all:submitted:*`ï¼‰

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒç­–ç•¥ï¼šåŒé‡ç¼“å­˜æ¸…é™¤

å¯¹äº**ä»»ä½•ä»»åŠ¡çŠ¶æ€å˜åŒ–**ï¼Œéƒ½é‡‡ç”¨**åŒé‡æ¸…é™¤ç­–ç•¥**ï¼š

```python
# 1. æ¸…é™¤ç‰¹å®šç”¨æˆ·çš„ä»»åŠ¡ç¼“å­˜
cache_service.invalidate_tasks_cache(project_id, user_id)

# 2. æ¸…é™¤æ•´ä¸ªé¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜
cache_service.invalidate_tasks_cache(project_id)
```

è¿™ç¡®ä¿äº†ï¼š

- âœ… ç‰¹å®šç”¨æˆ·ï¼ˆæ ‡æ³¨å‘˜ã€é¢†å–è€…ç­‰ï¼‰çš„è§†å›¾åˆ·æ–°
- âœ… æ‰€æœ‰æŸ¥çœ‹è¯¥é¡¹ç›®çš„ç”¨æˆ·ï¼ˆç®¡ç†å‘˜ã€å®¡æ ¸å‘˜ç­‰ï¼‰çš„è§†å›¾åˆ·æ–°

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `backend/app/services/cache_service.py`

å¢å¼ºäº† `invalidate_tasks_cache` å‡½æ•°ï¼Œæ”¯æŒæŒ‰ç”¨æˆ·IDæ¸…é™¤ç¼“å­˜ï¼š

```python
def invalidate_tasks_cache(self, project_id: str = None, user_id: str = None):
    if project_id and user_id:
        # æ¸…é™¤ç‰¹å®šé¡¹ç›®å’Œç”¨æˆ·çš„ä»»åŠ¡ç¼“å­˜
        self.delete_pattern(f"tasks:list:{project_id}:*:{user_id}:*")
        self.delete_pattern(f"tasks:list:{project_id}:*:all:*")
        self.delete_pattern(f"tasks:list:all:*:{user_id}:*")
    elif project_id:
        # æ¸…é™¤ç‰¹å®šé¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜
        self.delete_pattern(f"tasks:list:{project_id}:*")
    elif user_id:
        # æ¸…é™¤ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜
        self.delete_pattern(f"tasks:list:*:*:{user_id}:*")
    else:
        # æ¸…é™¤æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨ç¼“å­˜
        self.delete_pattern("tasks:list:*")
```

### 2. `backend/app/api/tasks.py`

æ›´æ–°äº†æ‰€æœ‰ä»»åŠ¡æ“ä½œçš„ç¼“å­˜æ¸…é™¤é€»è¾‘ï¼Œé‡‡ç”¨åŒé‡æ¸…é™¤ç­–ç•¥ï¼š

#### ä¿®æ”¹çš„å‡½æ•°ï¼š

- âœ… `submit_task` - ä»»åŠ¡æäº¤
- âœ… `review_task` - ä»»åŠ¡å®¡æ ¸ â­â­â­
- âœ… `claim_task` - ä»»åŠ¡é¢†å–
- âœ… `abandon_task` - ä»»åŠ¡æ”¾å¼ƒ
- âœ… `restart_task` - ä»»åŠ¡é‡å¯
- âœ… `skip_task` - ä»»åŠ¡è·³è¿‡
- âœ… `request_skip_task` - ç”³è¯·è·³è¿‡
- âœ… `review_skip_request` - å®¡æ ¸è·³è¿‡ç”³è¯·

#### ç¤ºä¾‹ï¼šä»»åŠ¡å®¡æ ¸ï¼ˆæœ€å…³é”®ï¼‰

```python
@router.post("/{task_id}/review")
async def review_task(...):
    # ... å®¡æ ¸é€»è¾‘ ...
    assigned_user_id = task.assigned_to  # æ ‡æ³¨å‘˜ID
    db.commit()

    # âœ… åŒé‡æ¸…é™¤
    # 1. æ¸…é™¤æ ‡æ³¨å‘˜çš„ä»»åŠ¡ç¼“å­˜
    cache_service.invalidate_tasks_cache(task.project_id, assigned_user_id)
    # 2. æ¸…é™¤é¡¹ç›®çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜æŸ¥çœ‹çš„å¾…å®¡æ ¸åˆ—è¡¨ï¼‰
    cache_service.invalidate_tasks_cache(task.project_id)
    # 3. æ¸…é™¤ä»»åŠ¡è¯¦æƒ…
    cache_service.invalidate_task_detail_cache(task_id)
    cache_service.invalidate_project_detail_cache(task.project_id)

    logger.info(f"âœ… ä»»åŠ¡å®¡æ ¸ç¼“å­˜å·²æ¸…é™¤: project={task.project_id}, user={assigned_user_id}, ç®¡ç†å‘˜è§†å›¾å·²åˆ·æ–°")
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ âŒ

| åœºæ™¯           | é—®é¢˜                                                       |
| -------------- | ---------------------------------------------------------- |
| æ ‡æ³¨å‘˜æäº¤ä»»åŠ¡ | å®¡æ ¸å‘˜çš„"å¾…å®¡æ ¸"åˆ—è¡¨ä¸åˆ·æ–°                                 |
| ç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡ | æ ‡æ³¨å‘˜çš„"æˆ‘çš„å·¥ä½œå°"ä¸åˆ·æ–°<br>ç®¡ç†å‘˜çš„"ä»»åŠ¡å®¡æ ¸"é¡µé¢ä¸åˆ·æ–° |
| ç”¨æˆ·é¢†å–ä»»åŠ¡   | ä»»åŠ¡æ± ä¸åˆ·æ–°                                               |

### ä¿®å¤å âœ…

| åœºæ™¯           | æ•ˆæœ                                                    |
| -------------- | ------------------------------------------------------- |
| æ ‡æ³¨å‘˜æäº¤ä»»åŠ¡ | âœ… æ ‡æ³¨å‘˜è§†å›¾åˆ·æ–°<br>âœ… å®¡æ ¸å‘˜è§†å›¾åˆ·æ–°                  |
| ç®¡ç†å‘˜å®¡æ ¸ä»»åŠ¡ | âœ… æ ‡æ³¨å‘˜è§†å›¾åˆ·æ–°<br>âœ… ç®¡ç†å‘˜è§†å›¾åˆ·æ–°<br>âœ… ä»»åŠ¡æ± åˆ·æ–° |
| ç”¨æˆ·é¢†å–ä»»åŠ¡   | âœ… é¢†å–è€…è§†å›¾åˆ·æ–°<br>âœ… ä»»åŠ¡æ± åˆ·æ–°                      |

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æ‰‹åŠ¨æµ‹è¯•

```
æ­¥éª¤1ï¼šæ ‡æ³¨å‘˜ç™»å½• â†’ é¢†å–ä»»åŠ¡ â†’ æäº¤ä»»åŠ¡
æ­¥éª¤2ï¼šç®¡ç†å‘˜ç™»å½• â†’ å®¡æ ¸ä»»åŠ¡ï¼ˆé€šè¿‡/é©³å›ï¼‰
æ­¥éª¤3ï¼šæ ‡æ³¨å‘˜åˆ·æ–°"æˆ‘çš„å·¥ä½œå°" â†’ âœ… ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°
æ­¥éª¤4ï¼šç®¡ç†å‘˜åˆ·æ–°"ä»»åŠ¡å®¡æ ¸"é¡µé¢ â†’ âœ… ä»»åŠ¡ä¸å†æ˜¾ç¤ºåœ¨"å¾…å®¡æ ¸"åˆ—è¡¨
```

### 2. æŸ¥çœ‹æ—¥å¿—

å®¡æ ¸ä»»åŠ¡åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```log
âœ… [TaskAPI] ä»»åŠ¡çŠ¶æ€æ›´æ–°: task456 submitted -> approved
ğŸ—‘ï¸ ä»»åŠ¡ç¼“å­˜å·²æ¸…é™¤ (é¡¹ç›®: proj1, ç”¨æˆ·: user123)
ğŸ—‘ï¸ ä»»åŠ¡ç¼“å­˜å·²æ¸…é™¤ (é¡¹ç›®: proj1)
âœ… [TaskAPI] ä»»åŠ¡å®¡æ ¸ç¼“å­˜å·²æ¸…é™¤: project=proj1, user=user123, ç®¡ç†å‘˜è§†å›¾å·²åˆ·æ–°
```

### 3. ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
cd backend
python scripts/test_cache_invalidation.py
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š

- æ˜¾ç¤ºå½“å‰çš„æ‰€æœ‰ä»»åŠ¡ç¼“å­˜Key
- æµ‹è¯•ç¼“å­˜æ¸…é™¤æ¨¡å¼æ˜¯å¦æ­£ç¡®
- æ˜¾ç¤ºç”¨æˆ·ç‰¹å®šçš„ç¼“å­˜
- æ¨¡æ‹Ÿç¼“å­˜æ¸…é™¤åœºæ™¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **`CACHE_INVALIDATION_FIX.md`** - è¯¦ç»†çš„é—®é¢˜åˆ†æã€ä¿®å¤æ–¹æ¡ˆå’ŒéªŒè¯æ–¹æ³•
2. **`backend/scripts/test_cache_invalidation.py`** - ç¼“å­˜æµ‹è¯•å·¥å…·

---

## ğŸ“ ç»éªŒæ€»ç»“

### 1. ç¼“å­˜å¤±æ•ˆè¦å…¨é¢

```python
# âŒ é”™è¯¯ï¼šåªæ¸…é™¤ä¸€æ¬¡
cache_service.invalidate_tasks_cache(project_id, user_id)

# âœ… æ­£ç¡®ï¼šåŒé‡æ¸…é™¤
cache_service.invalidate_tasks_cache(project_id, user_id)  # ç‰¹å®šç”¨æˆ·
cache_service.invalidate_tasks_cache(project_id)          # æ‰€æœ‰ç”¨æˆ·
```

### 2. è€ƒè™‘æ‰€æœ‰ç›¸å…³è§†å›¾

ä»»åŠ¡çŠ¶æ€å˜åŒ–å¯èƒ½å½±å“ï¼š

- æ ‡æ³¨å‘˜çš„"æˆ‘çš„å·¥ä½œå°"
- ç®¡ç†å‘˜çš„"ä»»åŠ¡å®¡æ ¸"é¡µé¢
- ä»»åŠ¡æ± 
- é¡¹ç›®è¯¦æƒ…é¡µ
- ç»Ÿè®¡ä»ªè¡¨æ¿

éƒ½éœ€è¦æ¸…é™¤ç›¸å…³ç¼“å­˜ï¼

### 3. æ—¥å¿—è¦è¯¦ç»†

```python
logger.info(f"âœ… ä»»åŠ¡å®¡æ ¸ç¼“å­˜å·²æ¸…é™¤: project={project_id}, user={user_id}, ç®¡ç†å‘˜è§†å›¾å·²åˆ·æ–°")
```

è¯¦ç»†çš„æ—¥å¿—æœ‰åŠ©äºæ’æŸ¥é—®é¢˜å’ŒéªŒè¯ä¿®å¤æ•ˆæœã€‚

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜é¢„çƒ­

```python
# ç”¨æˆ·ç™»å½•åï¼Œé¢„çƒ­å¸¸ç”¨ç¼“å­˜
def warm_up_user_cache(user_id):
    get_tasks(assigned_to=user_id, status='in_progress')
    get_performance_stats(user_id)
```

### 2. ç›‘æ§å‘Šè­¦

```python
# ç›‘æ§ç¼“å­˜æ¸…é™¤é¢‘ç‡
if cache_clear_rate > threshold:
    alert("ç¼“å­˜æ¸…é™¤é¢‘ç‡è¿‡é«˜ï¼Œå¯èƒ½å½±å“æ€§èƒ½")
```

### 3. è‡ªåŠ¨åŒ–æµ‹è¯•

```python
def test_task_review_cache_invalidation():
    # 1. æäº¤ä»»åŠ¡
    # 2. å®¡æ ¸ä»»åŠ¡
    # 3. éªŒè¯æ‰€æœ‰ç›¸å…³ç¼“å­˜å·²æ¸…é™¤
    assert not cache_exists(f"tasks:list:*:submitted:*")
    assert not cache_exists(f"tasks:list:*:*:{annotator_id}:*")
```

---

## âœ… æ€»ç»“

### é—®é¢˜æ ¹æº

- âŒ ç¼“å­˜Keyæ¨¡å¼åŒ¹é…é”™è¯¯
- âŒ æœªæ¸…é™¤ç”¨æˆ·ç»´åº¦çš„ç¼“å­˜
- âŒ æœªæ¸…é™¤æŒ‰çŠ¶æ€ç­›é€‰çš„ç¼“å­˜
- âŒ ç¼“å­˜æ¸…é™¤èŒƒå›´ä¸å¤Ÿå…¨é¢

### ä¿®å¤æ–¹æ¡ˆ

- âœ… ä¿®æ­£ç¼“å­˜KeyåŒ¹é…æ¨¡å¼
- âœ… æ”¯æŒæŒ‰ç”¨æˆ·IDæ¸…é™¤ç¼“å­˜
- âœ… **åŒé‡æ¸…é™¤ç­–ç•¥**ï¼šæ¯æ¬¡ä»»åŠ¡çŠ¶æ€å˜åŒ–éƒ½æ¸…é™¤ç‰¹å®šç”¨æˆ·å’Œæ•´ä¸ªé¡¹ç›®çš„ç¼“å­˜
- âœ… è¦†ç›–æ‰€æœ‰ä»»åŠ¡æ“ä½œ

### ä¿®å¤æ•ˆæœ

- âœ… æ ‡æ³¨å‘˜è§†å›¾å®æ—¶åŒæ­¥
- âœ… ç®¡ç†å‘˜è§†å›¾å®æ—¶åŒæ­¥
- âœ… å®¡æ ¸å‘˜è§†å›¾å®æ—¶åŒæ­¥
- âœ… ä»»åŠ¡æ± å®æ—¶åˆ·æ–°
- âœ… å‰ç«¯æ•°æ®ä¸æ•°æ®åº“å®Œå…¨ä¸€è‡´
- âœ… æ‰€æœ‰è§’è‰²çš„ç”¨æˆ·ä½“éªŒéƒ½å¾—åˆ°æå‡

---

**ğŸ‰ é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼ç³»ç»Ÿç¼“å­˜æœºåˆ¶æ›´åŠ å¥å£®ï¼**

ç°åœ¨å¯ä»¥é‡å¯åç«¯æœåŠ¡ï¼Œæ‰€æœ‰çš„ç¼“å­˜åŒæ­¥é—®é¢˜éƒ½å·²è§£å†³ã€‚
