# 📝 版本更新日志 - v3.2.0

> 🗓️ **发布日期**: 2025-10-27  
> 🎯 **主题**: 工作周管理优化 - 时区修复 & 部门选择功能

---

## 🎉 核心更新

### 1️⃣ 工作周日期时区修复 ⏰

#### 问题描述

用户报告：今天是 **10月27日（周一）**，但创建的工作周显示 **10月26日（周日）** 为周一，日期偏差 1 天。

#### 根本原因

- 使用 `toISOString()` 将本地时间转换为 UTC 时间
- 中国时区（UTC+8）在凌晨 0-8 点之间会产生跨天问题
- 例如：本地 2025-10-27 02:00 → UTC 2025-10-26 18:00 → 日期变成 26 日

#### 修复内容

✅ **修改文件**：

- `src/api/workLogApi.ts` - 修复 5 个日期工具函数
- `src/views/work-log/index.vue` - 修复 `getWeekDateRange()` 函数

✅ **修复方法**：

```typescript
// ❌ 之前：使用 UTC 时间
const dateString = date.toISOString().split('T')[0]

// ✅ 现在：使用本地时区
const year = date.getFullYear()
const month = String(date.getMonth() + 1).padStart(2, '0')
const day = String(date.getDate()).padStart(2, '0')
const dateString = `${year}-${month}-${day}`
```

✅ **修复效果**：

- 周一创建工作周 → 正确显示周一开始
- 凌晨 0-8 点创建 → 日期计算正确
- 跨月/跨年工作周 → 准确无误

---

### 2️⃣ 按部门选择员工功能 👥

#### 功能描述

在创建和编辑工作周时，可以通过选择部门快速添加该部门的所有员工。

#### 核心功能

**✨ 创建工作周对话框**

- 新增"按部门选择"下拉框
- 支持多部门批量选择
- 显示每个部门的人数（如"开发部 8人"）
- 员工列表按部门分组显示

**✨ 编辑工作周对话框**

- 同样的部门选择功能
- 一键清空所有已选人员
- 实时显示"已选择 X 人"

**✨ 智能交互**

- 部门选择**追加**而非覆盖已选人员
- 可以先选部门，再手动调整个别员工
- 部门下拉框显示人数标签
- 过滤搜索功能增强

#### UI 示例

```
┌─────────────────────────────────────┐
│ 创建工作周                          │
├─────────────────────────────────────┤
│ 按部门选择:                         │
│ [开发部(8人) ✓] [行政部(5人) ✓]    │
│                                     │
│ 覆盖人员:                           │
│ ┌─ 开发部 ────────────────┐        │
│ │ ☑ 张三 (开发部)         │        │
│ │ ☑ 李四 (开发部)         │        │
│ └─────────────────────────┘        │
│ ┌─ 行政部 ────────────────┐        │
│ │ ☑ 王五 (行政部)         │        │
│ │ ☑ 赵六 (行政部)         │        │
│ └─────────────────────────┘        │
│                                     │
│ 已选择 13 人 [清空]                 │
└─────────────────────────────────────┘
```

---

## 📂 修改文件清单

### 前端文件

| 文件                           | 修改内容                        | 行数 |
| ------------------------------ | ------------------------------- | ---- |
| `src/api/workLogApi.ts`        | 修复 5 个日期工具函数           | ~50  |
| `src/views/work-log/index.vue` | 修复日期计算 + 添加部门选择功能 | ~200 |

### 新增文档

| 文件                        | 说明                       |
| --------------------------- | -------------------------- |
| `WORK_WEEK_IMPROVEMENTS.md` | 工作周优化详解（本次更新） |
| `CHANGELOG_v3.2.md`         | 版本更新日志（本文档）     |

### 更新文档

| 文件        | 更新内容                                       |
| ----------- | ---------------------------------------------- |
| `README.md` | 添加 v3.2.0 更新日志 + 功能说明 + 时间处理规范 |

---

## 🔍 技术细节

### 日期格式化原则

**本地时区 vs UTC 时区**

| 场景           | 使用方式            | 示例                   |
| -------------- | ------------------- | ---------------------- |
| **任务时间戳** | UTC 时间 + 时区标识 | `2025-10-27T10:00:00Z` |
| **工作周日期** | 本地日期字符串      | `2025-10-27`           |
| **前端显示**   | 格式化为本地时间    | `2025-10-27 18:00:00`  |

**工作周日期处理规则**

```typescript
// 1. 生成日期字符串 - 使用本地时区
const formatLocalDate = (date: Date) => {
  const year = date.getFullYear() // 本地年份
  const month = String(date.getMonth() + 1).padStart(2, '0') // 本地月份（0-11需+1）
  const day = String(date.getDate()).padStart(2, '0') // 本地日期
  return `${year}-${month}-${day}`
}

// 2. 解析日期字符串 - 确保本地时区
const parseLocalDate = (dateStr: string) => {
  return new Date(dateStr + 'T00:00:00') // 添加时间部分，避免 UTC 解析
}

// 3. 验证日期范围 - 本地时区计算
const validateDates = (start: string, end: string) => {
  const startDate = new Date(start + 'T00:00:00')
  const endDate = new Date(end + 'T00:00:00')
  const diffDays = (endDate.getTime() - startDate.getTime()) / (1000 * 3600 * 24)
  return diffDays === 4 // 工作周必须是 5 天（周一到周五）
}
```

### 部门选择实现原理

**响应式数据流**

```
用户列表（userOptions）
       ↓
按部门分组（usersByDepartment）
       ↓
部门列表（departmentOptions）
       ↓
用户选择部门
       ↓
触发 handleDepartmentSelect
       ↓
提取部门员工ID → 合并到 coveredUserIds
       ↓
UI 自动更新（已选人数 + 员工列表）
```

**核心代码结构**

```typescript
// 1. 数据结构
interface UserOption {
  label: string // 显示名称（姓名 + 部门）
  value: string // 用户ID
  realName: string // 真实姓名
  department: string // 所属部门
}

// 2. 计算属性 - 按部门分组
const usersByDepartment = computed(() => {
  const grouped: Record<string, UserOption[]> = {}
  userOptions.value.forEach((user) => {
    if (!grouped[user.department]) {
      grouped[user.department] = []
    }
    grouped[user.department].push(user)
  })
  return Object.entries(grouped).map(([department, users]) => ({
    department,
    users
  }))
})

// 3. 计算属性 - 部门列表
const departmentOptions = computed(() => {
  const depts = new Set<string>()
  userOptions.value.forEach((user) => depts.add(user.department))
  return Array.from(depts).sort()
})

// 4. 事件处理 - 部门选择
const handleDepartmentSelect = (departments: string[]) => {
  const userIds = new Set(createForm.value.coveredUserIds) // 保留已选
  departments.forEach((dept) => {
    const deptUsers = userOptions.value.filter((u) => u.department === dept)
    deptUsers.forEach((u) => userIds.add(u.value)) // 追加部门员工
  })
  createForm.value.coveredUserIds = Array.from(userIds) // 去重后更新
}
```

---

## ✅ 测试验证

### 时区修复测试

#### 测试场景 1：不同时间点创建工作周

| 测试时间         | 预期周一 | 实际显示    | 结果 |
| ---------------- | -------- | ----------- | ---- |
| 凌晨 00:00-08:00 | 10月27日 | 10月27日 ✅ | 通过 |
| 上午 08:00-12:00 | 10月27日 | 10月27日 ✅ | 通过 |
| 下午 12:00-18:00 | 10月27日 | 10月27日 ✅ | 通过 |
| 晚上 18:00-24:00 | 10月27日 | 10月27日 ✅ | 通过 |

#### 测试场景 2：边界情况

| 场景           | 预期结果         | 实际结果 | 结果 |
| -------------- | ---------------- | -------- | ---- |
| 跨月工作周     | 10月28日-11月1日 | ✅ 正确  | 通过 |
| 跨年工作周     | 12月30日-1月3日  | ✅ 正确  | 通过 |
| 周日创建当前周 | 创建下周         | ✅ 正确  | 通过 |

### 部门选择功能测试

#### 基本功能

- ✅ 选择单个部门 → 该部门所有员工被添加
- ✅ 选择多个部门 → 所有部门员工被添加且不重复
- ✅ 取消部门选择 → 已添加的员工保留（不会被移除）
- ✅ 清空按钮 → 所有员工被清空

#### 组合场景

- ✅ 先选部门，再手动添加个别员工 → 正常
- ✅ 先手动选择员工，再选择部门 → 不覆盖已选，正常追加
- ✅ 部门选择 + 手动移除某些员工 → 正常
- ✅ 部门列表显示人数标签 → 正确显示

#### UI 交互

- ✅ 员工列表按部门分组 → 清晰分组
- ✅ 已选人员数量显示 → 实时更新
- ✅ 过滤搜索功能 → 正常工作
- ✅ 对话框关闭后重新打开 → 部门选择状态已清空

---

## 🎯 用户体验改进

### 修复前 vs 修复后

| 功能         | 修复前            | 修复后                |
| ------------ | ----------------- | --------------------- |
| **日期显示** | ❌ 周一显示为周日 | ✅ 周一正确显示为周一 |
| **凌晨创建** | ❌ 日期可能偏差   | ✅ 任何时间都准确     |
| **员工选择** | ❌ 需要逐个勾选   | ✅ 按部门批量选择     |
| **多部门**   | ❌ 效率低下       | ✅ 一次选择多个部门   |
| **人数统计** | ❌ 无显示         | ✅ 显示部门人数       |
| **分组查看** | ❌ 平铺列表       | ✅ 按部门分组         |

### 效率提升

**场景：创建覆盖 3 个部门（共 20 人）的工作周**

| 操作方式               | 步骤数         | 时间估计        |
| ---------------------- | -------------- | --------------- |
| **修复前**（逐个勾选） | ~20 次点击     | ~60 秒          |
| **修复后**（部门选择） | 3 次点击       | ~5 秒           |
| **效率提升**           | **节省 17 步** | **节省 92%** ⚡ |

---

## 📚 相关文档

### 技术文档

- 📄 **`WORK_WEEK_IMPROVEMENTS.md`** - 本次更新的详细技术文档
- 📄 **`ROOT_CAUSE_FIX_SUMMARY.md`** - 时区问题根源修复总结（v3.1）
- 📄 **`README.md`** - 系统完整文档（已更新）

### 快速链接

- 🔗 [工作日志系统说明](README.md#3️⃣-工作日志系统)
- 🔗 [时间处理说明](README.md#🕐-时间处理说明重要)
- 🔗 [贡献指南 - 时间处理规范](README.md#时间处理规范必读)

---

## 🐛 已知问题

### 无

本次更新未发现新的已知问题。

---

## 🔮 未来计划

### 可能的增强功能

1. 工作周模板功能（保存常用的部门/人员配置）
2. 批量编辑多个工作周的覆盖人员
3. 员工工作周视图（查看某员工参与的所有工作周）
4. 工作周复制功能（快速创建相似工作周）

---

## 💬 反馈与支持

如有问题或建议，请通过以下方式反馈：

- 📧 邮件反馈
- 💬 系统内置反馈功能
- 🐛 问题报告

---

**🎉 感谢使用星像精准研发部管理系统！**
