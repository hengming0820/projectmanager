# 用户删除逻辑说明

## 📋 设计理念

删除用户时，系统采用**智能处理**策略：

- ✅ **可以自动处理的关联** → 自动解除或删除
- 🔄 **创建的数据** → 自动转移给系统管理员

---

## 🔄 自动转移给管理员

以下数据会**自动转移**给系统管理员，确保数据完整性：

| 关联类型           | 字段                             | 处理方式     | 结果                   |
| ------------------ | -------------------------------- | ------------ | ---------------------- |
| **创建的项目**     | `Project.created_by`             | 转移给管理员 | 项目保留，创建者变更   |
| **创建的任务**     | `Task.created_by`                | 转移给管理员 | 任务保留，创建者变更   |
| **发布的文章**     | `Article.author_id`              | 转移给管理员 | 文章保留，作者变更     |
| **创建的工作周**   | `WorkWeek.created_by`            | 转移给管理员 | 工作周保留，创建者变更 |
| **拥有的协作文档** | `CollaborationDocument.owner_id` | 转移给管理员 | 文档保留，所有者变更   |

### 转移逻辑

```
删除用户 → 查找活跃的管理员
  ↓
有创建的数据
  ├─ 项目 → created_by = admin_id
  ├─ 任务 → created_by = admin_id
  ├─ 文章 → author_id = admin_id
  ├─ 工作周 → created_by = admin_id
  └─ 协作文档 → owner_id = admin_id
  ↓
数据保留，所有权转移 ✓
```

### 管理员选择规则

系统自动选择第一个符合条件的管理员：

- ✅ 角色为 `admin`
- ✅ 状态为 `active`（活跃）
- ✅ 不是被删除的用户本身

如果没有符合条件的管理员，会返回错误：

```
系统错误：没有找到可用的管理员账号来接管数据，
请先确保系统中至少有一个活跃的管理员账号
```

---

## ✅ 自动处理的情况

以下关联数据会**自动处理**，不会阻止删除：

| 关联类型 | 字段 | 处理方式 | 影响 |
| --- | --- | --- | --- |
| **进行中的任务** | `Task.assigned_to` | 设为 `NULL` | 任务变为"未分配"（仅 pending/in_progress/submitted 等） |
| **已完成的任务** | `Task.assigned_to` | 保留 | 保留历史记录（approved/skipped 状态） |
| **审核的任务** | `Task.reviewed_by` | 保留 | 保留历史审核记录 |
| **工作日志** | `WorkLogEntry.user_id` | 删除 | 删除个人工作日志 |
| **绩效统计** | `PerformanceStats.user_id` | 删除 | 删除个人绩效数据 |
| **跳过申请** | `Task.skip_requested_by` | 保留 | 保留历史申请记录 |
| **跳过审核** | `Task.skip_reviewed_by` | 保留 | 保留历史审核记录 |

### 任务状态分类

系统根据任务状态智能处理：

**进行中状态**（需要解除分配）：

- `pending` - 待分配
- `assigned` - 已分配
- `in_progress` - 进行中
- `submitted` - 已提交
- `rejected` - 已驳回
- `skip_pending` - 跳过申请中

**已完成状态**（保留历史记录）：

- `approved` - 已通过
- `skipped` - 已跳过

### 完整删除流程

```
1. 查找系统管理员
   ├─ 找到活跃管理员 → ✓ 继续
   └─ 没有管理员 → ❌ 返回错误

2. 转移创建的数据给管理员
   ├─ 创建的项目 → created_by = admin_id
   ├─ 创建的任务 → created_by = admin_id
   ├─ 发布的文章 → author_id = admin_id
   ├─ 创建的工作周 → created_by = admin_id
   └─ 协作文档 → owner_id = admin_id

3. 智能处理分配的任务
   ├─ 进行中的任务 → 设为未分配
   │   • pending, assigned, in_progress, submitted, rejected, skip_pending
   └─ 已完成的任务 → 保留（历史记录）
       • approved, skipped

4. 删除个人数据
   ├─ 工作日志 → 删除
   └─ 绩效统计 → 删除

5. 删除用户
   └─ 撤销 Token（如果 Redis 可用）

6. 完成
   └─ 返回成功
```

---

## 📊 对比：删除 vs 停用

| 功能         | 删除用户    | 停用用户      |
| ------------ | ----------- | ------------- |
| **操作难度** | 可能被阻止  | 总是成功      |
| **数据保留** | 部分删除    | 完全保留      |
| **可恢复性** | ❌ 不可恢复 | ✅ 可随时恢复 |
| **历史记录** | 部分保留    | 完全保留      |
| **审计追溯** | 受影响      | 不受影响      |
| **推荐场景** | 测试账号    | 离职员工      |

---

## 🎯 推荐方案

### 场景 1：离职员工（推荐停用）

```
用户：张三（离职）
  ├─ 创建了 5 个项目
  ├─ 分配了 20 个任务
  └─ 发布了 10 篇文章

推荐操作：停用
理由：
  ✅ 保留所有历史数据
  ✅ 可追溯历史操作
  ✅ 符合审计要求
  ✅ 可随时恢复
```

### 场景 2：测试账号（可以删除）

```
用户：test001（测试账号）
  ├─ 没有创建项目
  ├─ 分配了 3 个任务（会自动解除）
  └─ 没有发布文章

推荐操作：删除
理由：
  ✅ 测试数据可清理
  ✅ 不影响生产数据
  ✅ 释放系统资源
```

### 场景 3：数据创建者（可以删除）

```
用户：李四（技术负责人，离职）
  ├─ 创建了 10 个项目
  ├─ 创建了 100 个任务
  └─ 发布了 50 篇文章

删除操作：允许
处理方式：
  ✅ 10 个项目转移给管理员
  ✅ 100 个任务转移给管理员
  ✅ 50 篇文章转移给管理员
  ✅ 数据完整性保护

结果：
  • 所有数据保留
  • 创建者/作者变更为管理员
  • 可以追溯历史
  • 项目、任务、文章正常可用

建议：仍然优先使用「停用」功能
```

---

## 🔧 技术实现

### 后端检查逻辑

```python
# 1. 检查阻止删除的关联
blocking_issues = []

# 检查创建的项目
created_projects = db.query(Project).filter(
    Project.created_by == user_id
).count()
if created_projects > 0:
    blocking_issues.append(f"创建的项目: {created_projects} 个")

# ... 其他检查 ...

# 如果有阻止删除的关联，返回错误
if blocking_issues:
    raise HTTPException(400, detail="用户关联了以下数据，无法删除...")
```

### 自动处理逻辑

```python
# 2. 自动处理可解除的关联

# 将分配的任务设为未分配
db.query(Task).filter(Task.assigned_to == user_id).update({
    "assigned_to": None,
    "assigned_to_name": None,
    "status": "pending"
})

# 删除工作日志
db.query(WorkLogEntry).filter(
    WorkLogEntry.user_id == user_id
).delete()

# 删除绩效统计
db.query(PerformanceStats).filter(
    PerformanceStats.user_id == user_id
).delete()

# 3. 删除用户
db.delete(user)
db.commit()
```

---

## ⚠️ 注意事项

### 1. 外键约束

数据库中的外键约束设置：

```sql
-- 阻止删除的外键（NOT NULL + RESTRICT）
Task.created_by → users.id (NOT NULL)
Project.created_by → users.id (NOT NULL)
Article.author_id → users.id (NOT NULL)

-- 可以为空的外键（NULL + RESTRICT）
Task.assigned_to → users.id (NULLABLE)
Task.reviewed_by → users.id (NULLABLE)
```

### 2. 数据完整性

- ✅ 创建者信息：必须保留，确保数据溯源
- ✅ 分配信息：可以为空，不影响任务存在
- ✅ 审核记录：保留历史，便于追溯

### 3. 审计合规

对于需要审计的系统，建议：

- ✅ 优先使用"停用"而不是"删除"
- ✅ 保留所有历史操作记录
- ✅ 记录删除操作日志

---

## 📝 前端提示

### 删除确认对话框

```
确定要删除用户「张三」吗？

系统会自动处理以下关联数据：
• 分配给该用户的任务 → 设为未分配
• 用户的工作日志 → 删除
• 用户的绩效统计 → 删除
• 审核记录 → 保留（历史数据）

⚠️ 注意：
• 删除操作不可恢复
• 如果用户创建了项目/任务/文章，将无法删除
• 建议优先使用「停用」功能

[ 取消 ]  [ 确定删除 ]
```

### 删除失败提示

```
删除失败

用户关联了以下数据，无法删除：
• 创建的项目: 2 个
• 创建的任务: 15 个

建议：请先将相关数据转移给其他用户，
或将用户状态设置为「停用」

[ 知道了 ]
```

---

## 🔍 FAQ

### Q1: 为什么不能删除有分配任务的用户？

**A**: 现在可以！系统会智能处理：

- **进行中的任务**：自动设为"未分配"
- **已完成的任务**：保留作为历史记录

### Q2: 删除用户后，任务列表会受影响吗？

**A**:

- 该用户**创建**的任务：会阻止删除
- 该用户**进行中**的任务：自动变为"未分配"
- 该用户**已完成**的任务：保留历史记录（approved/skipped）
- 该用户**审核**的任务：保留审核记录

### Q2.1: 为什么已完成的任务要保留？

**A**:

- **approved** 和 **skipped** 状态的任务已经完成标注
- 这些任务是重要的历史数据，用于统计和追溯
- 删除会导致项目统计数据不准确
- 保留可以完整展示项目的完成情况

### Q3: 删除用户会影响项目吗？

**A**:

- 该用户**创建**的项目：会阻止删除
- 项目中该用户**被分配**的任务：自动解除分配

### Q4: 如何删除有创建数据的用户？

**A**: 现在可以直接删除！系统会自动将数据转移给管理员：

- ✅ 创建的项目 → 自动转移
- ✅ 创建的任务 → 自动转移
- ✅ 发布的文章 → 自动转移
- ✅ 数据完整性保护

**建议**：仍然优先使用「停用」功能

### Q4.1: 转移给哪个管理员？

**A**: 系统自动选择第一个符合条件的管理员：

- 角色为 `admin`
- 状态为 `active`（活跃）
- 不是被删除的用户本身

### Q4.2: 转移后数据会丢失吗？

**A**: 不会！数据完全保留：

- ✅ 项目、任务、文章正常可用
- ✅ 只是创建者/作者字段变更
- ✅ 可以在管理界面看到完整数据
- ✅ 历史记录完整

### Q5: 停用和删除有什么区别？

**A**:

- **停用**：用户无法登录，所有数据保留，可恢复
- **删除**：用户被移除，部分数据删除，不可恢复

---

## 📚 相关文件

- `backend/app/api/users.py` - 用户删除 API
- `backend/app/models/user.py` - 用户模型
- `backend/app/models/task.py` - 任务模型（外键关系）
- `backend/app/models/project.py` - 项目模型（外键关系）
- `src/views/system/user/index.vue` - 用户管理页面
- `src/api/userApi.ts` - 用户 API 封装

---

**最后更新**: 2025-10-16  
**维护者**: AI Assistant
