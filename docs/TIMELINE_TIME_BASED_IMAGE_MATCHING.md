# æ—¶é—´è½´æˆªå›¾æ—¶é—´èŒƒå›´åŒ¹é…

## ğŸ› é—®é¢˜æè¿°

### åœºæ™¯

1. ç”¨æˆ·ç¬¬ä¸€æ¬¡æäº¤ä»»åŠ¡ï¼Œä¸Šä¼ äº†2å¼ æˆªå›¾
2. è¢«å®¡æ ¸å‘˜é©³å›
3. ç”¨æˆ·ç¬¬äºŒæ¬¡æäº¤ä»»åŠ¡ï¼Œåˆä¸Šä¼ äº†3å¼ æˆªå›¾
4. å†æ¬¡è¢«é©³å›
5. ç”¨æˆ·ç¬¬ä¸‰æ¬¡æäº¤ä»»åŠ¡ï¼Œå†ä¸Šä¼ äº†2å¼ æˆªå›¾

### é—®é¢˜

- **ä¹‹å‰çš„é€»è¾‘**ï¼šæ¯ä¸ª"æäº¤å®¡æ ¸"èŠ‚ç‚¹éƒ½æ˜¾ç¤ºæ‰€æœ‰7å¼ æˆªå›¾ï¼ˆ2+3+2ï¼‰
- **é¢„æœŸè¡Œä¸º**ï¼šæ¯ä¸ªèŠ‚ç‚¹åªæ˜¾ç¤ºè¯¥æ¬¡æäº¤çš„æˆªå›¾
  - ç¬¬ä¸€æ¬¡æäº¤ï¼šæ˜¾ç¤º2å¼ 
  - ç¬¬äºŒæ¬¡æäº¤ï¼šæ˜¾ç¤º3å¼ 
  - ç¬¬ä¸‰æ¬¡æäº¤ï¼šæ˜¾ç¤º2å¼ 

### æ ¹æœ¬åŸå› 

ä¹‹å‰çš„é€»è¾‘åªæ ¹æ®`attachment_type`ï¼ˆå¦‚`annotation_screenshot`ï¼‰æ¥è¿‡æ»¤ï¼Œæ²¡æœ‰è€ƒè™‘æ—¶é—´å› ç´ ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**æ ¹æ®attachmentçš„ä¸Šä¼ æ—¶é—´ï¼ˆ`created_at`ï¼‰ä¸timelineäº‹ä»¶çš„æ—¶é—´ï¼ˆ`time`ï¼‰è¿›è¡ŒåŒ¹é…**

### ç®—æ³•æµç¨‹

```typescript
function getEventImages(event) {
  // 1. ç¡®å®šç›®æ ‡ç±»å‹ï¼ˆannotation_screenshotã€review_screenshotç­‰ï¼‰
  const targetType = getTargetType(event.type)

  // 2. æ‰¾åˆ°å½“å‰äº‹ä»¶åœ¨timelineä¸­çš„ä½ç½®
  const currentIndex = findEventIndex(event)

  // 3. æ‰¾åˆ°ä¸‹ä¸€ä¸ªåŒç±»å‹äº‹ä»¶çš„æ—¶é—´ä½œä¸ºä¸Šé™
  const nextEventTime = findNextSameTypeEvent(currentIndex)

  // 4. è¿‡æ»¤attachmentsï¼šç±»å‹åŒ¹é… ä¸” æ—¶é—´åœ¨èŒƒå›´å†…
  const images = attachments.filter((att) => {
    return (
      att.type === targetType &&
      att.created_at >= currentEventTime &&
      att.created_at < nextEventTime
    )
  })

  return images
}
```

### æ—¶é—´èŒƒå›´ç¡®å®š

#### æƒ…å†µ1ï¼šæœ‰ä¸‹ä¸€ä¸ªåŒç±»å‹äº‹ä»¶

```
ç¬¬ä¸€æ¬¡æäº¤ (10:00)
    â†“
    [æˆªå›¾A, B]  (10:00-10:05ä¸Šä¼ )
    â†“
ç¬¬äºŒæ¬¡æäº¤ (10:30)  â† ä½œä¸ºä¸Šé™
    â†“
    [æˆªå›¾C, D, E]  (10:30-10:35ä¸Šä¼ )
```

**ç¬¬ä¸€æ¬¡æäº¤æ˜¾ç¤ºçš„æˆªå›¾ï¼š**

- æ—¶é—´èŒƒå›´ï¼š`[10:00, 10:30)`
- ç»“æœï¼šæˆªå›¾A, B

**ç¬¬äºŒæ¬¡æäº¤æ˜¾ç¤ºçš„æˆªå›¾ï¼š**

- æ—¶é—´èŒƒå›´ï¼š`[10:30, âˆ)`
- ç»“æœï¼šæˆªå›¾C, D, E

#### æƒ…å†µ2ï¼šæ²¡æœ‰ä¸‹ä¸€ä¸ªåŒç±»å‹äº‹ä»¶

ä½¿ç”¨ä¸‹ä¸€ä¸ªä»»æ„äº‹ä»¶çš„æ—¶é—´ä½œä¸ºä¸Šé™

```
ç¬¬ä¸€æ¬¡æäº¤ (10:00)
    â†“
    [æˆªå›¾A, B]  (10:00-10:05ä¸Šä¼ )
    â†“
å®¡æ ¸ç»“æœ (10:35)  â† ä½œä¸ºä¸Šé™
    â†“
    [å®¡æ ¸æˆªå›¾X]  (10:35ä¸Šä¼ )
```

**ç¬¬ä¸€æ¬¡æäº¤æ˜¾ç¤ºçš„æˆªå›¾ï¼š**

- æ—¶é—´èŒƒå›´ï¼š`[10:00, 10:35)`
- ç»“æœï¼šæˆªå›¾A, Bï¼ˆä¸åŒ…æ‹¬å®¡æ ¸æˆªå›¾Xï¼‰

#### æƒ…å†µ3ï¼šæ˜¯æœ€åä¸€ä¸ªäº‹ä»¶

æ²¡æœ‰ä¸Šé™ï¼Œæ˜¾ç¤ºè¯¥æ—¶é—´ä¹‹åçš„æ‰€æœ‰åŒç±»å‹æˆªå›¾

### å®¹é”™æœºåˆ¶

#### 10ç§’å®¹é”™æ—¶é—´

```typescript
const tolerance = 10 * 1000 // 10ç§’
const isInRange = attTime >= currentEventTime - tolerance && attTime < nextEventTime
```

**åŸå› ï¼š**

- ä¸Šä¼ æˆªå›¾éœ€è¦æ—¶é—´
- ç½‘ç»œå»¶è¿Ÿ
- æ—¶åŒºè½¬æ¢è¯¯å·®
- æ•°æ®åº“æ—¶é—´æˆ³ç²¾åº¦

**ç¤ºä¾‹ï¼š**

```
äº‹ä»¶æ—¶é—´ï¼š10:00:00
æˆªå›¾ä¸Šä¼ ï¼š09:59:55  â† æ¯”äº‹ä»¶æ—©5ç§’ï¼Œä»ç„¶ç®—ä½œè¯¥äº‹ä»¶çš„æˆªå›¾
```

#### å…¼å®¹æ—§æ•°æ®

```typescript
if (!att.created_at) {
  console.log('âš ï¸ Attachmentç¼ºå°‘created_atï¼ŒæŒ‰ç±»å‹åŒ¹é…')
  return true // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œå°±æŒ‰ç±»å‹åŒ¹é…ï¼ˆæ—§é€»è¾‘ï¼‰
}
```

---

## ğŸ“Š è¯¦ç»†å®ç°

### 1. æ‰¾åˆ°å½“å‰äº‹ä»¶åœ¨timelineä¸­çš„ä½ç½®

```typescript
const currentEventIndex = timeline.findIndex(
  (e) => e.time === event.time && e.type === event.type && e.user_id === event.user_id
)
```

**åŒ¹é…æ¡ä»¶ï¼š**

- æ—¶é—´ç›¸åŒ
- ç±»å‹ç›¸åŒ
- ç”¨æˆ·IDç›¸åŒï¼ˆé˜²æ­¢è¯¯åŒ¹é…ï¼‰

### 2. æ‰¾ä¸‹ä¸€ä¸ªåŒç±»å‹äº‹ä»¶

```typescript
let nextEventTime: number | null = null
for (let i = currentEventIndex + 1; i < timeline.length; i++) {
  if (timeline[i].type === event.type) {
    nextEventTime = new Date(timeline[i].time).getTime()
    break
  }
}
```

### 3. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ä¸‹ä¸€ä¸ªä»»æ„äº‹ä»¶

```typescript
if (nextEventTime === null && currentEventIndex < timeline.length - 1) {
  nextEventTime = new Date(timeline[currentEventIndex + 1].time).getTime()
}
```

### 4. è¿‡æ»¤attachments

```typescript
const images = attachments.filter((att: any) => {
  // ç±»å‹åŒ¹é…
  if (!att || att.attachment_type !== targetType) {
    return false
  }

  // å…¼å®¹æ—§æ•°æ®
  if (!att.created_at) {
    return true
  }

  const attTime = new Date(att.created_at).getTime()
  const tolerance = 10 * 1000

  // æ—¶é—´èŒƒå›´åŒ¹é…
  const isInRange =
    attTime >= currentEventTime - tolerance && (nextEventTime === null || attTime < nextEventTime)

  return isInRange
})
```

---

## ğŸ” è°ƒè¯•æ—¥å¿—

### å®Œæ•´çš„æ—¥å¿—è¾“å‡º

```
ğŸ“¦ [Timeline] äº‹ä»¶attachmentsæ€»æ•°: 7 äº‹ä»¶ç±»å‹: submitted
ğŸ¯ [Timeline] æŸ¥æ‰¾æˆªå›¾ç±»å‹: annotation_screenshot

â° [Timeline] æ‰¾åˆ°ä¸‹ä¸€ä¸ªåŒç±»å‹äº‹ä»¶:
  nextType: submitted
  nextTime: 2025-10-31T10:30:00Z
  gap: 30.00åˆ†é’Ÿ

ğŸ“… [Timeline] æ—¶é—´èŒƒå›´:
  äº‹ä»¶æ—¶é—´: 2025-10-31T10:00:00Z
  å½“å‰äº‹ä»¶ç´¢å¼•: 2
  æ—¶é—´ä¸‹é™: 2025-10-31T10:00:00Z
  æ—¶é—´ä¸Šé™: 2025-10-31T10:30:00Z

ğŸ” [Timeline] æ£€æŸ¥attachment:
  id: att-001
  type: annotation_screenshot
  created_at: 2025-10-31T10:02:15Z
  url: /api/files/screenshot1.jpg...
  æ—¶é—´åŒ¹é…: true
  ä¸Šä¼ æ—¶é—´ä¸äº‹ä»¶æ—¶é—´å·®: 135.00ç§’

ğŸ” [Timeline] æ£€æŸ¥attachment:
  id: att-002
  type: annotation_screenshot
  created_at: 2025-10-31T10:31:20Z
  url: /api/files/screenshot2.jpg...
  æ—¶é—´åŒ¹é…: false  â† è¶…å‡ºæ—¶é—´èŒƒå›´
  ä¸Šä¼ æ—¶é—´ä¸äº‹ä»¶æ—¶é—´å·®: 1880.00ç§’

âœ… [Timeline] æ‰¾åˆ°æ—¶é—´èŒƒå›´å†…çš„æˆªå›¾: 2 è¿‡æ»¤å‰: 7
```

### å…³é”®ä¿¡æ¯

1. **æ—¶é—´èŒƒå›´**

   - ä¸‹é™ï¼šäº‹ä»¶æ—¶é—´ - 10ç§’
   - ä¸Šé™ï¼šä¸‹ä¸€ä¸ªåŒç±»å‹äº‹ä»¶æ—¶é—´

2. **åŒ¹é…ç»“æœ**

   - æ˜¾ç¤ºæ¯ä¸ªattachmentçš„æ—¶é—´åŒ¹é…æƒ…å†µ
   - è®¡ç®—ä¸äº‹ä»¶æ—¶é—´çš„å·®å€¼

3. **è¿‡æ»¤ç»Ÿè®¡**
   - åŸå§‹æ•°é‡ï¼š7å¼ 
   - æ—¶é—´èŒƒå›´å†…ï¼š2å¼ 

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šå¤šæ¬¡æäº¤

**Timeline:**

```
1. åˆ›å»ºä»»åŠ¡ (09:00)
2. é¢†å–ä»»åŠ¡ (09:10)
3. ç¬¬ä¸€æ¬¡æäº¤ (10:00) â† ä¸Šä¼ 2å¼ 
4. å®¡æ ¸é©³å› (10:20)
5. ç¬¬äºŒæ¬¡æäº¤ (11:00) â† ä¸Šä¼ 3å¼ 
6. å®¡æ ¸é©³å› (11:20)
7. ç¬¬ä¸‰æ¬¡æäº¤ (12:00) â† ä¸Šä¼ 2å¼ 
8. å®¡æ ¸é€šè¿‡ (12:10)
```

**Attachments:**

```
att-1: annotation_screenshot, 10:02  â† ç¬¬ä¸€æ¬¡æäº¤
att-2: annotation_screenshot, 10:05  â† ç¬¬ä¸€æ¬¡æäº¤
att-3: review_screenshot, 10:20      â† ç¬¬ä¸€æ¬¡å®¡æ ¸
att-4: annotation_screenshot, 11:01  â† ç¬¬äºŒæ¬¡æäº¤
att-5: annotation_screenshot, 11:03  â† ç¬¬äºŒæ¬¡æäº¤
att-6: annotation_screenshot, 11:05  â† ç¬¬äºŒæ¬¡æäº¤
att-7: review_screenshot, 11:20      â† ç¬¬äºŒæ¬¡å®¡æ ¸
att-8: annotation_screenshot, 12:01  â† ç¬¬ä¸‰æ¬¡æäº¤
att-9: annotation_screenshot, 12:02  â† ç¬¬ä¸‰æ¬¡æäº¤
```

**é¢„æœŸç»“æœ:**

| äº‹ä»¶               | æ˜¾ç¤ºçš„æˆªå›¾          | æ•°é‡ |
| ------------------ | ------------------- | ---- |
| ç¬¬ä¸€æ¬¡æäº¤ (10:00) | att-1, att-2        | 2å¼   |
| ç¬¬ä¸€æ¬¡å®¡æ ¸ (10:20) | att-3               | 1å¼   |
| ç¬¬äºŒæ¬¡æäº¤ (11:00) | att-4, att-5, att-6 | 3å¼   |
| ç¬¬äºŒæ¬¡å®¡æ ¸ (11:20) | att-7               | 1å¼   |
| ç¬¬ä¸‰æ¬¡æäº¤ (12:00) | att-8, att-9        | 2å¼   |

âœ… **æ¯ä¸ªèŠ‚ç‚¹åªæ˜¾ç¤ºè¯¥é˜¶æ®µçš„æˆªå›¾ï¼Œä¸ä¼šæ··æ·†**

### åœºæ™¯2ï¼šè·³è¿‡ç”³è¯·

**Timeline:**

```
1. åˆ›å»ºä»»åŠ¡ (09:00)
2. é¢†å–ä»»åŠ¡ (09:10)
3. ç”³è¯·è·³è¿‡ (10:00) â† ä¸Šä¼ 3å¼ è¯´æ˜æˆªå›¾
4. è·³è¿‡æ‹’ç» (10:30) â† å®¡æ ¸å‘˜ä¸Šä¼ 2å¼ è¯´æ˜æˆªå›¾
5. å¼€å§‹æ ‡æ³¨ (11:00)
6. æäº¤å®¡æ ¸ (12:00) â† ä¸Šä¼ 4å¼ æ ‡æ³¨æˆªå›¾
```

**Attachments:**

```
att-1: skip_screenshot, 10:01        â† è·³è¿‡ç”³è¯·
att-2: skip_screenshot, 10:02        â† è·³è¿‡ç”³è¯·
att-3: skip_screenshot, 10:03        â† è·³è¿‡ç”³è¯·
att-4: review_screenshot, 10:30      â† è·³è¿‡å®¡æ ¸
att-5: review_screenshot, 10:31      â† è·³è¿‡å®¡æ ¸
att-6: annotation_screenshot, 12:01  â† æ ‡æ³¨æäº¤
att-7: annotation_screenshot, 12:02  â† æ ‡æ³¨æäº¤
att-8: annotation_screenshot, 12:03  â† æ ‡æ³¨æäº¤
att-9: annotation_screenshot, 12:04  â† æ ‡æ³¨æäº¤
```

**é¢„æœŸç»“æœ:**

| äº‹ä»¶             | æ˜¾ç¤ºçš„æˆªå›¾                 | æ•°é‡ |
| ---------------- | -------------------------- | ---- |
| ç”³è¯·è·³è¿‡ (10:00) | att-1, att-2, att-3        | 3å¼   |
| è·³è¿‡æ‹’ç» (10:30) | att-4, att-5               | 2å¼   |
| æäº¤å®¡æ ¸ (12:00) | att-6, att-7, att-8, att-9 | 4å¼   |

âœ… **ä¸åŒç±»å‹çš„äº‹ä»¶ä¸ä¼šæ··æ·†**

---

## âš™ï¸ é…ç½®å‚æ•°

### å®¹é”™æ—¶é—´

```typescript
const tolerance = 10 * 1000 // 10ç§’
```

**å¯è°ƒæ•´ï¼š**

- ç½‘ç»œå»¶è¿Ÿå¤§ï¼šå¢åŠ åˆ° `20 * 1000`ï¼ˆ20ç§’ï¼‰
- æ—¶é—´è¦æ±‚ä¸¥æ ¼ï¼šå‡å°‘åˆ° `5 * 1000`ï¼ˆ5ç§’ï¼‰
- æœ¬åœ°å¼€å‘ï¼šå¯ä»¥è®¾ä¸º `0`

### æ—¥å¿—çº§åˆ«

**å½“å‰ï¼šè¯¦ç»†æ—¥å¿—**

```typescript
console.log('ğŸ“¦ [Timeline] ...') // ä¿¡æ¯
console.warn('âš ï¸ [Timeline] ...') // è­¦å‘Š
```

**ç”Ÿäº§ç¯å¢ƒï¼šå¯ä»¥ç®€åŒ–**

```typescript
if (import.meta.env.DEV) {
  console.log('ğŸ“¦ [Timeline] ...')
}
```

---

## ğŸ¯ ä¼˜åŠ¿

### 1. **å‡†ç¡®æ€§** â­

- æ¯ä¸ªäº‹ä»¶åªæ˜¾ç¤ºè¯¥é˜¶æ®µçš„æˆªå›¾
- ä¸ä¼šå‡ºç°æ··æ·†

### 2. **å…¼å®¹æ€§** â­

- æ–°æ•°æ®ï¼šä½¿ç”¨æ—¶é—´èŒƒå›´åŒ¹é…
- æ—§æ•°æ®ï¼šå›é€€åˆ°ç±»å‹åŒ¹é…ï¼ˆæ²¡æœ‰`created_at`å­—æ®µï¼‰

### 3. **å¥å£®æ€§** â­

- 10ç§’å®¹é”™æ—¶é—´
- å¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆæœ€åä¸€ä¸ªäº‹ä»¶ç­‰ï¼‰
- è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### 4. **æ€§èƒ½** â­

- åªè¿‡æ»¤ä¸€æ¬¡attachments
- ä½¿ç”¨Mapå»é‡ï¼ˆO(n)å¤æ‚åº¦ï¼‰

---

## ğŸ”§ è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. Attachmentæ²¡æœ‰created_at

```typescript
if (!att.created_at) {
  console.log('âš ï¸ Attachmentç¼ºå°‘created_atï¼ŒæŒ‰ç±»å‹åŒ¹é…')
  return true // å›é€€åˆ°æ—§é€»è¾‘
}
```

### 2. æ‰¾ä¸åˆ°å½“å‰äº‹ä»¶

```typescript
if (currentEventIndex === -1) {
  console.warn('âš ï¸ åœ¨timelineä¸­æ‰¾ä¸åˆ°å½“å‰äº‹ä»¶')
  return [] // æˆ–è€…ä½¿ç”¨ç±»å‹åŒ¹é…
}
```

### 3. æ˜¯æœ€åä¸€ä¸ªäº‹ä»¶

```typescript
if (nextEventTime === null) {
  // æ²¡æœ‰ä¸Šé™ï¼Œæ˜¾ç¤ºè¯¥æ—¶é—´ä¹‹åçš„æ‰€æœ‰æˆªå›¾
}
```

### 4. ä¸Šä¼ æ—¶é—´å¼‚å¸¸

```typescript
if (attTime < currentEventTime - tolerance * 2) {
  console.warn('âš ï¸ ä¸Šä¼ æ—¶é—´å¼‚å¸¸æ—©äºäº‹ä»¶æ—¶é—´', {
    diff: (currentEventTime - attTime) / 1000 + 'ç§’'
  })
}
```

---

## ğŸ“ ä¿®æ”¹çš„ä»£ç 

### æ–‡ä»¶ï¼š`src/components/custom/SimpleTimeline.vue`

#### ä¿®æ”¹çš„å‡½æ•°

- `getEventImages(event)` - æ·»åŠ æ—¶é—´èŒƒå›´åŒ¹é…é€»è¾‘

#### æ–°å¢é€»è¾‘

1. æ‰¾åˆ°å½“å‰äº‹ä»¶åœ¨timelineä¸­çš„ä½ç½®
2. ç¡®å®šæ—¶é—´èŒƒå›´ï¼ˆä¸‹ä¸€ä¸ªåŒç±»å‹äº‹ä»¶ï¼‰
3. è¿‡æ»¤attachmentï¼šç±»å‹ + æ—¶é—´èŒƒå›´
4. è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

---

## âœ… ä¿®å¤å®Œæˆ

### è§£å†³çš„é—®é¢˜

1. âœ… å¤šæ¬¡æäº¤æ—¶æˆªå›¾æ··æ·†
2. âœ… å¤šæ¬¡å®¡æ ¸æ—¶æˆªå›¾æ··æ·†
3. âœ… è·³è¿‡ç”³è¯·å’Œæ ‡æ³¨æˆªå›¾æ··æ·†

### æ–°å¢ç‰¹æ€§

1. âœ… åŸºäºæ—¶é—´èŒƒå›´çš„ç²¾ç¡®åŒ¹é…
2. âœ… 10ç§’å®¹é”™æœºåˆ¶
3. âœ… è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
4. âœ… å…¼å®¹æ—§æ•°æ®

---

**ä¿®å¤æ—¶é—´ï¼š** 2025-10-31

**ğŸ‰ ç°åœ¨æ¯ä¸ªäº‹ä»¶åªä¼šæ˜¾ç¤ºè¯¥é˜¶æ®µçš„æˆªå›¾ï¼Œä¸ä¼šå†æ··æ·†äº†ï¼**
