# ✅ 协作功能启动完整指南

## 🔍 问题根源

**堆栈溢出的真正原因**：

- ❌ **没有启动 Yjs 服务器**
- ❌ **Vite 没有正确代理 WebSocket 连接**
- ❌ `YWebsocketConnector` 连接失败，导致内部错误和堆栈溢出

## ✅ 已完成的修复

### 1. 启动了 Yjs 服务器

```bash
cd yjs-collab-server
npm install  # ✅ 已完成
npm start    # ✅ 后台运行中
```

**服务器信息**：

- 端口: `1234`
- WebSocket 路径: `/api/collaboration/yjs`
- 完整地址: `ws://localhost:1234/api/collaboration/yjs`

### 2. 配置了 Vite WebSocket 代理

**文件**: `vite.config.ts`

**添加的配置**：

```typescript
'/api/collaboration/yjs': {
  target: 'ws://localhost:1234',
  ws: true, // 启用 WebSocket 代理
  changeOrigin: true,
  // 保持原路径（服务器也监听 /api/collaboration/yjs）
  configure: (proxy) => {
    // 详细的日志输出
  }
}
```

**代理流程**：

```
前端: ws://localhost:3006/api/collaboration/yjs/doc-xxx
  ↓ (Vite 代理)
Yjs服务器: ws://localhost:1234/api/collaboration/yjs/doc-xxx
```

### 3. 优化了编辑器初始化

**文件**: `src/components/core/forms/art-textbus-editor/index.vue`

**关键优化**：

1. ✅ 不设置默认空内容，让 XNote 自己处理
2. ✅ 添加错误处理，协作失败不影响编辑器
3. ✅ 暂时禁用 XNoteMessageBus（避免潜在问题）
4. ✅ 详细的日志输出

## 🚀 现在需要做什么

### 步骤 1: 重启 Vite 开发服务器

**原因**: Vite 配置文件已修改，必须重启才能生效！

```bash
# 按 Ctrl+C 停止当前的 Vite 服务器
# 然后重新启动
npm run dev
```

### 步骤 2: 刷新页面

1. 打开"创建协作文档"页面
2. **强制刷新**: `Ctrl+Shift+R`

### 步骤 3: 检查控制台日志

**应该看到的日志**：

```
📝 [XNote] 创建空白编辑器
🤝 [XNote] 启用协作模式，文档ID: doc-xxx
🔌 [XNote] 创建协作连接器
   └─ URL: ws://localhost:3006/api/collaboration/yjs
   └─ 文档ID: doc-xxx
   └─ 用户: admin
✅ [XNote] 协作配置已添加到编辑器
✅ [XNote] 编辑器初始化成功
🤝 [XNote] 协作模式：内容同步由 Yjs 管理
```

**Vite 服务器日志**（终端）：

```
🔌 [Yjs WS] 代理 WebSocket 连接: /api/collaboration/yjs
✅ [Yjs WS] WebSocket 连接已建立
```

**Yjs 服务器日志**（如果单独运行）：

```
🔌 [2025-01-01T12:00:00.000Z] New connection for document: doc-xxx
   Total connections: 1
```

## 📊 预期效果

### ✅ 成功标志

1. 编辑器正常加载
2. 可以输入文字
3. **没有堆栈溢出错误**
4. 控制台显示协作连接成功
5. 左侧显示"正在编辑 [1]"

### ❌ 如果仍然失败

#### 检查 Yjs 服务器是否运行

```powershell
# 检查端口 1234 是否被监听
netstat -ano | findstr :1234
```

**应该显示**：

```
TCP    0.0.0.0:1234    0.0.0.0:0    LISTENING    xxxxx
```

**如果没有输出**，手动启动服务器：

```bash
cd yjs-collab-server
npm start
```

#### 检查 Vite 配置是否生效

在浏览器控制台输入：

```javascript
new WebSocket('ws://localhost:3006/api/collaboration/yjs')
```

- ✅ 如果连接成功：Vite 代理正常
- ❌ 如果连接失败：Vite 可能没有重启

## 🧪 测试多人协作

一旦单人模式工作正常，测试多人协作：

### 方式 1: 使用多个浏览器

1. Chrome: 登录为 admin
2. Firefox: 登录为其他用户
3. 都打开"创建协作文档"页面

### 方式 2: 使用隐身窗口

1. 普通窗口: 登录用户 A
2. 隐身窗口: 登录用户 B
3. 同时编辑，观察实时同步

### 预期结果

- ✅ 一个用户输入，另一个用户立即看到
- ✅ 能看到对方的光标位置
- ✅ 左侧用户列表显示所有在线用户

## 🐛 已知限制

### 暂时禁用的功能

1. ⚠️ **协作用户列表** - 因为 `XNoteMessageBus` 可能导致问题
   - 当前只显示当前用户
   - TODO: 等待 TextBus 修复后启用

### 解决方案

**方案 A**: 等待 TextBus 官方修复

- GitHub: https://github.com/textbus/textbus
- 提交 issue 报告堆栈溢出问题

**方案 B**: 使用 Yjs Awareness API 手动实现

```typescript
const awareness = yDoc.getAwareness()
awareness.on('change', () => {
  const states = Array.from(awareness.getStates().values())
  // 更新用户列表
})
```

## 📝 架构说明

```
┌─────────────────────────────────────────────────────────┐
│  浏览器 (localhost:3006)                                 │
│  ┌───────────────────────────────────────────────────┐  │
│  │ XNote 编辑器组件                                   │  │
│  │ └─ YWebsocketConnector                            │  │
│  │    └─ ws://localhost:3006/api/collaboration/yjs  │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ WebSocket (通过 Vite 代理)
                          ↓
┌─────────────────────────────────────────────────────────┐
│  Vite Dev Server (localhost:3006)                       │
│  配置: vite.config.ts                                    │
│  代理: /api/collaboration/yjs -> ws://localhost:1234    │
└─────────────────────────────────────────────────────────┘
                          │
                          ↓
┌─────────────────────────────────────────────────────────┐
│  Yjs WebSocket Server (localhost:1234)                  │
│  文件: yjs-collab-server/server.js                      │
│  功能: 管理文档的 CRDT 同步                              │
└─────────────────────────────────────────────────────────┘
```

## 🎯 总结

**必须执行的步骤**：

1. ✅ 确保 Yjs 服务器运行（`cd yjs-collab-server && npm start`）
2. 🔄 **重启 Vite 开发服务器**（让配置生效）
3. 🔄 刷新浏览器页面
4. 🧪 测试编辑功能

**现在请执行步骤 2，重启 Vite 服务器，然后告诉我结果！** 🚀
