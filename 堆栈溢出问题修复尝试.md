# 🔧 堆栈溢出问题修复尝试

## ❌ 问题描述

用户在刷新页面后遇到严重错误：

```
Uncaught RangeError: Maximum call stack size exceeded
    at _ViewflyAdapter.getLocationByNativeNode (index.esm.js:3718:5)
    at SelectionBridge2.findFocusNode (index.esm.js:1026:42)
    ... (无限递归)
```

这是一个**堆栈溢出错误**，发生在 TextBus 的 SelectionBridge 中的 `findFocusNode` 方法，表明有无限递归发生。

## 🔍 可能原因

1. **DOM 结构循环引用**：编辑器的 DOM 结构中可能存在循环引用
2. **初始内容格式问题**：传入的 HTML 内容格式不正确
3. **协作功能冲突**：Yjs 协作功能可能与编辑器的某些内部机制冲突
4. **容器配置问题**：编辑器容器的配置可能不正确

## 🛠️ 修复尝试

### 尝试 1: 暂时禁用协作功能

**理由**：协作功能是最近添加的，可能是导致问题的根源。

**修改**：

```vue
<!-- src/views/collaboration/create/index.vue -->
<ArtTextbusEditor
  :collaboration-enabled="false"  <!-- 从 true 改为 false -->
  ...
/>
```

### 尝试 2: 简化初始内容配置

**理由**：初始内容的格式可能导致 SelectionBridge 进入无限循环。

**修改前**：

```typescript
const editorConfig: any = {
  content: props.modelValue || `<p>${props.placeholder}</p>`,
  ...
}
```

**修改后**：

```typescript
const editorConfig: any = {
  readonly: props.readonly,
  placeholder: props.placeholder,
  providers: [...]
}

// 只有在有内容时才设置 content
if (props.modelValue && props.modelValue.trim()) {
  editorConfig.content = props.modelValue
  console.log('📝 [XNote] 加载已有内容，长度:', props.modelValue.length)
} else {
  console.log('📝 [XNote] 创建空白编辑器')
}
```

**关键变化**：

1. ✅ 不再提供默认的 `<p>` 标签内容
2. ✅ 让 XNote 自己处理空白编辑器的初始化
3. ✅ 只在有实际内容时才传入 content
4. ✅ 添加 placeholder 选项
5. ✅ 添加日志以便调试

## 📋 测试步骤

### 步骤 1: 清除浏览器缓存

1. 按 `Ctrl+Shift+R` 强制刷新
2. 或打开开发者工具，右键刷新按钮 → "清空缓存并硬性重新加载"

### 步骤 2: 测试空白编辑器

1. 打开"创建协作文档"页面
2. 检查控制台日志：
   ```
   📝 [XNote] 创建空白编辑器
   ✅ [XNote] 编辑器初始化成功
   ```
3. 尝试点击编辑器，看是否能输入

### 步骤 3: 观察是否还有堆栈溢出

- ✅ **成功**：编辑器正常加载，可以输入
- ❌ **失败**：仍然出现 "Maximum call stack size exceeded" 错误

## 🔄 下一步调试方案

### 如果仍然出错（Plan B）

#### 方案 1: 检查编辑器容器

```typescript
// 在 initEditor 之前添加
console.log('📦 [XNote] 容器信息:', {
  exists: !!editorRef.value,
  tagName: editorRef.value?.tagName,
  classList: editorRef.value?.classList,
  innerHTML: editorRef.value?.innerHTML.length
})
```

#### 方案 2: 延迟初始化

```typescript
onMounted(() => {
  // 延迟初始化，确保 DOM 完全渲染
  setTimeout(() => {
    initEditor()
  }, 100)
})
```

#### 方案 3: 更换编辑器实例

如果 TextBus XNote 持续出现问题，考虑：

- 回退到 WangEditor（已在其他页面成功使用）
- 或使用 TipTap、Quill 等其他编辑器

### 如果问题解决（Plan C: 重新启用协作）

一旦基础编辑器工作正常，再逐步添加功能：

1. **步骤 1**：确认编辑器可以输入和保存
2. **步骤 2**：启动 Yjs 服务器
   ```bash
   cd yjs-collab-server
   npm start
   ```
3. **步骤 3**：重新启用协作
   ```vue
   :collaboration-enabled="true"
   ```
4. **步骤 4**：测试多人协作

## 📊 当前状态

- [x] 已禁用协作功能
- [x] 已简化初始内容配置
- [ ] 等待用户测试反馈

## 🎯 期望结果

1. **最小目标**：编辑器能正常加载和输入（即使没有协作）
2. **理想目标**：编辑器正常 + 协作功能正常

## 📝 相关文件

1. `src/components/core/forms/art-textbus-editor/index.vue` - 编辑器组件（已修改）
2. `src/views/collaboration/create/index.vue` - 创建文档页面（已禁用协作）
3. `协作功能测试指南.md` - 协作功能测试步骤（协作正常后使用）

---

**请刷新页面并告诉我结果：**

- ✅ 编辑器可以正常使用了
- ❌ 仍然有堆栈溢出错误（请提供完整的错误日志）
- ⚠️ 其他错误（请提供错误信息）
